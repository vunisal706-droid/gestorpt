<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a5f4a">
    <title>Gestor PE v3</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='110' fill='%231a5f4a'/%3E%3Crect x='100' y='70' width='220' height='300' rx='20' fill='white'/%3E%3Ccircle cx='160' cy='140' r='16' fill='%2322c55e'/%3E%3Ccircle cx='370' cy='350' r='100' fill='%23f59e0b'/%3E%3Ccircle cx='370' cy='350' r='80' fill='white'/%3E%3Cpath d='M370 290v60h50' stroke='%231a5f4a' stroke-width='12' stroke-linecap='round' fill='none'/%3E%3C/svg%3E">
    <style>
        :root{--primary:#1a5f4a;--primary-light:#2d8a6e;--primary-dark:#134536;--bg:#f5f7f6;--bg-card:#fff;--text:#1a2a24;--text-light:#5a6b64;--border:#d4ddd9;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--proceso:#3b82f6;--shadow:0 4px 20px rgba(26,95,74,0.1);--radius:16px;--radius-sm:10px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:12px 16px;position:sticky;top:0;z-index:100}
        .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .header h1{font-size:1.1rem;cursor:pointer}
        .status{display:flex;align-items:center;gap:5px;font-size:.7rem;background:rgba(255,255,255,.2);padding:4px 10px;border-radius:20px}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--warning)}
        .status-dot.ok{background:var(--success)}
        .container{max-width:1200px;margin:0 auto;padding:14px}
        .screen{display:none}.screen.active{display:block}
        .card{background:var(--bg-card);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
        .card-title{font-size:1rem;font-weight:700;color:var(--primary)}
        .btn{padding:10px 14px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-secondary{background:var(--bg);color:var(--text);border:2px solid var(--border)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-ai{background:#10a37f;color:#fff}
        .btn-sm{padding:7px 10px;font-size:.75rem}
        .btn-group{display:flex;gap:6px;flex-wrap:wrap}
        .nav-tabs{display:flex;gap:8px;margin-bottom:16px}
        .nav-tab{padding:12px 20px;border:none;background:var(--bg-card);color:var(--text-light);font-family:inherit;font-size:.9rem;font-weight:600;cursor:pointer;border-radius:var(--radius);box-shadow:var(--shadow)}
        .nav-tab.active{background:var(--primary);color:#fff}
        .alumnos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:12px}
        .alumno-card{background:var(--bg-card);border-radius:var(--radius);padding:16px 10px;text-align:center;cursor:pointer;border:2px solid transparent;box-shadow:var(--shadow)}
        .alumno-card:hover{border-color:var(--primary-light)}
        .alumno-siglas{font-family:monospace;font-size:1.3rem;font-weight:700;color:var(--primary)}
        .alumno-curso{font-size:.75rem;color:var(--text-light)}
        .alumno-progs{font-size:.65rem;color:var(--primary);margin-top:4px}
        .alumno-card-add{background:transparent;border:2px dashed var(--primary-light);color:var(--primary);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85px}
        .tabs{display:flex;gap:4px;background:var(--bg-card);padding:4px;border-radius:var(--radius);margin-bottom:14px;overflow-x:auto}
        .tab{flex:1;padding:9px 8px;border:none;background:transparent;color:var(--text-light);font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer;border-radius:var(--radius-sm);white-space:nowrap}
        .tab.active{background:var(--primary);color:#fff}
        .tab-content{display:none}.tab-content.active{display:block}
        .form-group{margin-bottom:12px}
        .form-label{display:block;font-weight:600;margin-bottom:4px;font-size:.8rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:16px}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:14px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:var(--radius);width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
        .modal-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:.95rem;font-weight:700}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light)}
        .modal-body{padding:16px}
        .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:6px}
        .dias-btns{display:flex;gap:6px;margin-top:5px}
        .dia-btn{width:42px;height:42px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;font-weight:600;cursor:pointer}
        .dia-btn.active{border-color:var(--primary);background:rgba(26,95,74,.15);color:var(--primary)}
        .programa-card{background:var(--bg);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px;border-left:4px solid var(--primary)}
        .programa-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .programa-titulo{font-weight:600;font-size:.9rem}
        .objetivo-card{background:#fff;border-radius:8px;padding:10px;margin-bottom:8px}
        .objetivo-header{display:flex;gap:5px;margin-bottom:5px;align-items:center}
        .objetivo-num{font-family:monospace;font-size:.7rem;font-weight:600;padding:2px 5px;border-radius:4px;background:rgba(26,95,74,.15);color:var(--primary)}
        .trimestre-badge{font-size:.65rem;padding:2px 5px;border-radius:4px;font-weight:600}
        .t1{background:#8b5cf620;color:#8b5cf6}.t2{background:#06b6d420;color:#06b6d4}.t3{background:#f59e0b20;color:#f59e0b}
        .objetivo-desc{font-size:.8rem}
        .indicadores-list{font-size:.75rem;margin-top:6px;padding-top:6px;border-top:1px solid var(--border);list-style:none}
        .indicadores-list li{padding:2px 0}
        .cuadrante-nav{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
        .nav-btn{width:34px;height:34px;border:2px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
        .cuadrante-table{width:100%;border-collapse:collapse;font-size:.75rem}
        .cuadrante-table th,.cuadrante-table td{border:1px solid var(--border);padding:5px;text-align:left;vertical-align:top}
        .cuadrante-table th{background:var(--primary);color:#fff;text-align:center}
        .cuadrante-table td:first-child{background:var(--primary-light);color:#fff;text-align:center;width:40px}
        .celda{min-height:50px;cursor:pointer;position:relative}
        .celda:hover{background:var(--bg)}
        .celda-vacia{background:#f9fafb;color:var(--text-light)}
        .celda-obj{font-weight:600;color:var(--primary);font-size:.7rem}
        .celda-ind{font-size:.6rem;color:var(--text)}
        .celda-ausencia{background:#fee2e2!important}
        .celda-sincole{background:#e0e7ff!important}
        .celda-icon{position:absolute;top:2px;right:2px;font-size:.6rem}
        .upload-zone{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:20px;text-align:center;cursor:pointer;background:var(--bg)}
        .upload-zone.has-file{border-color:var(--success);background:rgba(34,197,94,.1)}
        .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:#fff;padding:10px 18px;border-radius:var(--radius-sm);font-weight:500;opacity:0;transition:all .3s;z-index:2000}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.success{background:var(--success)}
        .toast.error{background:var(--danger)}
        .empty-state{text-align:center;padding:25px;color:var(--text-light)}
        .leyenda{display:flex;gap:12px;flex-wrap:wrap;font-size:.7rem;margin-top:8px}
        .leyenda-item{display:flex;align-items:center;gap:4px}
        .leyenda-color{width:12px;height:12px;border-radius:3px}
        .alumno-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
        .alumno-header-siglas{font-family:monospace;font-size:1.5rem;font-weight:700;color:var(--primary);background:rgba(26,95,74,.1);padding:10px 16px;border-radius:var(--radius)}
        .stats-box{display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px}
        .stat-item{text-align:center;padding:8px 12px;background:#fff;border-radius:8px;min-width:70px;flex:1}
        .stat-num{font-size:1.3rem;font-weight:700}
        .stat-label{font-size:.65rem;color:var(--text-light)}
        .eval-item{display:flex;align-items:center;gap:6px;padding:8px;background:var(--bg);border-radius:6px;margin-bottom:5px;flex-wrap:wrap}
        .eval-text{flex:1;font-size:.8rem;min-width:140px}
        .eval-btn{width:32px;height:32px;border-radius:50%;border:2px solid var(--border);background:#fff;cursor:pointer;font-size:.85rem}
        .eval-btn.c{border-color:var(--success);color:var(--success)}
        .eval-btn.c.active{background:var(--success);color:#fff}
        .eval-btn.p{border-color:var(--proceso);color:var(--proceso)}
        .eval-btn.p.active{background:var(--proceso);color:#fff}
        .eval-btn.n{border-color:#888;color:#888}
        .eval-btn.n.active{background:#888;color:#fff}
        .asist-btns{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
        .asist-btn{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;cursor:pointer;text-align:center;min-width:80px}
        .asist-btn.selected{border-width:3px}
        .asist-btn.asiste.selected{border-color:var(--success);background:rgba(34,197,94,.1)}
        .asist-btn.ausencia.selected{border-color:var(--danger);background:rgba(239,68,68,.1)}
        .asist-btn.sincole.selected{border-color:#6366f1;background:rgba(99,102,241,.1)}
        .resultado-btns{display:flex;gap:8px;margin-top:10px}
        .resultado-btn{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;cursor:pointer;text-align:center;font-size:.8rem}
        .resultado-btn.selected{border-width:3px}
        .resultado-btn.conseguido.selected{border-color:var(--success);background:rgba(34,197,94,.1)}
        .resultado-btn.repetir.selected{border-color:var(--warning);background:rgba(245,158,11,.1)}
        .chart-container{background:#fff;border-radius:var(--radius-sm);padding:12px;margin-bottom:12px}
        .chart-container canvas{max-height:200px}
        .informe-preview{background:#fff;border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-top:12px;font-size:.85rem;max-height:400px;overflow-y:auto}
        .pasado-badge{font-size:.6rem;background:#fef3c7;color:#92400e;padding:1px 4px;border-radius:3px;margin-left:4px}
        .print-option{padding:12px;border:2px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer;transition:all .2s}
        .print-option:hover{border-color:var(--primary);background:rgba(26,95,74,.05)}
        .print-option h4{margin-bottom:4px;color:var(--primary)}
        .print-option p{font-size:.8rem;color:var(--text-light)}
        .filtros{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
        .filtros select{padding:8px 12px;border:2px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem}
        .plantilla-card{background:var(--bg-card);border-radius:var(--radius);padding:14px;margin-bottom:10px;box-shadow:var(--shadow);cursor:pointer;border:2px solid transparent;transition:all .2s}
        .plantilla-card:hover{border-color:var(--primary-light)}
        .plantilla-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
        .plantilla-titulo{font-weight:700;color:var(--primary);font-size:.95rem}
        .plantilla-meta{display:flex;gap:6px;flex-wrap:wrap}
        .plantilla-badge{font-size:.65rem;padding:3px 8px;border-radius:12px;font-weight:600}
        .badge-ciclo{background:#e0e7ff;color:#4338ca}
        .badge-area{background:#dcfce7;color:#166534}
        .plantilla-stats{font-size:.75rem;color:var(--text-light)}
        .ciclo-infantil{background:#fce7f3;color:#be185d}
        .ciclo-ciclo1{background:#dbeafe;color:#1e40af}
        .ciclo-ciclo2{background:#d1fae5;color:#065f46}
        .ciclo-ciclo3{background:#fef3c7;color:#92400e}
        @media print{.no-print{display:none!important}body{background:#fff}.card{box-shadow:none;border:1px solid #ddd}}
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="header-content">
            <h1 onclick="volverInicio()">üìã Gestor PE v3</h1>
            <div class="status"><div class="status-dot" id="statusDot"></div><span id="statusText">Conectando...</span></div>
        </div>
    </header>

    <!-- PANTALLA INICIO -->
    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="nav-tabs no-print">
                <button class="nav-tab active" onclick="cambiarSeccion('alumnos')">üë• Alumnos</button>
                <button class="nav-tab" onclick="cambiarSeccion('biblioteca')">üìö Biblioteca</button>
            </div>
            
            <!-- SECCI√ìN ALUMNOS -->
            <div id="seccionAlumnos">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üë• Mis Alumnos</h2>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="abrirModalImprimir()">üñ®Ô∏è</button>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalNuevo()">‚ûï Nuevo</button>
                        </div>
                    </div>
                    <div class="alumnos-grid" id="alumnosGrid"></div>
                </div>
            </div>

            <!-- SECCI√ìN BIBLIOTECA -->
            <div id="seccionBiblioteca" style="display:none">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìö Biblioteca de Plantillas</h2>
                        <div class="btn-group">
                            <button class="btn btn-warning btn-sm" onclick="cargarPlantillasBase()">üì• Cargar base</button>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalNuevaPlantilla()">‚ûï Nueva</button>
                        </div>
                    </div>
                    <div class="filtros">
                        <select id="filtroCiclo" onchange="renderBiblioteca()">
                            <option value="">Todos los ciclos</option>
                            <option value="infantil">üíí Infantil</option>
                            <option value="ciclo1">üîµ 1¬∫ Ciclo</option>
                            <option value="ciclo2">üü¢ 2¬∫ Ciclo</option>
                            <option value="ciclo3">üü† 3¬∫ Ciclo</option>
                        </select>
                        <select id="filtroArea" onchange="renderBiblioteca()">
                            <option value="">Todas las √°reas</option>
                            <option value="psicomotor">Desarrollo Psicomotor</option>
                            <option value="motor">Desarrollo Motor</option>
                            <option value="comunicativo">Desarrollo Comunicativo</option>
                            <option value="cognitivo">Desarrollo Cognitivo</option>
                            <option value="social">Desarrollo Social-Emocional</option>
                            <option value="autonomia">Autonom√≠a Personal</option>
                        </select>
                    </div>
                    <div id="bibliotecaGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANTALLA ALUMNO -->
    <div id="screenAlumno" class="screen">
        <div class="container">
            <div class="alumno-header" id="alumnoHeader"></div>
            <div class="tabs no-print">
                <button class="tab active" onclick="cambiarTab('programas')">üìÑ Programas</button>
                <button class="tab" onclick="cambiarTab('programacion')">üìÖ Programaci√≥n</button>
                <button class="tab" onclick="cambiarTab('evaluacion')">üìä Evaluaci√≥n</button>
                <button class="tab" onclick="cambiarTab('asistencia')">üìà Resumen</button>
            </div>
            <div id="tabProgramas" class="tab-content active"></div>
            <div id="tabProgramacion" class="tab-content"></div>
            <div id="tabEvaluacion" class="tab-content"></div>
            <div id="tabAsistencia" class="tab-content"></div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="modalNuevo">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">‚ûï Nuevo Alumno</h3><button class="modal-close" onclick="cerrarModal('modalNuevo')">√ó</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Siglas *</label><input type="text" class="form-input" id="nuevoSiglas" placeholder="M.G.L." maxlength="10"></div>
                    <div class="form-group"><label class="form-label">Curso *</label><select class="form-select" id="nuevoCurso"><option value="infantil">Infantil 3 a√±os</option><option value="infantil">Infantil 4 a√±os</option><option value="infantil" selected>Infantil 5 a√±os</option><option value="ciclo1">1¬∫ Primaria</option><option value="ciclo1">2¬∫ Primaria</option><option value="ciclo2">3¬∫ Primaria</option><option value="ciclo2">4¬∫ Primaria</option><option value="ciclo3">5¬∫ Primaria</option><option value="ciclo3">6¬∫ Primaria</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">D√≠as de sesi√≥n</label><div class="dias-btns" id="diasBtns"><button type="button" class="dia-btn" data-dia="0" onclick="toggleDia(0)">L</button><button type="button" class="dia-btn active" data-dia="1" onclick="toggleDia(1)">M</button><button type="button" class="dia-btn" data-dia="2" onclick="toggleDia(2)">X</button><button type="button" class="dia-btn active" data-dia="3" onclick="toggleDia(3)">J</button><button type="button" class="dia-btn active" data-dia="4" onclick="toggleDia(4)">V</button></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalNuevo')">Cancelar</button><button class="btn btn-primary" onclick="crearAlumno()">‚úì Crear</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAddProg">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">üìÑ A√±adir Programa</h3><button class="modal-close" onclick="cerrarModal('modalAddProg')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Seleccionar de biblioteca</label>
                    <select class="form-select" id="selPlantilla" onchange="previsualizarPlantilla()">
                        <option value="">-- Elegir plantilla --</option>
                    </select>
                </div>
                <div id="previewPlantilla" style="display:none;margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;font-size:.8rem;max-height:200px;overflow-y:auto"></div>
                <hr style="margin:16px 0;border:none;border-top:1px solid var(--border)">
                <p style="font-size:.8rem;color:var(--text-light);margin-bottom:10px">O crear manualmente:</p>
                <div class="form-group"><label class="form-label">Tipo de programa</label><select class="form-select" id="addProgTipo" onchange="cambioTipoProg()"><option value="">Seleccionar...</option><option value="psicomotor">üèÉ Desarrollo Psicomotor</option><option value="motor">‚úã Desarrollo Motor</option><option value="comunicativo">üí¨ Desarrollo Comunicativo</option><option value="cognitivo">üß† Desarrollo Cognitivo</option><option value="social">‚ù§Ô∏è Desarrollo Social-Emocional</option><option value="autonomia">üéØ Autonom√≠a Personal</option><option value="lectoescritura">üìñ Lectoescritura (predefinido)</option></select></div>
                <div id="zonaDocx"><div class="form-group"><label class="form-label">Importar DOCX</label><div class="upload-zone" id="uploadZone" onclick="document.getElementById('inputFile').click()">üìÑ Toca para seleccionar</div><input type="file" id="inputFile" accept=".docx" style="display:none" onchange="cargarDocx(this)"></div><div class="form-group"><label class="form-label">O pegar texto</label><textarea class="form-input" id="addProgTexto" rows="3" placeholder="OBJETIVO 1: ..."></textarea></div><button class="btn btn-secondary btn-sm" onclick="analizarTexto()">üîç Analizar</button></div>
                <div id="zonaLecto" style="display:none"><div style="background:var(--bg);padding:12px;border-radius:8px"><strong>üìñ Programa predefinido</strong><p style="font-size:.8rem;color:var(--text-light)">Vocales y consonantes</p></div></div>
                <div id="previewProg" style="display:none;margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:.8rem"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalAddProg')">Cancelar</button><button class="btn btn-primary" id="btnAddProg" onclick="addPrograma()">üì• A√±adir</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalCelda">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="celdaTitulo">Sesi√≥n</h3><button class="modal-close" onclick="cerrarModal('modalCelda')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Estado</label><div class="asist-btns"><button type="button" class="asist-btn asiste" onclick="setEstado('asiste',this)">‚úÖ Asiste</button><button type="button" class="asist-btn ausencia" onclick="setEstado('ausencia',this)">‚ùå Ausencia</button><button type="button" class="asist-btn sincole" onclick="setEstado('sincole',this)">üè´ Sin cole</button></div></div>
                <div id="contenidoSesion">
                    <div class="form-group"><label class="form-label">Programa</label><select class="form-select" id="selPrograma" onchange="cargarObjetivos()"></select></div>
                    <div class="form-group"><label class="form-label">Objetivo</label><select class="form-select" id="selObjetivo" onchange="cargarIndicadores()"></select></div>
                    <div class="form-group"><label class="form-label">Indicador</label><select class="form-select" id="selIndicador"></select></div>
                    <div class="form-group"><label class="form-label">Resultado</label><div class="resultado-btns"><button type="button" class="resultado-btn conseguido" onclick="setResultado('conseguido',this)">‚úÖ Conseguido</button><button type="button" class="resultado-btn repetir" onclick="setResultado('repetir',this)">üîÑ Repetir</button></div></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-danger btn-sm" onclick="borrarCelda()">üóëÔ∏è</button><button class="btn btn-secondary" onclick="cerrarModal('modalCelda')">Cancelar</button><button class="btn btn-primary" onclick="guardarCelda()">üíæ Guardar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalInforme">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3 class="modal-title">üìÑ Generar Informe</h3><button class="modal-close" onclick="cerrarModal('modalInforme')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Trimestre</label><select class="form-select" id="informeTrim"><option value="1">1¬∫ Trimestre</option><option value="2">2¬∫ Trimestre</option><option value="3">3¬∫ Trimestre</option></select></div>
                <div class="btn-group" style="flex-direction:column;gap:8px"><button class="btn btn-primary" onclick="generarInforme()">üìÑ Generar Informe</button><button class="btn btn-ai" onclick="abrirChatGPTInforme()">ü§ñ ChatGPT - Valoraci√≥n</button></div>
                <div id="informePreview" class="informe-preview" style="display:none"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalInforme')">Cerrar</button><button class="btn btn-primary" id="btnImprimirInforme" onclick="imprimirInforme()" style="display:none">üñ®Ô∏è Imprimir</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalImportJSON">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3 class="modal-title">üì• Importar JSON</h3><button class="modal-close" onclick="cerrarModal('modalImportJSON')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Pega el JSON:</label><textarea class="form-textarea" id="jsonInput" rows="10" placeholder='{"0_1_1": {"pId": "...", "oIdx": 0, "iIdx": 0}, ...}'></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalImportJSON')">Cancelar</button><button class="btn btn-primary" onclick="importarJSON()">üì• Importar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalImprimir">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3 class="modal-title">üñ®Ô∏è Imprimir</h3><button class="modal-close" onclick="cerrarModal('modalImprimir')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Mes</label><select class="form-select" id="printMes"><option value="-1">üìÖ Todo el curso</option><option value="0">Septiembre</option><option value="1">Octubre</option><option value="2">Noviembre</option><option value="3">Diciembre</option><option value="4">Enero</option><option value="5">Febrero</option><option value="6">Marzo</option><option value="7">Abril</option><option value="8">Mayo</option><option value="9">Junio</option></select></div>
                <div class="print-option" onclick="imprimirTodos()"><h4>üñ®Ô∏è Imprimir todos</h4><p>Programaciones de todos los alumnos</p></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalImprimir')">Cerrar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalPlantilla">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3 class="modal-title" id="modalPlantillaTitulo">üìö Plantilla</h3><button class="modal-close" onclick="cerrarModal('modalPlantilla')">√ó</button></div>
            <div class="modal-body" id="modalPlantillaBody"></div>
            <div class="modal-footer" id="modalPlantillaFooter"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalNuevaPlantilla">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3 class="modal-title">‚ûï Nueva Plantilla</h3><button class="modal-close" onclick="cerrarModal('modalNuevaPlantilla')">√ó</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="plantillaNombre" placeholder="Ej: Atenci√≥n sostenida"></div>
                    <div class="form-group"><label class="form-label">Ciclo *</label><select class="form-select" id="plantillaCiclo"><option value="infantil">Infantil</option><option value="ciclo1">1¬∫ Ciclo</option><option value="ciclo2">2¬∫ Ciclo</option><option value="ciclo3">3¬∫ Ciclo</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">√Årea *</label><select class="form-select" id="plantillaArea"><option value="psicomotor">Desarrollo Psicomotor</option><option value="motor">Desarrollo Motor</option><option value="comunicativo">Desarrollo Comunicativo</option><option value="cognitivo">Desarrollo Cognitivo</option><option value="social">Desarrollo Social-Emocional</option><option value="autonomia">Autonom√≠a Personal</option></select></div>
                <div class="form-group"><label class="form-label">Importar DOCX o pegar texto</label><div class="upload-zone" id="uploadZonePlantilla" onclick="document.getElementById('inputFilePlantilla').click()">üìÑ Toca para seleccionar</div><input type="file" id="inputFilePlantilla" accept=".docx" style="display:none" onchange="cargarDocxPlantilla(this)"></div>
                <div class="form-group"><textarea class="form-input" id="plantillaTexto" rows="5" placeholder="OBJETIVO 1: Descripci√≥n&#10;INDICADORES:&#10;- Indicador 1&#10;- Indicador 2"></textarea></div>
                <button class="btn btn-secondary btn-sm" onclick="analizarTextoPlantilla()">üîç Analizar</button>
                <div id="previewPlantillaNueva" style="display:none;margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:.8rem"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalNuevaPlantilla')">Cancelar</button><button class="btn btn-primary" id="btnGuardarPlantilla" onclick="guardarNuevaPlantilla()" disabled>üíæ Guardar</button></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        firebase.initializeApp({databaseURL:"https://gestorpt-7946b-default-rtdb.europe-west1.firebasedatabase.app"});
        const db=firebase.database();
        let alumnos={},plantillas={},alumnoActual=null,mesActual=0,diasSel=[1,3,4],celdaEditando=null,docExtraido=null,docExtraidoPlantilla=null,estadoCelda='asiste',resultadoCelda=null,evalTrim=1,charts={},informeData=null;
        
        const CICLOS={infantil:{nombre:'Infantil',icon:'üíí',color:'#be185d'},ciclo1:{nombre:'1¬∫ Ciclo',icon:'üîµ',color:'#1e40af'},ciclo2:{nombre:'2¬∫ Ciclo',icon:'üü¢',color:'#065f46'},ciclo3:{nombre:'3¬∫ Ciclo',icon:'üü†',color:'#92400e'}};
        const AREAS={psicomotor:{nombre:'Desarrollo Psicomotor',icon:'üèÉ',color:'#8b5cf6'},motor:{nombre:'Desarrollo Motor',icon:'‚úã',color:'#06b6d4'},comunicativo:{nombre:'Desarrollo Comunicativo y Ling√º√≠stico',icon:'üí¨',color:'#10b981'},cognitivo:{nombre:'Desarrollo Cognitivo',icon:'üß†',color:'#3b82f6'},social:{nombre:'Desarrollo Social y Emocional',icon:'‚ù§Ô∏è',color:'#ec4899'},autonomia:{nombre:'Desarrollo de la Autonom√≠a Personal',icon:'üéØ',color:'#f59e0b'},lectoescritura:{nombre:'Lectoescritura',icon:'üìñ',color:'#6366f1'}};
        const MESES=[{nombre:'Septiembre',semanas:3,trim:1},{nombre:'Octubre',semanas:4,trim:1},{nombre:'Noviembre',semanas:4,trim:1},{nombre:'Diciembre',semanas:2,trim:1},{nombre:'Enero',semanas:3,trim:2},{nombre:'Febrero',semanas:4,trim:2},{nombre:'Marzo',semanas:3,trim:2},{nombre:'Abril',semanas:3,trim:3},{nombre:'Mayo',semanas:4,trim:3},{nombre:'Junio',semanas:3,trim:3}];
        const DIAS=['Lunes','Martes','Mi√©rcoles','Jueves','Viernes'],DIAS_C=['L','M','X','J','V'];
        const LECTO=['A','E','I','O','U','M','P','S','L','T','N','D','F','B','V','J','R','C','Q','G','H','CH','√ë','Y','LL','Z','X','K','W'].map((l,i)=>({numero:i+1,descripcion:'Letra '+l,trimestre:i<10?1:(i<20?2:3),indicadores:['Reconoce '+l,'Traza '+l,'Lee s√≠labas con '+l]}));
        
        // PLANTILLAS BASE COMPLETAS
        const PLANTILLAS_BASE = generarPlantillasBase();
        
        function generarPlantillasBase(){
            const p = [];
            // COGNITIVO - INFANTIL
            p.push({
                nombre:'Desarrollo Cognitivo',ciclo:'infantil',tipo:'cognitivo',
                objetivos:[
                    {numero:1,descripcion:'Mejorar la atenci√≥n sostenida',trimestre:1,indicadores:['Mantiene atenci√≥n 3 min en tarea individual','Sigue con la mirada objetos en movimiento','Permanece sentado durante actividad corta','Atiende a cuentos breves con apoyo visual']},
                    {numero:2,descripcion:'Desarrollar la atenci√≥n selectiva',trimestre:1,indicadores:['Discrimina figura-fondo simple','Localiza objetos en im√°genes','Identifica sonidos del entorno','Selecciona objetos por color']},
                    {numero:3,descripcion:'Mejorar la memoria visual',trimestre:1,indicadores:['Recuerda 2-3 im√°genes mostradas','Encuentra objeto escondido','Empareja im√°genes iguales','Completa puzzles de 4-6 piezas']},
                    {numero:4,descripcion:'Desarrollar la memoria auditiva',trimestre:1,indicadores:['Repite secuencia de 2 sonidos','Sigue instrucciones de 1 paso','Recuerda nombre de compa√±eros','Reproduce ritmos sencillos']},
                    {numero:5,descripcion:'Mejorar la percepci√≥n visual',trimestre:1,indicadores:['Discrimina colores b√°sicos','Reconoce formas geom√©tricas','Identifica tama√±os grande-peque√±o','Completa series de 2 elementos']},
                    {numero:6,descripcion:'Desarrollar razonamiento b√°sico',trimestre:2,indicadores:['Clasifica por un atributo','Agrupa objetos iguales','Identifica el diferente en grupo','Ordena por tama√±o 3 objetos']},
                    {numero:7,descripcion:'Mejorar orientaci√≥n espacial',trimestre:2,indicadores:['Identifica arriba-abajo','Reconoce dentro-fuera','Sit√∫a delante-detr√°s','Sigue caminos sencillos']},
                    {numero:8,descripcion:'Desarrollar orientaci√≥n temporal',trimestre:2,indicadores:['Diferencia d√≠a-noche','Conoce rutinas diarias','Ordena secuencia de 2 im√°genes','Identifica antes-despu√©s']},
                    {numero:9,descripcion:'Ampliar atenci√≥n conjunta',trimestre:2,indicadores:['Se√±ala objeto de inter√©s','Comparte atenci√≥n con adulto','Mira donde se√±ala otro','Responde a su nombre']},
                    {numero:10,descripcion:'Mejorar funciones ejecutivas b√°sicas',trimestre:2,indicadores:['Espera turno con apoyo','Inhibe respuesta ante STOP','Cambia de actividad sin rabieta','Sigue rutina de 2 pasos']},
                    {numero:11,descripcion:'Desarrollar pensamiento simb√≥lico',trimestre:3,indicadores:['Juega a ser otro personaje','Usa objeto como si fuera otro','Imita acciones cotidianas','Representa con plastilina']},
                    {numero:12,descripcion:'Mejorar resoluci√≥n de problemas',trimestre:3,indicadores:['Busca objeto no visible','Usa herramienta para alcanzar','Pide ayuda cuando necesita','Intenta varias soluciones']},
                    {numero:13,descripcion:'Ampliar conocimiento del entorno',trimestre:3,indicadores:['Nombra animales comunes','Identifica alimentos b√°sicos','Reconoce transportes','Conoce partes del cuerpo']},
                    {numero:14,descripcion:'Desarrollar creatividad',trimestre:3,indicadores:['Garabatea con intenci√≥n','Construye con bloques','Experimenta con materiales','Propone juegos nuevos']},
                    {numero:15,descripcion:'Generalizar aprendizajes',trimestre:3,indicadores:['Aplica lo aprendido en otros contextos','Transfiere habilidades a casa','Recuerda contenidos tras vacaciones','Muestra progreso acumulado']}
                ]
            });
            
            // COGNITIVO - 1¬∫ CICLO
            p.push({
                nombre:'Desarrollo Cognitivo',ciclo:'ciclo1',tipo:'cognitivo',
                objetivos:[
                    {numero:1,descripcion:'Mejorar atenci√≥n sostenida',trimestre:1,indicadores:['Mantiene atenci√≥n 10 min','Finaliza tareas cortas','Trabaja sin distraerse con ruido','Sigue explicaciones grupales']},
                    {numero:2,descripcion:'Desarrollar atenci√≥n selectiva',trimestre:1,indicadores:['Localiza diferencias en im√°genes','Busca elementos espec√≠ficos','Filtra informaci√≥n relevante','Sigue instrucciones entre distractores']},
                    {numero:3,descripcion:'Mejorar memoria de trabajo',trimestre:1,indicadores:['Retiene 3-4 instrucciones','Opera mentalmente con n√∫meros','Recuerda inicio de frase al final','Mantiene informaci√≥n mientras trabaja']},
                    {numero:4,descripcion:'Ampliar memoria a largo plazo',trimestre:1,indicadores:['Recuerda contenidos de d√≠as anteriores','Evoca vocabulario aprendido','Relaciona con conocimientos previos','Aplica procedimientos aprendidos']},
                    {numero:5,descripcion:'Mejorar percepci√≥n visual',trimestre:1,indicadores:['Discrimina letras similares','Reconoce palabras globalmente','Percibe detalles en im√°genes','Copia figuras con precisi√≥n']},
                    {numero:6,descripcion:'Desarrollar razonamiento l√≥gico',trimestre:2,indicadores:['Clasifica por 2 atributos','Establece relaciones causa-efecto','Resuelve problemas sencillos','Completa series num√©ricas']},
                    {numero:7,descripcion:'Mejorar organizaci√≥n espacial',trimestre:2,indicadores:['Sit√∫a izquierda-derecha en s√≠ mismo','Interpreta planos sencillos','Reproduce figuras en cuadr√≠cula','Describe posiciones de objetos']},
                    {numero:8,descripcion:'Desarrollar organizaci√≥n temporal',trimestre:2,indicadores:['Ordena secuencias de 4 im√°genes','Conoce d√≠as de la semana','Sit√∫a ayer-hoy-ma√±ana','Estima duraciones cortas']},
                    {numero:9,descripcion:'Mejorar planificaci√≥n',trimestre:2,indicadores:['Organiza material antes de tarea','Sigue pasos en orden','Anticipa lo que necesita','Divide tarea en partes']},
                    {numero:10,descripcion:'Desarrollar flexibilidad cognitiva',trimestre:2,indicadores:['Acepta cambios de plan','Considera alternativas','Corrige errores sin frustrarse','Adapta estrategia si no funciona']},
                    {numero:11,descripcion:'Mejorar comprensi√≥n verbal',trimestre:3,indicadores:['Entiende instrucciones complejas','Comprende textos cortos','Responde preguntas literales','Identifica idea principal']},
                    {numero:12,descripcion:'Desarrollar expresi√≥n verbal',trimestre:3,indicadores:['Explica procedimientos','Narra experiencias ordenadamente','Usa vocabulario adecuado','Formula preguntas coherentes']},
                    {numero:13,descripcion:'Ampliar razonamiento num√©rico',trimestre:3,indicadores:['Comprende valor posicional','Resuelve problemas de suma/resta','Estima cantidades','Usa estrategias de c√°lculo']},
                    {numero:14,descripcion:'Mejorar metacognici√≥n',trimestre:3,indicadores:['Identifica qu√© sabe y qu√© no','Pide aclaraciones','Revisa su trabajo','Valora su esfuerzo']},
                    {numero:15,descripcion:'Generalizar aprendizajes',trimestre:3,indicadores:['Aplica estrategias en otras √°reas','Transfiere a contexto familiar','Mantiene logros','Muestra autonom√≠a creciente']}
                ]
            });
            
            // COGNITIVO - 2¬∫ CICLO
            p.push({
                nombre:'Desarrollo Cognitivo',ciclo:'ciclo2',tipo:'cognitivo',
                objetivos:[
                    {numero:1,descripcion:'Mejorar atenci√≥n sostenida compleja',trimestre:1,indicadores:['Mantiene atenci√≥n 20 min','Trabaja de forma aut√≥noma','Gestiona distracciones','Retoma tarea tras interrupci√≥n']},
                    {numero:2,descripcion:'Desarrollar atenci√≥n dividida',trimestre:1,indicadores:['Atiende a dos fuentes de informaci√≥n','Toma apuntes mientras escucha','Alterna entre tareas','Monitoriza varios aspectos']},
                    {numero:3,descripcion:'Ampliar memoria de trabajo',trimestre:1,indicadores:['Opera con varios datos mentalmente','Sigue instrucciones de 4-5 pasos','Resuelve problemas de varios pasos','Mantiene hilo argumental']},
                    {numero:4,descripcion:'Mejorar estrategias de memoria',trimestre:1,indicadores:['Usa categorizaci√≥n para recordar','Crea asociaciones','Aplica reglas mnemot√©cnicas','Repasa de forma efectiva']},
                    {numero:5,descripcion:'Desarrollar pensamiento abstracto',trimestre:1,indicadores:['Comprende conceptos abstractos','Interpreta lenguaje figurado','Establece analog√≠as','Generaliza reglas']},
                    {numero:6,descripcion:'Mejorar razonamiento deductivo',trimestre:2,indicadores:['Extrae conclusiones l√≥gicas','Identifica premisas falsas','Argumenta con coherencia','Detecta falacias simples']},
                    {numero:7,descripcion:'Desarrollar razonamiento inductivo',trimestre:2,indicadores:['Identifica patrones','Formula hip√≥tesis','Verifica predicciones','Generaliza a partir de ejemplos']},
                    {numero:8,descripcion:'Mejorar organizaci√≥n de informaci√≥n',trimestre:2,indicadores:['Elabora esquemas','Jerarquiza informaci√≥n','Resume textos','Identifica ideas principales y secundarias']},
                    {numero:9,descripcion:'Desarrollar planificaci√≥n avanzada',trimestre:2,indicadores:['Establece objetivos','Dise√±a plan de acci√≥n','Gestiona tiempo','Anticipa obst√°culos']},
                    {numero:10,descripcion:'Mejorar control inhibitorio',trimestre:2,indicadores:['Controla impulsividad','Reflexiona antes de actuar','Resiste distracciones atractivas','Demora gratificaci√≥n']},
                    {numero:11,descripcion:'Desarrollar pensamiento cr√≠tico',trimestre:3,indicadores:['Eval√∫a informaci√≥n','Distingue hechos de opiniones','Cuestiona fuentes','Forma opini√≥n fundamentada']},
                    {numero:12,descripcion:'Mejorar resoluci√≥n de problemas',trimestre:3,indicadores:['Identifica el problema','Genera alternativas','Eval√∫a soluciones','Implementa y revisa']},
                    {numero:13,descripcion:'Ampliar comprensi√≥n lectora',trimestre:3,indicadores:['Realiza inferencias','Interpreta intenciones','Comprende estructura textual','Relaciona con conocimientos previos']},
                    {numero:14,descripcion:'Desarrollar expresi√≥n escrita',trimestre:3,indicadores:['Planifica textos','Organiza ideas coherentemente','Revisa y corrige','Adapta registro al contexto']},
                    {numero:15,descripcion:'Consolidar metacognici√≥n',trimestre:3,indicadores:['Autoeval√∫a su aprendizaje','Ajusta estrategias','Reflexiona sobre errores','Transfiere aprendizajes']}
                ]
            });
            
            // COGNITIVO - 3¬∫ CICLO
            p.push({
                nombre:'Desarrollo Cognitivo',ciclo:'ciclo3',tipo:'cognitivo',
                objetivos:[
                    {numero:1,descripcion:'Optimizar atenci√≥n ejecutiva',trimestre:1,indicadores:['Sostiene concentraci√≥n en tareas largas','Gestiona m√∫ltiples demandas','Prioriza informaci√≥n relevante','Autorregula nivel de alerta']},
                    {numero:2,descripcion:'Desarrollar metacognici√≥n avanzada',trimestre:1,indicadores:['Conoce sus fortalezas y debilidades','Selecciona estrategias adecuadas','Monitoriza su comprensi√≥n','Ajusta esfuerzo seg√∫n dificultad']},
                    {numero:3,descripcion:'Ampliar memoria estrat√©gica',trimestre:1,indicadores:['Usa t√©cnicas de estudio eficaces','Organiza informaci√≥n para recordar','Distribuye pr√°ctica en el tiempo','Elabora activamente el material']},
                    {numero:4,descripcion:'Mejorar razonamiento abstracto',trimestre:1,indicadores:['Maneja conceptos complejos','Comprende relaciones no evidentes','Opera con s√≠mbolos','Transfiere principios']},
                    {numero:5,descripcion:'Desarrollar pensamiento cient√≠fico',trimestre:1,indicadores:['Formula hip√≥tesis comprobables','Dise√±a procedimientos de verificaci√≥n','Interpreta resultados','Extrae conclusiones v√°lidas']},
                    {numero:6,descripcion:'Mejorar pensamiento cr√≠tico',trimestre:2,indicadores:['Analiza argumentos','Identifica sesgos','Eval√∫a credibilidad','Sintetiza perspectivas']},
                    {numero:7,descripcion:'Desarrollar creatividad',trimestre:2,indicadores:['Genera ideas originales','Combina conceptos novedosamente','Supera bloqueos','Desarrolla proyectos propios']},
                    {numero:8,descripcion:'Ampliar habilidades organizativas',trimestre:2,indicadores:['Gestiona agenda escolar','Prioriza tareas','Cumple plazos','Organiza materiales y espacio']},
                    {numero:9,descripcion:'Mejorar toma de decisiones',trimestre:2,indicadores:['Identifica opciones','Pondera pros y contras','Considera consecuencias','Decide y asume responsabilidad']},
                    {numero:10,descripcion:'Desarrollar resoluci√≥n de problemas complejos',trimestre:2,indicadores:['Analiza problemas multifactoriales','Descompone en subproblemas','Integra conocimientos diversos','Eval√∫a eficacia de soluciones']},
                    {numero:11,descripcion:'Mejorar comprensi√≥n de textos complejos',trimestre:3,indicadores:['Interpreta textos expositivos','Identifica estructura argumentativa','Relaciona intertextualmente','Eval√∫a intenci√≥n del autor']},
                    {numero:12,descripcion:'Desarrollar expresi√≥n formal',trimestre:3,indicadores:['Escribe textos estructurados','Argumenta con evidencias','Cita fuentes correctamente','Revisa estilo y coherencia']},
                    {numero:13,descripcion:'Ampliar razonamiento matem√°tico',trimestre:3,indicadores:['Resuelve problemas multietapa','Aplica estrategias heur√≠sticas','Verifica resultados','Comunica procedimientos']},
                    {numero:14,descripcion:'Mejorar autorregulaci√≥n del aprendizaje',trimestre:3,indicadores:['Establece metas de aprendizaje','Planifica estudio aut√≥nomamente','Busca recursos y ayuda','Persevera ante dificultades']},
                    {numero:15,descripcion:'Preparar transici√≥n a secundaria',trimestre:3,indicadores:['Trabaja con autonom√≠a','Gestiona m√∫ltiples materias','Adaptarse a distintos profesores','Organiza estudio para ex√°menes']}
                ]
            });

            // SOCIAL-EMOCIONAL - INFANTIL
            p.push({
                nombre:'Desarrollo Social y Emocional',ciclo:'infantil',tipo:'social',
                objetivos:[
                    {numero:1,descripcion:'Desarrollar conciencia emocional b√°sica',trimestre:1,indicadores:['Identifica alegr√≠a en s√≠ mismo','Reconoce tristeza propia','Expresa enfado de forma b√°sica','Identifica miedo']},
                    {numero:2,descripcion:'Reconocer emociones en otros',trimestre:1,indicadores:['Identifica caras alegres','Reconoce expresi√≥n de tristeza','Detecta enfado en otros','Responde a llanto de compa√±ero']},
                    {numero:3,descripcion:'Mejorar regulaci√≥n emocional',trimestre:1,indicadores:['Acepta consuelo del adulto','Usa objeto de apego apropiadamente','Se calma con estrategias simples','Tolera peque√±as frustraciones']},
                    {numero:4,descripcion:'Desarrollar v√≠nculo con adultos',trimestre:1,indicadores:['Busca proximidad del adulto','Acepta separaci√≥n con apoyo','Muestra preferencia por figuras estables','Comparte experiencias con adulto']},
                    {numero:5,descripcion:'Iniciar relaci√≥n con iguales',trimestre:1,indicadores:['Muestra inter√©s por otros ni√±os','Juega al lado de otros','Observa juego de compa√±eros','Acepta presencia de otros']},
                    {numero:6,descripcion:'Desarrollar juego social',trimestre:2,indicadores:['Participa en juego paralelo','Comparte espacio de juego','Imita acciones de compa√±eros','Inicia interacci√≥n simple']},
                    {numero:7,descripcion:'Mejorar habilidades de comunicaci√≥n social',trimestre:2,indicadores:['Saluda con apoyo','Se despide','Responde cuando le llaman','Pide por favor con modelo']},
                    {numero:8,descripcion:'Desarrollar conductas prosociales',trimestre:2,indicadores:['Ayuda a recoger','Ofrece objeto a otro','Muestra preocupaci√≥n por otro','Consuela de forma b√°sica']},
                    {numero:9,descripcion:'Mejorar tolerancia a la frustraci√≥n',trimestre:2,indicadores:['Espera turno con apoyo visual','Acepta no ser primero','Tolera perder en juego','Acepta l√≠mites del adulto']},
                    {numero:10,descripcion:'Desarrollar autoconcepto positivo',trimestre:2,indicadores:['Dice su nombre','Reconoce sus pertenencias','Muestra sus logros','Expresa preferencias']},
                    {numero:11,descripcion:'Ampliar juego cooperativo',trimestre:3,indicadores:['Participa en juego con otros','Acepta propuestas de compa√±eros','Sigue reglas simples de juego','Comparte materiales']},
                    {numero:12,descripcion:'Mejorar resoluci√≥n de conflictos',trimestre:3,indicadores:['Pide ayuda al adulto ante conflicto','Acepta mediaci√≥n','Usa palabras en vez de pegar','Propone soluci√≥n simple']},
                    {numero:13,descripcion:'Desarrollar empat√≠a b√°sica',trimestre:3,indicadores:['Muestra preocupaci√≥n por otro triste','Ofrece ayuda espont√°nea','Adapta conducta al estado del otro','Celebra logros de compa√±eros']},
                    {numero:14,descripcion:'Ampliar autonom√≠a emocional',trimestre:3,indicadores:['Expresa emociones verbalmente','Pide lo que necesita','Acepta ayuda apropiadamente','Muestra orgullo por logros']},
                    {numero:15,descripcion:'Generalizar habilidades sociales',trimestre:3,indicadores:['Aplica habilidades en recreo','Muestra conductas sociales en casa','Interact√∫a con adultos no familiares','Mantiene amistades incipientes']}
                ]
            });

            // SOCIAL-EMOCIONAL - 1¬∫ CICLO
            p.push({
                nombre:'Desarrollo Social y Emocional',ciclo:'ciclo1',tipo:'social',
                objetivos:[
                    {numero:1,descripcion:'Ampliar vocabulario emocional',trimestre:1,indicadores:['Nombra emociones b√°sicas','Describe situaciones que provocan emociones','Usa palabras emocionales en contexto','Diferencia intensidad emocional']},
                    {numero:2,descripcion:'Mejorar conciencia emocional',trimestre:1,indicadores:['Identifica emociones propias','Reconoce cambios emocionales','Relaciona situaci√≥n-emoci√≥n','Expresa c√≥mo se siente']},
                    {numero:3,descripcion:'Desarrollar regulaci√≥n emocional',trimestre:1,indicadores:['Usa t√©cnicas de relajaci√≥n simples','Aplica respiraci√≥n para calmarse','Busca lugar tranquilo cuando necesita','Pide ayuda para regular']},
                    {numero:4,descripcion:'Mejorar tolerancia a la frustraci√≥n',trimestre:1,indicadores:['Acepta errores sin rabieta','Sigue intentando tras fracaso','Espera turno sin enfadarse','Acepta no ganar siempre']},
                    {numero:5,descripcion:'Desarrollar autoestima',trimestre:1,indicadores:['Reconoce sus fortalezas','Acepta sus dificultades','Muestra orgullo por logros','Habla positivamente de s√≠ mismo']},
                    {numero:6,descripcion:'Mejorar habilidades de conversaci√≥n',trimestre:2,indicadores:['Inicia conversaci√≥n','Mantiene tema','Respeta turnos de palabra','Hace preguntas al interlocutor']},
                    {numero:7,descripcion:'Desarrollar asertividad',trimestre:2,indicadores:['Expresa opiniones','Defiende sus derechos sin agredir','Dice no apropiadamente','Pide lo que necesita']},
                    {numero:8,descripcion:'Mejorar cooperaci√≥n',trimestre:2,indicadores:['Trabaja en equipo','Aporta al grupo','Acepta ideas de otros','Celebra logros grupales']},
                    {numero:9,descripcion:'Desarrollar empat√≠a',trimestre:2,indicadores:['Reconoce emociones en otros','Se pone en lugar del otro','Ofrece consuelo apropiado','Adapta conducta seg√∫n estado del otro']},
                    {numero:10,descripcion:'Mejorar resoluci√≥n de conflictos',trimestre:2,indicadores:['Identifica el problema','Propone soluciones','Negocia','Acepta soluciones de compromiso']},
                    {numero:11,descripcion:'Desarrollar habilidades de amistad',trimestre:3,indicadores:['Inicia y mantiene amistades','Comparte con amigos','Ayuda a amigos','Resuelve conflictos con amigos']},
                    {numero:12,descripcion:'Mejorar conducta en grupo',trimestre:3,indicadores:['Sigue normas grupales','Participa activamente','Respeta opiniones diferentes','Contribuye al clima positivo']},
                    {numero:13,descripcion:'Desarrollar responsabilidad',trimestre:3,indicadores:['Asume consecuencias de sus actos','Cumple compromisos','Cuida materiales comunes','Ayuda sin que se lo pidan']},
                    {numero:14,descripcion:'Ampliar regulaci√≥n conductual',trimestre:3,indicadores:['Controla impulsos','Piensa antes de actuar','Sigue normas sin supervisi√≥n','Se autorregula en clase']},
                    {numero:15,descripcion:'Generalizar competencias socioemocionales',trimestre:3,indicadores:['Aplica habilidades en distintos contextos','Muestra mejora en casa','Mantiene relaciones positivas','Gestiona emociones aut√≥nomamente']}
                ]
            });

            // COMUNICATIVO - INFANTIL
            p.push({
                nombre:'Desarrollo Comunicativo y Ling√º√≠stico',ciclo:'infantil',tipo:'comunicativo',
                objetivos:[
                    {numero:1,descripcion:'Desarrollar intenci√≥n comunicativa',trimestre:1,indicadores:['Usa gestos para comunicar','Se√±ala para pedir','Muestra objetos','Busca atenci√≥n del adulto']},
                    {numero:2,descripcion:'Ampliar comprensi√≥n verbal',trimestre:1,indicadores:['Comprende palabras familiares','Sigue √≥rdenes simples','Identifica objetos nombrados','Responde a preguntas s√≠/no']},
                    {numero:3,descripcion:'Mejorar expresi√≥n oral',trimestre:1,indicadores:['Emite vocalizaciones variadas','Produce primeras palabras','Nombra objetos familiares','Pide mediante palabra']},
                    {numero:4,descripcion:'Desarrollar vocabulario',trimestre:1,indicadores:['Comprende 50+ palabras','Produce 10+ palabras','Aprende palabras nuevas','Usa nombres de personas cercanas']},
                    {numero:5,descripcion:'Mejorar articulaci√≥n',trimestre:1,indicadores:['Produce vocales','Articula consonantes iniciales','Produce s√≠labas directas','Es inteligible para cercanos']},
                    {numero:6,descripcion:'Ampliar estructura de frases',trimestre:2,indicadores:['Combina dos palabras','Usa frase de 3 elementos','Usa art√≠culos','Incorpora verbos']},
                    {numero:7,descripcion:'Desarrollar comprensi√≥n de oraciones',trimestre:2,indicadores:['Comprende √≥rdenes de 2 pasos','Entiende preguntas qu√©/qui√©n','Sigue instrucciones de clase','Comprende negaciones']},
                    {numero:8,descripcion:'Mejorar pragm√°tica',trimestre:2,indicadores:['Saluda apropiadamente','Responde a saludos','Participa en intercambios','Mantiene tema brevemente']},
                    {numero:9,descripcion:'Desarrollar narraci√≥n',trimestre:2,indicadores:['Cuenta experiencias simples','Secuencia 2 eventos','Describe im√°genes','Responde sobre cuentos']},
                    {numero:10,descripcion:'Ampliar comprensi√≥n de cuentos',trimestre:2,indicadores:['Atiende a cuentos cortos','Identifica personajes','Responde preguntas sobre cuento','Anticipa eventos conocidos']},
                    {numero:11,descripcion:'Mejorar conciencia fonol√≥gica',trimestre:3,indicadores:['Identifica rimas','Reconoce sonido inicial','Segmenta en s√≠labas','Discrimina sonidos diferentes']},
                    {numero:12,descripcion:'Desarrollar lenguaje descriptivo',trimestre:3,indicadores:['Usa adjetivos b√°sicos','Describe objetos','Compara por tama√±o/color','Describe acciones']},
                    {numero:13,descripcion:'Ampliar uso de preguntas',trimestre:3,indicadores:['Hace preguntas qu√©','Pregunta d√≥nde','Usa por qu√©','Responde a preguntas abiertas']},
                    {numero:14,descripcion:'Mejorar discurso',trimestre:3,indicadores:['Narra con inicio-fin','Usa conectores b√°sicos','Mantiene coherencia','Adapta a interlocutor']},
                    {numero:15,descripcion:'Preparar acceso a lectoescritura',trimestre:3,indicadores:['Reconoce nombre escrito','Identifica algunas letras','Garabatea con intenci√≥n','Diferencia dibujo de escritura']}
                ]
            });

            // AUTONOM√çA - INFANTIL
            p.push({
                nombre:'Desarrollo de la Autonom√≠a Personal',ciclo:'infantil',tipo:'autonomia',
                objetivos:[
                    {numero:1,descripcion:'Desarrollar autonom√≠a en alimentaci√≥n',trimestre:1,indicadores:['Come con cuchara','Bebe de vaso','Permanece sentado comiendo','Muestra preferencias alimentarias']},
                    {numero:2,descripcion:'Mejorar control de esf√≠nteres',trimestre:1,indicadores:['Avisa cuando necesita ir','Usa el WC con ayuda','Permanece seco periodos','Colabora en limpieza']},
                    {numero:3,descripcion:'Desarrollar autonom√≠a en vestido',trimestre:1,indicadores:['Colabora al vestirse','Se quita prendas simples','Identifica partes de ropa','Se√±ala su ropa']},
                    {numero:4,descripcion:'Mejorar higiene personal',trimestre:1,indicadores:['Acepta lavado de manos','Colabora en lavado de cara','Se limpia nariz con ayuda','Acepta peinarse']},
                    {numero:5,descripcion:'Desarrollar organizaci√≥n personal',trimestre:1,indicadores:['Guarda juguetes con ayuda','Reconoce sus pertenencias','Sigue rutina con apoyo','Acepta transiciones']},
                    {numero:6,descripcion:'Ampliar autonom√≠a en alimentaci√≥n',trimestre:2,indicadores:['Usa tenedor','Se sirve con ayuda','Limpia lo derramado','Come variedad de alimentos']},
                    {numero:7,descripcion:'Consolidar control de esf√≠nteres',trimestre:2,indicadores:['Va al WC solo','Se limpia con supervisi√≥n','Permanece seco de d√≠a','Avisa con anticipaci√≥n']},
                    {numero:8,descripcion:'Mejorar autonom√≠a en vestido',trimestre:2,indicadores:['Se pone ropa sencilla','Se quita zapatos','Intenta abrochar','Elige entre opciones']},
                    {numero:9,descripcion:'Ampliar higiene personal',trimestre:2,indicadores:['Se lava manos solo','Se lava cara','Se cepilla dientes con supervisi√≥n','Usa jab√≥n apropiadamente']},
                    {numero:10,descripcion:'Desarrollar seguridad personal',trimestre:2,indicadores:['Conoce normas b√°sicas de seguridad','Identifica peligros obvios','Pide ayuda cuando necesita','Se orienta en espacios conocidos']},
                    {numero:11,descripcion:'Consolidar autonom√≠a en alimentaci√≥n',trimestre:3,indicadores:['Come aut√≥nomamente','Usa servilleta','Pone/quita mesa parcialmente','Prueba alimentos nuevos']},
                    {numero:12,descripcion:'Ampliar autonom√≠a en vestido',trimestre:3,indicadores:['Se viste casi completamente','Abrocha velcro/botones grandes','Calza zapatos (sin atar)','Cuelga abrigo']},
                    {numero:13,descripcion:'Consolidar higiene',trimestre:3,indicadores:['Rutina de higiene aut√≥noma','Reconoce cu√°ndo lavarse','Tira de cisterna','Usa WC p√∫blico con apoyo']},
                    {numero:14,descripcion:'Desarrollar autonom√≠a en tareas',trimestre:3,indicadores:['Prepara material','Recoge tras actividad','Sigue rutina de clase','Realiza encargos']},
                    {numero:15,descripcion:'Generalizar autonom√≠a',trimestre:3,indicadores:['Es aut√≥nomo en rutinas diarias','Transfiere habilidades a casa','Pide ayuda apropiadamente','Muestra iniciativa']}
                ]
            });

            // MOTOR - INFANTIL
            p.push({
                nombre:'Desarrollo Motor',ciclo:'infantil',tipo:'motor',
                objetivos:[
                    {numero:1,descripcion:'Desarrollar prensi√≥n',trimestre:1,indicadores:['Agarra objetos gruesos','Usa pinza digital','Manipula plastilina','Ensarta cuentas grandes']},
                    {numero:2,descripcion:'Mejorar coordinaci√≥n √≥culo-manual',trimestre:1,indicadores:['Apila 4-5 bloques','Encaja piezas en tablero','Abre y cierra tapones','Vierte l√≠quidos con ayuda']},
                    {numero:3,descripcion:'Desarrollar grafomotricidad inicial',trimestre:1,indicadores:['Garabatea con agarre','Traza l√≠neas verticales','Imita trazos','Colorea sin l√≠mites']},
                    {numero:4,descripcion:'Mejorar destreza manual',trimestre:1,indicadores:['Abre recipientes sencillos','Pasa p√°ginas de libro','Usa pegamento con ayuda','Rasga papel']},
                    {numero:5,descripcion:'Desarrollar lateralidad',trimestre:1,indicadores:['Muestra preferencia de mano','Usa mano dominante','Cruza l√≠nea media','Identifica manos']},
                    {numero:6,descripcion:'Ampliar precisi√≥n manual',trimestre:2,indicadores:['Recorta con tijeras','Pica con punz√≥n','Moldea formas','Dobla papel por mitad']},
                    {numero:7,descripcion:'Mejorar grafomotricidad',trimestre:2,indicadores:['Traza l√≠neas horizontales','Dibuja c√≠rculos','Copia formas b√°sicas','Colorea respetando contorno']},
                    {numero:8,descripcion:'Desarrollar coordinaci√≥n bimanual',trimestre:2,indicadores:['Usa manos de forma coordinada','Enrosca/desenrosca','Abre/cierra cremalleras','Abotona botones grandes']},
                    {numero:9,descripcion:'Mejorar manejo de utensilios',trimestre:2,indicadores:['Usa tijeras correctamente','Maneja pincel','Usa l√°piz con agarre correcto','Utiliza goma de borrar']},
                    {numero:10,descripcion:'Ampliar destrezas finas',trimestre:2,indicadores:['Ensarta cuentas peque√±as','Construye con piezas peque√±as','Manipula objetos peque√±os','Pliega papel']},
                    {numero:11,descripcion:'Consolidar grafomotricidad',trimestre:3,indicadores:['Dibuja figura humana b√°sica','Copia letras sencillas','Escribe nombre con modelo','Controla presi√≥n del trazo']},
                    {numero:12,descripcion:'Mejorar precisi√≥n',trimestre:3,indicadores:['Recorta siguiendo l√≠neas','Pega con precisi√≥n','Colorea sin salirse','Dibuja detalles']},
                    {numero:13,descripcion:'Desarrollar autonom√≠a en tareas manipulativas',trimestre:3,indicadores:['Realiza manualidades guiadas','Completa tareas manipulativas solo','Organiza materiales','Cuida herramientas']},
                    {numero:14,descripcion:'Ampliar destreza en juegos',trimestre:3,indicadores:['Construye con bloques peque√±os','Completa puzzles de 12+ piezas','Juega con construcciones','Manipula juegos de mesa']},
                    {numero:15,descripcion:'Preparar motricidad para escritura',trimestre:3,indicadores:['Postura correcta al escribir','Agarre maduro del l√°piz','Traza letras con fluidez','Controla espacio en papel']}
                ]
            });

            // PSICOMOTOR - INFANTIL
            p.push({
                nombre:'Desarrollo Psicomotor',ciclo:'infantil',tipo:'psicomotor',
                objetivos:[
                    {numero:1,descripcion:'Desarrollar control postural',trimestre:1,indicadores:['Mantiene equilibrio de pie','Se sienta correctamente','Cambia de posici√≥n con control','Mantiene postura en actividad']},
                    {numero:2,descripcion:'Mejorar desplazamientos b√°sicos',trimestre:1,indicadores:['Camina con seguridad','Corre sin caerse','Sube escaleras alternando','Baja escaleras con apoyo']},
                    {numero:3,descripcion:'Desarrollar coordinaci√≥n global',trimestre:1,indicadores:['Salta con dos pies','Lanza pelota','Atrapa pelota grande','Patea bal√≥n']},
                    {numero:4,descripcion:'Mejorar esquema corporal',trimestre:1,indicadores:['Se√±ala partes del cuerpo','Nombra partes principales','Dibuja figura humana b√°sica','Imita posiciones']},
                    {numero:5,descripcion:'Desarrollar equilibrio est√°tico',trimestre:1,indicadores:['Se mantiene a la pata coja','Permanece de puntillas','Adopta posturas de estatua','Mantiene equilibrio en un pie']},
                    {numero:6,descripcion:'Ampliar desplazamientos',trimestre:2,indicadores:['Salta obst√°culos bajos','Corre cambiando direcci√≥n','Galopa','Se desplaza hacia atr√°s']},
                    {numero:7,descripcion:'Mejorar coordinaci√≥n din√°mica',trimestre:2,indicadores:['Salta a la cuerda (intento)','Bota pelota','Camina sobre l√≠nea','Sigue circuitos simples']},
                    {numero:8,descripcion:'Desarrollar lateralidad corporal',trimestre:2,indicadores:['Diferencia derecha-izquierda en s√≠','Usa lado dominante consistentemente','Cruza l√≠nea media corporal','Realiza movimientos bilaterales']},
                    {numero:9,descripcion:'Mejorar ritmo y movimiento',trimestre:2,indicadores:['Sigue ritmos con cuerpo','Baila siguiendo m√∫sica','Reproduce secuencias de movimiento','Coordina movimiento con sonido']},
                    {numero:10,descripcion:'Desarrollar conciencia espacial',trimestre:2,indicadores:['Se sit√∫a arriba/abajo/dentro/fuera','Sigue direcciones espaciales','Calcula distancias b√°sicas','Se orienta en espacio conocido']},
                    {numero:11,descripcion:'Consolidar equilibrio din√°mico',trimestre:3,indicadores:['Camina por barra baja','Salta alternando pies','Mantiene equilibrio en movimiento','Supera circuitos de equilibrio']},
                    {numero:12,descripcion:'Ampliar habilidades motrices',trimestre:3,indicadores:['Trepa','Se cuelga','Hace voltereta con ayuda','Usa aparatos de parque']},
                    {numero:13,descripcion:'Mejorar coordinaci√≥n con objetos',trimestre:3,indicadores:['Bota y camina','Lanza con direcci√≥n','Atrapa pelotas peque√±as','Maneja implementos deportivos b√°sicos']},
                    {numero:14,descripcion:'Desarrollar expresi√≥n corporal',trimestre:3,indicadores:['Representa con el cuerpo','Imita animales','Expresa emociones corporalmente','Participa en dramatizaciones']},
                    {numero:15,descripcion:'Preparar para deportes',trimestre:3,indicadores:['Participa en juegos grupales motrices','Sigue reglas de juegos motores','Muestra deportividad b√°sica','Disfruta de actividad f√≠sica']}
                ]
            });

            // A√±adir m√°s para otros ciclos (comunicativo, social, autonom√≠a, motor, psicomotor para ciclo1, ciclo2, ciclo3)
            // Por brevedad, a√±ado algunos m√°s representativos

            // COMUNICATIVO - 1¬∫ CICLO
            p.push({
                nombre:'Desarrollo Comunicativo y Ling√º√≠stico',ciclo:'ciclo1',tipo:'comunicativo',
                objetivos:[
                    {numero:1,descripcion:'Mejorar conciencia fonol√≥gica',trimestre:1,indicadores:['Segmenta palabras en s√≠labas','Identifica s√≠laba inicial/final','Reconoce rimas','Manipula fonemas iniciales']},
                    {numero:2,descripcion:'Desarrollar decodificaci√≥n lectora',trimestre:1,indicadores:['Lee s√≠labas directas','Lee palabras de 2 s√≠labas','Automatiza s√≠labas frecuentes','Lee con menor silabeo']},
                    {numero:3,descripcion:'Mejorar fluidez lectora',trimestre:1,indicadores:['Lee frases cortas','Respeta puntuaci√≥n b√°sica','Aumenta velocidad lectora','Lee sin regresiones']},
                    {numero:4,descripcion:'Desarrollar comprensi√≥n lectora',trimestre:1,indicadores:['Comprende frases cortas','Responde preguntas literales','Identifica personajes','Secuencia eventos']},
                    {numero:5,descripcion:'Mejorar expresi√≥n escrita',trimestre:1,indicadores:['Copia con correcci√≥n','Escribe al dictado palabras','Separa palabras','Usa may√∫scula inicial']},
                    {numero:6,descripcion:'Ampliar vocabulario',trimestre:2,indicadores:['Adquiere vocabulario de √°rea','Define palabras sencillas','Usa sin√≥nimos b√°sicos','Comprende palabras nuevas en contexto']},
                    {numero:7,descripcion:'Mejorar expresi√≥n oral',trimestre:2,indicadores:['Narra experiencias con orden','Describe objetos y personas','Explica procedimientos','Argumenta preferencias']},
                    {numero:8,descripcion:'Desarrollar lectura comprensiva',trimestre:2,indicadores:['Comprende textos cortos','Realiza inferencias simples','Identifica idea principal','Relaciona con conocimiento previo']},
                    {numero:9,descripcion:'Mejorar escritura creativa',trimestre:2,indicadores:['Escribe frases propias','Completa textos','Redacta textos breves','Usa vocabulario variado']},
                    {numero:10,descripcion:'Desarrollar ortograf√≠a',trimestre:2,indicadores:['Aplica reglas b√°sicas','Usa may√∫sculas correctamente','Escribe sin omisiones','Corrige errores se√±alados']},
                    {numero:11,descripcion:'Ampliar comprensi√≥n oral',trimestre:3,indicadores:['Comprende explicaciones orales','Sigue instrucciones complejas','Entiende textos orales','Capta informaci√≥n impl√≠cita']},
                    {numero:12,descripcion:'Mejorar habilidades discursivas',trimestre:3,indicadores:['Organiza discurso','Mantiene coherencia','Usa conectores','Adapta registro']},
                    {numero:13,descripcion:'Desarrollar lectura expresiva',trimestre:3,indicadores:['Lee con entonaci√≥n','Respeta pausas','Lee con expresividad','Lee para otros']},
                    {numero:14,descripcion:'Ampliar producci√≥n escrita',trimestre:3,indicadores:['Escribe textos de 5+ oraciones','Planifica antes de escribir','Revisa lo escrito','Presenta textos legibles']},
                    {numero:15,descripcion:'Consolidar competencia comunicativa',trimestre:3,indicadores:['Comunica eficazmente','Lee con comprensi√≥n funcional','Escribe para comunicar','Disfruta de leer y escribir']}
                ]
            });

            // AUTONOM√çA - 1¬∫ CICLO
            p.push({
                nombre:'Desarrollo de la Autonom√≠a Personal',ciclo:'ciclo1',tipo:'autonomia',
                objetivos:[
                    {numero:1,descripcion:'Consolidar h√°bitos de higiene',trimestre:1,indicadores:['Realiza aseo aut√≥nomamente','Cuida aspecto personal','Usa WC correctamente','Lava manos sin recordatorio']},
                    {numero:2,descripcion:'Mejorar autonom√≠a en alimentaci√≥n',trimestre:1,indicadores:['Come aut√≥nomamente cualquier alimento','Usa cubiertos correctamente','Se sirve la cantidad adecuada','Mastica correctamente']},
                    {numero:3,descripcion:'Desarrollar autonom√≠a en vestido',trimestre:1,indicadores:['Se viste completamente solo','Ata cordones (o intenta)','Abrocha todo tipo de cierres','Elige ropa apropiada']},
                    {numero:4,descripcion:'Mejorar organizaci√≥n de materiales',trimestre:1,indicadores:['Prepara mochila','Cuida material escolar','Organiza mesa de trabajo','Encuentra lo que necesita']},
                    {numero:5,descripcion:'Desarrollar gesti√≥n del tiempo',trimestre:1,indicadores:['Sigue horario de clase','Distingue momentos del d√≠a','Calcula tiempo aproximado','Llega puntual a actividades']},
                    {numero:6,descripcion:'Ampliar responsabilidad personal',trimestre:2,indicadores:['Cuida pertenencias','Cumple encargos','Recuerda tareas','Asume consecuencias']},
                    {numero:7,descripcion:'Mejorar autonom√≠a acad√©mica',trimestre:2,indicadores:['Inicia tareas sin ayuda','Busca informaci√≥n necesaria','Pide ayuda apropiadamente','Trabaja solo periodos cortos']},
                    {numero:8,descripcion:'Desarrollar seguridad personal',trimestre:2,indicadores:['Conoce normas de seguridad','Act√∫a con prudencia','Se orienta en entorno cercano','Identifica situaciones de riesgo']},
                    {numero:9,descripcion:'Mejorar autocuidado',trimestre:2,indicadores:['Reconoce s√≠ntomas de malestar','Comunica necesidades de salud','Cuida peque√±as heridas','Conoce h√°bitos saludables']},
                    {numero:10,descripcion:'Desarrollar autonom√≠a en el hogar',trimestre:2,indicadores:['Colabora en tareas dom√©sticas','Recoge su habitaci√≥n','Pone y quita mesa','Cuida espacios comunes']},
                    {numero:11,descripcion:'Ampliar autonom√≠a en desplazamientos',trimestre:3,indicadores:['Se desplaza por el colegio solo','Conoce espacios del centro','Llega solo a lugares cercanos','Se orienta en planos simples']},
                    {numero:12,descripcion:'Mejorar gesti√≥n de pertenencias',trimestre:3,indicadores:['Cuida sus cosas','Presta y pide prestado apropiadamente','Administra peque√±as cantidades','Valora lo que tiene']},
                    {numero:13,descripcion:'Desarrollar autonom√≠a en resoluci√≥n de problemas cotidianos',trimestre:3,indicadores:['Resuelve peque√±os problemas solo','Busca alternativas','Toma decisiones b√°sicas','Pide ayuda cuando es necesario']},
                    {numero:14,descripcion:'Ampliar h√°bitos saludables',trimestre:3,indicadores:['Mantiene dieta equilibrada','Realiza actividad f√≠sica','Duerme las horas necesarias','Evita h√°bitos perjudiciales']},
                    {numero:15,descripcion:'Generalizar autonom√≠a',trimestre:3,indicadores:['Es aut√≥nomo en rutinas diarias','Act√∫a responsablemente','Muestra iniciativa','Generaliza habilidades a nuevos contextos']}
                ]
            });

            return p;
        }
        
        // Escuchar cambios en Firebase
        db.ref('gestorpe/alumnos').on('value',snap=>{alumnos=snap.val()||{};renderInicio();if(alumnoActual&&alumnos[alumnoActual]){renderProgs();renderProg();renderEval();renderAsis();}document.getElementById('statusDot').classList.add('ok');document.getElementById('statusText').textContent='Conectado';});
        db.ref('gestorpe/plantillas').on('value',snap=>{plantillas=snap.val()||{};renderBiblioteca();});

        function cambiarSeccion(s){
            document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('seccionAlumnos').style.display=s==='alumnos'?'block':'none';
            document.getElementById('seccionBiblioteca').style.display=s==='biblioteca'?'block':'none';
            if(s==='biblioteca')renderBiblioteca();
        }

        function renderInicio(){const g=document.getElementById('alumnosGrid'),ids=Object.keys(alumnos);if(!ids.length){g.innerHTML='<div class="alumno-card alumno-card-add" onclick="abrirModalNuevo()"><span style="font-size:1.3rem">‚ûï</span><span style="font-size:.8rem">A√±adir</span></div>';return;}let h=ids.map(id=>{const a=alumnos[id],n=a.programas?Object.keys(a.programas).length:0;return'<div class="alumno-card" onclick="abrirAlumno(\''+id+'\')"><div class="alumno-siglas">'+a.siglas+'</div><div class="alumno-curso">'+a.curso+'</div><div class="alumno-progs">'+n+' prog.</div></div>';}).join('');h+='<div class="alumno-card alumno-card-add" onclick="abrirModalNuevo()"><span style="font-size:1.3rem">‚ûï</span></div>';g.innerHTML=h;}
        
        // BIBLIOTECA
        function renderBiblioteca(){
            const c=document.getElementById('bibliotecaGrid');
            const cicloF=document.getElementById('filtroCiclo').value;
            const areaF=document.getElementById('filtroArea').value;
            const lista=Object.keys(plantillas).map(id=>({id,...plantillas[id]}));
            const filtrada=lista.filter(p=>{
                if(cicloF&&p.ciclo!==cicloF)return false;
                if(areaF&&p.tipo!==areaF)return false;
                return true;
            });
            if(!filtrada.length){
                c.innerHTML='<div class="empty-state"><p>No hay plantillas</p><p style="font-size:.8rem;margin-top:8px">Pulsa "Cargar base" para importar plantillas predefinidas</p></div>';
                return;
            }
            c.innerHTML=filtrada.map(p=>{
                const ciclo=CICLOS[p.ciclo]||{nombre:p.ciclo,color:'#666'};
                const area=AREAS[p.tipo]||{nombre:p.tipo,icon:'üìÑ',color:'#666'};
                const nObj=p.objetivos?p.objetivos.length:0;
                const nInd=p.objetivos?p.objetivos.reduce((s,o)=>s+(o.indicadores?o.indicadores.length:0),0):0;
                return'<div class="plantilla-card" onclick="verPlantilla(\''+p.id+'\')"><div class="plantilla-header"><span class="plantilla-titulo">'+area.icon+' '+p.nombre+'</span></div><div class="plantilla-meta"><span class="plantilla-badge ciclo-'+p.ciclo+'">'+ciclo.nombre+'</span><span class="plantilla-badge badge-area">'+area.nombre.split(' ')[1]+'</span></div><div class="plantilla-stats">'+nObj+' objetivos ¬∑ '+nInd+' indicadores</div></div>';
            }).join('');
        }
        
        function verPlantilla(id){
            const p=plantillas[id];
            if(!p)return;
            const area=AREAS[p.tipo]||{nombre:p.tipo,icon:'üìÑ'};
            const ciclo=CICLOS[p.ciclo]||{nombre:p.ciclo};
            document.getElementById('modalPlantillaTitulo').textContent=area.icon+' '+p.nombre;
            let h='<div class="plantilla-meta" style="margin-bottom:12px"><span class="plantilla-badge ciclo-'+p.ciclo+'">'+ciclo.nombre+'</span><span class="plantilla-badge badge-area">'+area.nombre+'</span></div>';
            (p.objetivos||[]).forEach(o=>{
                h+='<div class="objetivo-card"><div class="objetivo-header"><span class="objetivo-num">O'+o.numero+'</span><span class="trimestre-badge t'+o.trimestre+'">T'+o.trimestre+'</span></div><div class="objetivo-desc">'+o.descripcion+'</div>';
                if(o.indicadores&&o.indicadores.length){
                    h+='<ul class="indicadores-list">'+o.indicadores.map(x=>'<li>‚Ä¢ '+x+'</li>').join('')+'</ul>';
                }
                h+='</div>';
            });
            document.getElementById('modalPlantillaBody').innerHTML=h;
            document.getElementById('modalPlantillaFooter').innerHTML='<button class="btn btn-danger btn-sm" onclick="eliminarPlantilla(\''+id+'\')">üóëÔ∏è</button><button class="btn btn-secondary" onclick="cerrarModal(\'modalPlantilla\')">Cerrar</button><button class="btn btn-primary" onclick="usarPlantillaDirecta(\''+id+'\')">üì• Usar con alumno</button>';
            abrirModal('modalPlantilla');
        }
        
        function usarPlantillaDirecta(id){
            cerrarModal('modalPlantilla');
            if(!alumnoActual){
                // Seleccionar alumno
                const ids=Object.keys(alumnos);
                if(!ids.length){toast('Crea un alumno primero','error');return;}
                let h='<div class="form-group"><label class="form-label">Selecciona alumno:</label><select class="form-select" id="selAlumnoPlantilla">';
                ids.forEach(aid=>{h+='<option value="'+aid+'">'+alumnos[aid].siglas+' - '+alumnos[aid].curso+'</option>';});
                h+='</select></div>';
                document.getElementById('modalPlantillaBody').innerHTML=h;
                document.getElementById('modalPlantillaTitulo').textContent='Seleccionar alumno';
                document.getElementById('modalPlantillaFooter').innerHTML='<button class="btn btn-secondary" onclick="cerrarModal(\'modalPlantilla\')">Cancelar</button><button class="btn btn-primary" onclick="asignarPlantillaAlumno(\''+id+'\')">Asignar</button>';
                abrirModal('modalPlantilla');
            }else{
                asignarPlantilla(id,alumnoActual);
            }
        }
        
        function asignarPlantillaAlumno(pid){
            const aid=document.getElementById('selAlumnoPlantilla').value;
            cerrarModal('modalPlantilla');
            asignarPlantilla(pid,aid);
        }
        
        function asignarPlantilla(pid,aid){
            const p=plantillas[pid],a=alumnos[aid];
            if(!p||!a)return;
            const newPid='p_'+Date.now();
            const programa={tipo:p.tipo,objetivos:JSON.parse(JSON.stringify(p.objetivos))};
            db.ref('gestorpe/alumnos/'+aid+'/programas/'+newPid).set(programa).then(()=>{
                a.programas=a.programas||{};
                a.programas[newPid]=programa;
                const nueva=generarProgramacion(a);
                return db.ref('gestorpe/alumnos/'+aid+'/programacion').set(nueva);
            }).then(()=>{
                toast('Plantilla asignada a '+a.siglas,'success');
                if(alumnoActual===aid){renderProgs();renderProg();}
            });
        }
        
        function eliminarPlantilla(id){
            if(!confirm('¬øEliminar plantilla?'))return;
            db.ref('gestorpe/plantillas/'+id).remove().then(()=>{
                cerrarModal('modalPlantilla');
                toast('Eliminada','success');
            });
        }
        
        function cargarPlantillasBase(){
            if(!confirm('¬øCargar '+PLANTILLAS_BASE.length+' plantillas predefinidas?\nSe a√±adir√°n a tu biblioteca.'))return;
            const updates={};
            PLANTILLAS_BASE.forEach(p=>{
                const id='pl_'+p.ciclo+'_'+p.tipo+'_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
                updates['gestorpe/plantillas/'+id]=p;
            });
            db.ref().update(updates).then(()=>{
                toast(PLANTILLAS_BASE.length+' plantillas cargadas','success');
            });
        }
        
        function abrirModalNuevaPlantilla(){
            document.getElementById('plantillaNombre').value='';
            document.getElementById('plantillaTexto').value='';
            document.getElementById('uploadZonePlantilla').innerHTML='üìÑ Toca para seleccionar';
            document.getElementById('uploadZonePlantilla').classList.remove('has-file');
            document.getElementById('previewPlantillaNueva').style.display='none';
            document.getElementById('btnGuardarPlantilla').disabled=true;
            document.getElementById('inputFilePlantilla').value='';
            docExtraidoPlantilla=null;
            abrirModal('modalNuevaPlantilla');
        }
        
        async function cargarDocxPlantilla(inp){
            const f=inp.files[0];if(!f)return;
            document.getElementById('uploadZonePlantilla').innerHTML='üìÑ '+f.name;
            document.getElementById('uploadZonePlantilla').classList.add('has-file');
            try{const r=await mammoth.extractRawText({arrayBuffer:await f.arrayBuffer()});document.getElementById('plantillaTexto').value=r.value;}catch(e){toast('Error','error');}
        }
        
        function analizarTextoPlantilla(){
            const t=document.getElementById('plantillaTexto').value;
            if(t.length<20){toast('Pega m√°s contenido','error');return;}
            const objs=extraerObjetivos(t);
            if(!objs.length){toast('No se encontraron objetivos','error');return;}
            docExtraidoPlantilla=objs;
            document.getElementById('previewPlantillaNueva').innerHTML='‚úì '+objs.length+' objetivos encontrados';
            document.getElementById('previewPlantillaNueva').style.display='block';
            document.getElementById('btnGuardarPlantilla').disabled=false;
        }
        
        function guardarNuevaPlantilla(){
            const nombre=document.getElementById('plantillaNombre').value.trim();
            if(!nombre){toast('Introduce nombre','error');return;}
            if(!docExtraidoPlantilla||!docExtraidoPlantilla.length){toast('Analiza el texto primero','error');return;}
            const ciclo=document.getElementById('plantillaCiclo').value;
            const tipo=document.getElementById('plantillaArea').value;
            const id='pl_'+Date.now();
            db.ref('gestorpe/plantillas/'+id).set({
                nombre:nombre,
                ciclo:ciclo,
                tipo:tipo,
                objetivos:docExtraidoPlantilla
            }).then(()=>{
                cerrarModal('modalNuevaPlantilla');
                toast('Plantilla guardada','success');
            });
        }

        // ALUMNOS
        function abrirModalNuevo(){document.getElementById('nuevoSiglas').value='';diasSel=[1,3,4];actualizarDiasBtns();abrirModal('modalNuevo');}
        function toggleDia(d){const idx=diasSel.indexOf(d);if(idx>-1){if(diasSel.length>1)diasSel.splice(idx,1);}else{diasSel.push(d);diasSel.sort((a,b)=>a-b);}actualizarDiasBtns();}
        function actualizarDiasBtns(){document.querySelectorAll('#diasBtns .dia-btn').forEach(btn=>{btn.classList.toggle('active',diasSel.includes(parseInt(btn.dataset.dia)));});}
        function crearAlumno(){const siglas=document.getElementById('nuevoSiglas').value.trim().toUpperCase();if(!siglas){toast('Introduce siglas','error');return;}const cursoSel=document.getElementById('nuevoCurso'),cursoTexto=cursoSel.options[cursoSel.selectedIndex].text,ciclo=cursoSel.value;db.ref('gestorpe/alumnos').push().set({siglas:siglas,curso:cursoTexto,ciclo:ciclo,diasSesion:diasSel.slice(),programas:{},programacion:{},evaluaciones:{},ausencias:{},sincole:{},resultados:{},pasados:{}}).then(()=>{cerrarModal('modalNuevo');toast(siglas+' creado ‚úì','success');});}
        
        function abrirAlumno(id){alumnoActual=id;mesActual=0;evalTrim=1;document.getElementById('screenInicio').classList.remove('active');document.getElementById('screenAlumno').classList.add('active');const a=alumnos[id],diasStr=(a.diasSesion||[0,2,4]).map(d=>DIAS_C[d]).join('-');document.getElementById('alumnoHeader').innerHTML='<div class="alumno-header-siglas">'+a.siglas+'</div><div><h2 style="font-size:.95rem">'+a.curso+'</h2><p style="color:var(--text-light);font-size:.75rem">'+diasStr+'</p></div><div style="margin-left:auto" class="btn-group no-print"><button class="btn btn-secondary btn-sm" onclick="volverInicio()">‚Üê Volver</button><button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è</button><button class="btn btn-danger btn-sm" onclick="eliminarAlumno(\''+id+'\')">üóëÔ∏è</button></div>';document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===0));document.querySelectorAll('.tab-content').forEach((c,i)=>c.classList.toggle('active',i===0));renderProgs();renderProg();renderEval();renderAsis();}
        function volverInicio(){alumnoActual=null;document.getElementById('screenAlumno').classList.remove('active');document.getElementById('screenInicio').classList.add('active');}
        function cambiarTab(t){document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');if(t==='asistencia')setTimeout(renderAsisCharts,100);if(t==='evaluacion')setTimeout(renderEvalCharts,100);}
        function eliminarAlumno(id){if(confirm('¬øEliminar alumno?')){db.ref('gestorpe/alumnos/'+id).remove();volverInicio();toast('Eliminado','success');}}

        // PROGRAMAS
        function renderProgs(){const a=alumnos[alumnoActual];let h='<div class="card"><div class="card-header"><h3 class="card-title">üìÑ Programas</h3><button class="btn btn-primary btn-sm no-print" onclick="abrirModalAddProg()">‚ûï</button></div>';if(!a.programas||!Object.keys(a.programas).length){h+='<div class="empty-state">Sin programas. A√±ade uno desde biblioteca o manualmente.</div>';}else{Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{icon:'üìÑ',nombre:p.tipo,color:'#666'};h+='<div class="programa-card" style="border-left-color:'+info.color+'"><div class="programa-header"><span class="programa-titulo">'+info.icon+' '+info.nombre+'</span><button class="btn btn-danger btn-sm no-print" onclick="elimProg(\''+pId+'\')">üóëÔ∏è</button></div>';(p.objetivos||[]).forEach(obj=>{h+='<div class="objetivo-card"><div class="objetivo-header"><span class="objetivo-num">O'+obj.numero+'</span><span class="trimestre-badge t'+obj.trimestre+'">T'+obj.trimestre+'</span></div><div class="objetivo-desc">'+obj.descripcion+'</div>';if(obj.indicadores&&obj.indicadores.length){h+='<ul class="indicadores-list">'+obj.indicadores.map(x=>'<li>‚Ä¢ '+x+'</li>').join('')+'</ul>';}h+='</div>';});h+='</div>';});}h+='<div class="btn-group no-print" style="margin-top:12px"><button class="btn btn-secondary btn-sm" onclick="regenerarProg()">üîÑ Regenerar</button><button class="btn btn-ai btn-sm" onclick="generarPromptIA()">ü§ñ IA</button><button class="btn btn-warning btn-sm" onclick="abrirModal(\'modalImportJSON\')">üì• JSON</button></div></div>';document.getElementById('tabProgramas').innerHTML=h;}
        
        function abrirModalAddProg(){
            // Cargar plantillas del ciclo del alumno
            const a=alumnos[alumnoActual];
            const cicloAlumno=a.ciclo||'ciclo1';
            const sel=document.getElementById('selPlantilla');
            sel.innerHTML='<option value="">-- Elegir plantilla --</option>';
            Object.keys(plantillas).forEach(id=>{
                const p=plantillas[id];
                if(p.ciclo===cicloAlumno){
                    const area=AREAS[p.tipo]||{icon:'üìÑ'};
                    sel.innerHTML+='<option value="'+id+'">'+area.icon+' '+p.nombre+'</option>';
                }
            });
            document.getElementById('previewPlantilla').style.display='none';
            document.getElementById('addProgTipo').value='';
            document.getElementById('addProgTexto').value='';
            document.getElementById('uploadZone').innerHTML='üìÑ Toca para seleccionar';
            document.getElementById('uploadZone').classList.remove('has-file');
            document.getElementById('previewProg').style.display='none';
            document.getElementById('zonaDocx').style.display='block';
            document.getElementById('zonaLecto').style.display='none';
            document.getElementById('inputFile').value='';
            docExtraido=null;
            abrirModal('modalAddProg');
        }
        
        function previsualizarPlantilla(){
            const id=document.getElementById('selPlantilla').value;
            if(!id){document.getElementById('previewPlantilla').style.display='none';return;}
            const p=plantillas[id];
            if(!p)return;
            const nObj=p.objetivos?p.objetivos.length:0;
            const nInd=p.objetivos?p.objetivos.reduce((s,o)=>s+(o.indicadores?o.indicadores.length:0),0):0;
            document.getElementById('previewPlantilla').innerHTML='<strong>'+p.nombre+'</strong><br>'+nObj+' objetivos ¬∑ '+nInd+' indicadores<br><small>T1: '+p.objetivos.filter(o=>o.trimestre===1).length+' obj | T2: '+p.objetivos.filter(o=>o.trimestre===2).length+' obj | T3: '+p.objetivos.filter(o=>o.trimestre===3).length+' obj</small>';
            document.getElementById('previewPlantilla').style.display='block';
        }
        
        function cambioTipoProg(){const t=document.getElementById('addProgTipo').value;document.getElementById('zonaDocx').style.display=t==='lectoescritura'?'none':'block';document.getElementById('zonaLecto').style.display=t==='lectoescritura'?'block':'none';}
        async function cargarDocx(inp){const f=inp.files[0];if(!f)return;document.getElementById('uploadZone').innerHTML='üìÑ '+f.name;document.getElementById('uploadZone').classList.add('has-file');try{const r=await mammoth.extractRawText({arrayBuffer:await f.arrayBuffer()});procesarTexto(r.value);}catch(e){toast('Error','error');}}
        function analizarTexto(){const t=document.getElementById('addProgTexto').value;if(t.length<20){toast('Pega m√°s contenido','error');return;}procesarTexto(t);}
        function procesarTexto(txt){const objs=extraerObjetivos(txt);if(!objs.length){toast('No se encontraron objetivos','error');return;}docExtraido=objs;document.getElementById('previewProg').innerHTML='‚úì '+objs.length+' objetivos';document.getElementById('previewProg').style.display='block';}
        function extraerObjetivos(txt){const objs=[],lineas=txt.split('\n');let actual=null,seccion=null;for(let i=0;i<lineas.length;i++){const lt=lineas[i].trim();if(!lt)continue;const m=lt.match(/^OBJETIVO\s*(\d+)[.:]\s*(.+)?/i)||lt.match(/^(\d+)[.\-)\s]+(.{15,})/);if(m){if(actual)objs.push(actual);actual={numero:parseInt(m[1]),descripcion:(m[2]||'').trim(),indicadores:[],trimestre:1};seccion=null;continue;}if(lt.toUpperCase().indexOf('INDICADOR')>-1){seccion='indicadores';continue;}if(actual&&seccion==='indicadores'&&lt.length>5){const ind=lt.replace(/^[-‚Ä¢¬∑‚ñ™‚ñ∫‚óè‚óã‚ó¶‚Ä£‚ÅÉ*]\s*/,'').trim();if(ind.length>5)actual.indicadores.push(ind);}}if(actual)objs.push(actual);const n=objs.length,p=Math.ceil(n/3);objs.forEach((o,i)=>{o.trimestre=i<p?1:(i<p*2?2:3);if(!o.indicadores.length)o.indicadores=['Indicador de '+o.descripcion.substring(0,20)];});return objs;}
        
        function addPrograma(){
            // Primero comprobar si se seleccion√≥ plantilla
            const plantillaId=document.getElementById('selPlantilla').value;
            if(plantillaId){
                asignarPlantilla(plantillaId,alumnoActual);
                cerrarModal('modalAddProg');
                return;
            }
            // Si no, proceso manual
            const tipo=document.getElementById('addProgTipo').value;
            if(!tipo){toast('Selecciona tipo o plantilla','error');return;}
            const objetivos=tipo==='lectoescritura'?LECTO:docExtraido;
            if(!objetivos||!objetivos.length){toast('Sin objetivos','error');return;}
            const a=alumnos[alumnoActual],pId='p_'+Date.now();
            db.ref('gestorpe/alumnos/'+alumnoActual+'/programas/'+pId).set({tipo:tipo,objetivos:objetivos}).then(()=>{
                a.programas=a.programas||{};
                a.programas[pId]={tipo:tipo,objetivos:objetivos};
                const nueva=generarProgramacion(a);
                return db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(nueva);
            }).then(()=>{cerrarModal('modalAddProg');renderProgs();renderProg();toast('Programa a√±adido ‚úì','success');}).catch(e=>{toast('Error: '+e.message,'error');});
        }
        
        function elimProg(pId){if(!confirm('¬øEliminar?'))return;db.ref('gestorpe/alumnos/'+alumnoActual+'/programas/'+pId).remove().then(()=>{delete alumnos[alumnoActual].programas[pId];return db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(generarProgramacion(alumnos[alumnoActual]));}).then(()=>{renderProgs();renderProg();toast('Eliminado','success');});}

        // PROGRAMACI√ìN
        function getIndicadoresPasados(a,trim){const pasados=a.pasados||{},result=[];Object.keys(pasados).forEach(k=>{if(pasados[k]===trim){const parts=k.split('_');result.push({pId:parts[0],oIdx:parseInt(parts[1]),iIdx:parseInt(parts[2]),key:k});}});return result;}
        
        function getTodasLasSesiones(a){const dias=a.diasSesion||[1,3,4],keys=[];for(let mi=0;mi<MESES.length;mi++){const m=MESES[mi];for(let s=1;s<=m.semanas;s++){for(let di=0;di<dias.length;di++){keys.push(mi+'_'+s+'_'+dias[di]);}}}return keys;}
        
        function generarProgramacion(a){const prog={};if(!a.programas)return prog;const pIds=Object.keys(a.programas);if(!pIds.length)return prog;const todasSesiones=getTodasLasSesiones(a);const sesionesPorTrim={1:0,2:0,3:0};todasSesiones.forEach(k=>{const mi=parseInt(k.split('_')[0]);sesionesPorTrim[MESES[mi].trim]++;});const poolT={1:[],2:[],3:[]};pIds.forEach(pId=>{const p=a.programas[pId];(p.objetivos||[]).forEach((o,oi)=>{const trim=o.trimestre||1;(o.indicadores||['Indicador']).forEach((_,ii)=>{poolT[trim].push({pId:pId,oIdx:oi,iIdx:ii});});});});[2,3].forEach(t=>{getIndicadoresPasados(a,t).forEach(p=>poolT[t].push({pId:p.pId,oIdx:p.oIdx,iIdx:p.iIdx}));});[1,2,3].forEach(t=>{if(poolT[t].length<2)return;const porProg={};poolT[t].forEach(item=>{if(!porProg[item.pId])porProg[item.pId]=[];porProg[item.pId].push(item);});const pIdsEnPool=Object.keys(porProg);if(pIdsEnPool.length<2)return;const nuevo=[];let maxLen=Math.max(...pIdsEnPool.map(id=>porProg[id].length));for(let i=0;i<maxLen;i++){pIdsEnPool.forEach(id=>{if(porProg[id][i])nuevo.push(porProg[id][i]);});}poolT[t]=nuevo;});[1,2,3].forEach(t=>{if(!poolT[t].length)return;const sesiones=sesionesPorTrim[t];while(poolT[t].length<sesiones){const original=[...poolT[t]];for(let i=0;i<original.length&&poolT[t].length<sesiones;i++){poolT[t].push({...original[i]});}}});let idxT={1:0,2:0,3:0};todasSesiones.forEach(k=>{const mi=parseInt(k.split('_')[0]);const trim=MESES[mi].trim;const pool=poolT[trim];if(!pool.length)return;prog[k]=pool[idxT[trim]%pool.length];idxT[trim]++;});return prog;}
        
        function regenerarProg(){const a=alumnos[alumnoActual];if(!a.programas||!Object.keys(a.programas).length){toast('A√±ade un programa','error');return;}const nueva=generarProgramacion(a);db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(nueva).then(()=>{a.programacion=nueva;renderProg();toast('Regenerado: '+Object.keys(nueva).length+' sesiones','success');});}
        
        function reajustarDesde(a,desdeClave){const todasSesiones=getTodasLasSesiones(a);const idx=todasSesiones.indexOf(desdeClave);if(idx<0)return a.programacion;const nueva={...a.programacion};for(let i=todasSesiones.length-1;i>idx;i--){const keyActual=todasSesiones[i];const keyAnterior=todasSesiones[i-1];if(nueva[keyAnterior]){nueva[keyActual]=nueva[keyAnterior];}}delete nueva[desdeClave];return nueva;}
        
        function insertarRepeticion(a,clave,contenido){const todasSesiones=getTodasLasSesiones(a);const idx=todasSesiones.indexOf(clave);if(idx<0)return a.programacion;const dias=a.diasSesion||[1,3,4];let idxRepetir=idx+dias.length;if(idxRepetir>=todasSesiones.length)idxRepetir=todasSesiones.length-1;const claveRepetir=todasSesiones[idxRepetir];const nueva={...a.programacion};for(let i=todasSesiones.length-1;i>idxRepetir;i--){const keyActual=todasSesiones[i];const keyAnterior=todasSesiones[i-1];if(nueva[keyAnterior]){nueva[keyActual]=nueva[keyAnterior];}}nueva[claveRepetir]=contenido;return nueva;}
        
        function generarPromptIA(){const a=alumnos[alumnoActual];if(!a.programas||!Object.keys(a.programas).length){toast('A√±ade programas primero','error');return;}const dias=a.diasSesion||[1,3,4];const todasSesiones=getTodasLasSesiones(a);let prompt=`Eres un experto en Pedagog√≠a Terap√©utica. Genera una programaci√≥n COMPLETA para TODO el curso escolar 2025/2026 de Granada.\n\nüë§ ALUMNO: ${a.siglas} (${a.curso})\nüìÜ D√çAS: ${dias.map(d=>DIAS_C[d]).join(', ')}\nüìä TOTAL: ${todasSesiones.length} sesiones\n\nüìö PROGRAMAS:\n`;Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};prompt+=`\nüî∑ ${info.nombre} (ID: "${pId}")\n`;(p.objetivos||[]).forEach((obj,oi)=>{prompt+=`  O${obj.numero} (oIdx:${oi}, T${obj.trimestre}): ${obj.descripcion}\n`;(obj.indicadores||[]).forEach((ind,ii)=>{prompt+=`    - iIdx:${ii}: ${ind}\n`;});});});prompt+=`\nüì§ RESPONDE SOLO JSON:\n{"mes_semana_dia": {"pId": "...", "oIdx": N, "iIdx": N}, ...}\n\n‚ö†Ô∏è ${todasSesiones.length} entradas. Alterna programas 50-50. Respeta trimestres.`;navigator.clipboard.writeText(prompt).then(()=>{toast('Prompt copiado','success');window.open('https://chat.openai.com/','_blank');});}
        
        function importarJSON(){const txt=document.getElementById('jsonInput').value.trim();if(!txt){toast('Pega el JSON','error');return;}try{let cleanJSON=txt;if(cleanJSON.includes('```')){cleanJSON=cleanJSON.replace(/```json?\n?/g,'').replace(/```/g,'').trim();}const prog=JSON.parse(cleanJSON);const keys=Object.keys(prog);if(!keys.length)throw new Error('JSON vac√≠o');db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(prog).then(()=>{alumnos[alumnoActual].programacion=prog;cerrarModal('modalImportJSON');document.getElementById('jsonInput').value='';renderProg();toast('Importado: '+keys.length+' sesiones','success');});}catch(e){toast('Error JSON: '+e.message,'error');}}
        
        function renderProg(){const a=alumnos[alumnoActual],dias=a.diasSesion||[1,3,4],noms=dias.map(d=>DIAS_C[d]),mes=MESES[mesActual],st=calcStats(a);let h='<div class="card"><div class="stats-box no-print"><div class="stat-item"><div class="stat-num" style="color:var(--danger)">'+(st.porMes[mesActual]?st.porMes[mesActual].aus:0)+'</div><div class="stat-label">Ausencias</div></div></div><div class="cuadrante-nav no-print"><button class="nav-btn" onclick="cambiarMes(-1)">‚óÄ</button><select class="form-select" style="width:auto" onchange="mesActual=parseInt(this.value);renderProg()">';for(let i=0;i<MESES.length;i++){h+='<option value="'+i+'"'+(i===mesActual?' selected':'')+'>'+MESES[i].nombre+'</option>';}h+='</select><button class="nav-btn" onclick="cambiarMes(1)">‚ñ∂</button><span class="trimestre-badge t'+mes.trim+'">T'+mes.trim+'</span><button class="btn btn-ai btn-sm" onclick="abrirChatGPTCuadrante()">ü§ñ</button></div><div class="leyenda no-print"><div class="leyenda-item"><div class="leyenda-color" style="background:#fee2e2"></div>Ausencia</div><div class="leyenda-item"><div class="leyenda-color" style="background:#e0e7ff"></div>Sin cole</div></div><div style="overflow-x:auto;margin-top:8px"><table class="cuadrante-table"><thead><tr><th>S</th>';for(let i=0;i<noms.length;i++){h+='<th>'+noms[i]+'</th>';}h+='</tr></thead><tbody>';for(let si=0;si<mes.semanas;si++){const sem=si+1;h+='<tr><td>'+sem+'</td>';for(let di=0;di<dias.length;di++){h+=renderCelda(a,mesActual+'_'+sem+'_'+dias[di],dias[di]);}h+='</tr>';}h+='</tbody></table></div></div>';document.getElementById('tabProgramacion').innerHTML=h;}
        
        function renderCelda(a,k,d){const c=a.programacion?a.programacion[k]:null,aus=a.ausencias?a.ausencias[k]:false,sc=a.sincole?a.sincole[k]:false,res=a.resultados?a.resultados[k]:null;let cls='celda',icon='';if(sc){cls+=' celda-sincole';icon='üè´';}else if(aus){cls+=' celda-ausencia';icon='‚ùå';}else if(res==='conseguido'){icon='‚úÖ';}else if(res==='repetir'){icon='üîÑ';}if(!c||!a.programas||!a.programas[c.pId]){return'<td class="'+cls+' celda-vacia" onclick="editarCelda(\''+k+'\','+d+')">'+(icon?'<span class="celda-icon">'+icon+'</span>':'')+'+</td>';}const p=a.programas[c.pId],obj=p.objetivos?p.objetivos[c.oIdx]:null;if(!obj)return'<td class="'+cls+'">?</td>';const info=AREAS[p.tipo]||{color:'#666'},ind=obj.indicadores?(obj.indicadores[c.iIdx]||''):'';return'<td class="'+cls+'" onclick="editarCelda(\''+k+'\','+d+')">'+(icon?'<span class="celda-icon">'+icon+'</span>':'')+'<div class="celda-obj" style="color:'+info.color+'">O'+obj.numero+'</div><div class="celda-ind">'+ind.substring(0,25)+(ind.length>25?'...':'')+'</div></td>';}
        function cambiarMes(dir){mesActual=Math.max(0,Math.min(9,mesActual+dir));renderProg();}
        
        function editarCelda(k,d){celdaEditando=k;estadoCelda='asiste';resultadoCelda=null;const a=alumnos[alumnoActual],c=a.programacion?a.programacion[k]:{};document.getElementById('celdaTitulo').textContent=DIAS[d];document.querySelectorAll('.asist-btn').forEach(b=>b.classList.remove('selected'));document.querySelectorAll('.resultado-btn').forEach(b=>b.classList.remove('selected'));if(a.sincole&&a.sincole[k]){estadoCelda='sincole';document.querySelector('.asist-btn.sincole').classList.add('selected');document.getElementById('contenidoSesion').style.display='none';}else if(a.ausencias&&a.ausencias[k]){estadoCelda='ausencia';document.querySelector('.asist-btn.ausencia').classList.add('selected');document.getElementById('contenidoSesion').style.display='none';}else{document.querySelector('.asist-btn.asiste').classList.add('selected');document.getElementById('contenidoSesion').style.display='block';}resultadoCelda=(a.resultados&&a.resultados[k])?a.resultados[k]:null;if(resultadoCelda){const btn=document.querySelector('.resultado-btn.'+resultadoCelda);if(btn)btn.classList.add('selected');}const sel=document.getElementById('selPrograma');sel.innerHTML='<option value="">-</option>';if(a.programas){Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{icon:'üìÑ'};sel.innerHTML+='<option value="'+pId+'"'+(c.pId===pId?' selected':'')+'>'+info.icon+' '+(info.nombre||p.tipo)+'</option>';});}if(c.pId){cargarObjetivos();setTimeout(()=>{document.getElementById('selObjetivo').value=c.oIdx!==undefined?c.oIdx:'';cargarIndicadores();setTimeout(()=>{document.getElementById('selIndicador').value=c.iIdx!==undefined?c.iIdx:'';},30);},30);}else{document.getElementById('selObjetivo').innerHTML='<option value="">-</option>';document.getElementById('selIndicador').innerHTML='<option value="">-</option>';}abrirModal('modalCelda');}
        
        function setEstado(e,btn){estadoCelda=e;document.querySelectorAll('.asist-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');document.getElementById('contenidoSesion').style.display=e==='asiste'?'block':'none';}
        function setResultado(r,btn){if(resultadoCelda===r){resultadoCelda=null;btn.classList.remove('selected');}else{resultadoCelda=r;document.querySelectorAll('.resultado-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');}}
        function cargarObjetivos(){const a=alumnos[alumnoActual],pId=document.getElementById('selPrograma').value,sel=document.getElementById('selObjetivo');sel.innerHTML='<option value="">-</option>';document.getElementById('selIndicador').innerHTML='<option value="">-</option>';if(!pId||!a.programas||!a.programas[pId])return;a.programas[pId].objetivos.forEach((o,i)=>{sel.innerHTML+='<option value="'+i+'">O'+o.numero+': '+o.descripcion.substring(0,20)+'...</option>';});}
        function cargarIndicadores(){const a=alumnos[alumnoActual],pId=document.getElementById('selPrograma').value,oIdx=document.getElementById('selObjetivo').value,sel=document.getElementById('selIndicador');sel.innerHTML='<option value="">-</option>';if(!pId||oIdx==='')return;const inds=a.programas[pId].objetivos[parseInt(oIdx)].indicadores||[];inds.forEach((x,i)=>{sel.innerHTML+='<option value="'+i+'">'+x.substring(0,30)+'...</option>';});}
        
        function guardarCelda(){const a=alumnos[alumnoActual];const updates={};const contenidoActual=a.programacion?a.programacion[celdaEditando]:null;updates['gestorpe/alumnos/'+alumnoActual+'/ausencias/'+celdaEditando]=null;updates['gestorpe/alumnos/'+alumnoActual+'/sincole/'+celdaEditando]=null;updates['gestorpe/alumnos/'+alumnoActual+'/resultados/'+celdaEditando]=null;if(estadoCelda==='ausencia'||estadoCelda==='sincole'){const tipo=estadoCelda==='ausencia'?'ausencias':'sincole';updates['gestorpe/alumnos/'+alumnoActual+'/'+tipo+'/'+celdaEditando]=true;if(contenidoActual){const nuevaProg=reajustarDesde(a,celdaEditando);updates['gestorpe/alumnos/'+alumnoActual+'/programacion']=nuevaProg;toast('Sesi√≥n desplazada ‚úì','success');}}else{const pId=document.getElementById('selPrograma').value;const oIdx=document.getElementById('selObjetivo').value;const iIdx=document.getElementById('selIndicador').value;if(pId&&oIdx!==''){const nuevoContenido={pId:pId,oIdx:parseInt(oIdx),iIdx:iIdx!==''?parseInt(iIdx):0};updates['gestorpe/alumnos/'+alumnoActual+'/programacion/'+celdaEditando]=nuevoContenido;if(resultadoCelda==='repetir'){const nuevaProg=insertarRepeticion(a,celdaEditando,nuevoContenido);updates['gestorpe/alumnos/'+alumnoActual+'/programacion']=nuevaProg;toast('Repetida pr√≥xima semana ‚úì','success');}}if(resultadoCelda){updates['gestorpe/alumnos/'+alumnoActual+'/resultados/'+celdaEditando]=resultadoCelda;}}db.ref().update(updates).then(()=>{cerrarModal('modalCelda');if(!updates['gestorpe/alumnos/'+alumnoActual+'/programacion']){toast('Guardado ‚úì','success');}});}
        
        function borrarCelda(){const updates={};['programacion','ausencias','sincole','resultados'].forEach(t=>{updates['gestorpe/alumnos/'+alumnoActual+'/'+t+'/'+celdaEditando]=null;});db.ref().update(updates).then(()=>{cerrarModal('modalCelda');toast('Eliminado','success');});}
        
        function calcStats(a){const aus=a.ausencias||{},res=a.resultados||{};let ausencias=0,conseguidos=0,repetir=0;const dias=a.diasSesion||[1,3,4],porMes={},porTrim={1:{aus:0},2:{aus:0},3:{aus:0}};for(let mi=0;mi<MESES.length;mi++){const m=MESES[mi];porMes[mi]={aus:0};for(let s=1;s<=m.semanas;s++){for(let di=0;di<dias.length;di++){const k=mi+'_'+s+'_'+dias[di];if(aus[k]){ausencias++;porMes[mi].aus++;porTrim[m.trim].aus++;}if(res[k]==='conseguido')conseguidos++;if(res[k]==='repetir')repetir++;}}}return{ausencias:ausencias,conseguidos:conseguidos,repetir:repetir,porMes:porMes,porTrim:porTrim};}

        // EVALUACI√ìN
        function renderEval(){const a=alumnos[alumnoActual];let h='<div class="card"><div class="card-header"><h3 class="card-title">üìä Evaluaci√≥n</h3></div><div class="btn-group no-print" style="margin-bottom:12px"><button class="btn '+(evalTrim===1?'btn-primary':'btn-secondary')+' btn-sm" onclick="setTrim(1)">T1</button><button class="btn '+(evalTrim===2?'btn-primary':'btn-secondary')+' btn-sm" onclick="setTrim(2)">T2</button><button class="btn '+(evalTrim===3?'btn-primary':'btn-secondary')+' btn-sm" onclick="setTrim(3)">T3</button><button class="btn btn-warning btn-sm" onclick="abrirModalInforme()">üìÑ Informe</button>';if(evalTrim<3){h+='<button class="btn btn-ai btn-sm" onclick="pasarNoConseguidos()">üì§ P/N‚ÜíT'+(evalTrim+1)+'</button>';}h+='</div><div class="chart-container no-print"><canvas id="chartProgreso"></canvas></div><div id="evalList"></div></div>';document.getElementById('tabEvaluacion').innerHTML=h;renderEvalList();setTimeout(renderEvalCharts,100);}
        function setTrim(t){evalTrim=t;renderEval();}
        
        function renderEvalCharts(){const a=alumnos[alumnoActual];if(!a.programas)return;const ctx=document.getElementById('chartProgreso');if(!ctx)return;if(charts.progreso)charts.progreso.destroy();const labels=[],conseguidos=[],proceso=[],noIniciados=[];Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};labels.push(info.nombre.substring(0,12));let c=0,pr=0,n=0;(p.objetivos||[]).forEach((obj,oi)=>{(obj.indicadores||[]).forEach((_,ii)=>{let found=false;for(let t=1;t<=3;t++){const k=pId+'_'+oi+'_'+ii+'_T'+t,e=a.evaluaciones?a.evaluaciones[k]:null;if(e==='C'){c++;found=true;break;}else if(e==='P'){pr++;found=true;break;}else if(e==='N'){n++;found=true;break;}}if(!found)n++;});});conseguidos.push(c);proceso.push(pr);noIniciados.push(n);});charts.progreso=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Conseguido',data:conseguidos,backgroundColor:'#22c55e'},{label:'En proceso',data:proceso,backgroundColor:'#3b82f6'},{label:'No iniciado',data:noIniciados,backgroundColor:'#d1d5db'}]},options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{x:{stacked:true},y:{stacked:true}}}});}
        
        function renderEvalList(){const a=alumnos[alumnoActual],c=document.getElementById('evalList');let h='',hay=false;if(!a.programas){c.innerHTML='<p style="text-align:center;color:var(--text-light)">Sin programas</p>';return;}const pasadosAqui=getIndicadoresPasados(a,evalTrim);Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{icon:'üìÑ',nombre:p.tipo,color:'#666'};const objsT=(p.objetivos||[]).filter(o=>o.trimestre===evalTrim);const pasadosProg=pasadosAqui.filter(x=>x.pId===pId);if(!objsT.length&&!pasadosProg.length)return;hay=true;h+='<div class="programa-card" style="border-left-color:'+info.color+'"><div class="programa-titulo" style="margin-bottom:8px">'+info.icon+' '+info.nombre+'</div>';objsT.forEach(obj=>{const oi=p.objetivos.indexOf(obj);h+='<div style="margin-bottom:8px"><div style="font-weight:600;font-size:.8rem;margin-bottom:4px">O'+obj.numero+': '+obj.descripcion.substring(0,30)+'...</div>';(obj.indicadores||[]).forEach((ind,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';h+='<div class="eval-item"><span class="eval-text">'+ind+'</span><button class="eval-btn c '+(e==='C'?'active':'')+'" onclick="setEval(\''+pId+'\','+oi+','+ii+',\'C\')">‚úì</button><button class="eval-btn p '+(e==='P'?'active':'')+'" onclick="setEval(\''+pId+'\','+oi+','+ii+',\'P\')">‚óê</button><button class="eval-btn n '+(e==='N'?'active':'')+'" onclick="setEval(\''+pId+'\','+oi+','+ii+',\'N\')">‚óã</button></div>';});h+='</div>';});if(pasadosProg.length){h+='<div style="margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)"><div style="font-size:.75rem;color:var(--warning);margin-bottom:6px">üì§ Pasados:</div>';pasadosProg.forEach(item=>{const obj=p.objetivos[item.oIdx];if(!obj)return;const ind=obj.indicadores?obj.indicadores[item.iIdx]:'';const k=pId+'_'+item.oIdx+'_'+item.iIdx+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';h+='<div class="eval-item"><span class="eval-text">O'+obj.numero+': '+ind+'<span class="pasado-badge">T'+(evalTrim-1)+'</span></span><button class="eval-btn c '+(e==='C'?'active':'')+'" onclick="setEval(\''+pId+'\','+item.oIdx+','+item.iIdx+',\'C\')">‚úì</button><button class="eval-btn p '+(e==='P'?'active':'')+'" onclick="setEval(\''+pId+'\','+item.oIdx+','+item.iIdx+',\'P\')">‚óê</button><button class="eval-btn n '+(e==='N'?'active':'')+'" onclick="setEval(\''+pId+'\','+item.oIdx+','+item.iIdx+',\'N\')">‚óã</button></div>';});h+='</div>';}h+='</div>';});c.innerHTML=hay?h:'<p style="text-align:center;color:var(--text-light)">Sin indicadores en T'+evalTrim+'</p>';}
        
        function setEval(pId,oi,ii,e){const a=alumnos[alumnoActual],k=pId+'_'+oi+'_'+ii+'_T'+evalTrim;a.evaluaciones=a.evaluaciones||{};if(a.evaluaciones[k]===e){db.ref('gestorpe/alumnos/'+alumnoActual+'/evaluaciones/'+k).remove();delete a.evaluaciones[k];}else{db.ref('gestorpe/alumnos/'+alumnoActual+'/evaluaciones/'+k).set(e);a.evaluaciones[k]=e;}renderEvalList();setTimeout(renderEvalCharts,100);}
        
        function pasarNoConseguidos(){if(evalTrim>=3){toast('Ya est√°s en T3','error');return;}const a=alumnos[alumnoActual];if(!a.programas){toast('Sin programas','error');return;}const siguienteTrim=evalTrim+1,updates={};let count=0;Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId];(p.objetivos||[]).forEach((obj,oi)=>{if(obj.trimestre!==evalTrim)return;(obj.indicadores||[]).forEach((_,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';if(e!=='C'){const pasadoKey=pId+'_'+oi+'_'+ii;updates['gestorpe/alumnos/'+alumnoActual+'/pasados/'+pasadoKey]=siguienteTrim;count++;}});});});const pasadosActuales=getIndicadoresPasados(a,evalTrim);pasadosActuales.forEach(item=>{const k=item.pId+'_'+item.oIdx+'_'+item.iIdx+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';if(e!=='C'){updates['gestorpe/alumnos/'+alumnoActual+'/pasados/'+item.key]=siguienteTrim;count++;}});if(count===0){toast('¬°Todo conseguido!','success');return;}db.ref().update(updates).then(()=>{const nueva=generarProgramacion(alumnos[alumnoActual]);return db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(nueva);}).then(()=>{toast(count+' ‚Üí T'+siguienteTrim,'success');evalTrim=siguienteTrim;renderEval();renderProg();});}

        // RESUMEN
        function renderAsis(){const a=alumnos[alumnoActual],st=calcStats(a);let totalC=0,totalP=0,totalN=0;if(a.evaluaciones){Object.keys(a.evaluaciones).forEach(k=>{const e=a.evaluaciones[k];if(e==='C')totalC++;else if(e==='P')totalP++;else if(e==='N')totalN++;});}document.getElementById('tabAsistencia').innerHTML='<div class="card"><div class="card-header"><h3 class="card-title">üìà Resumen</h3></div><div class="stats-box"><div class="stat-item"><div class="stat-num" style="color:var(--danger)">'+st.ausencias+'</div><div class="stat-label">Ausencias</div></div><div class="stat-item"><div class="stat-num" style="color:var(--success)">'+st.conseguidos+'</div><div class="stat-label">Sesiones OK</div></div><div class="stat-item"><div class="stat-num" style="color:var(--warning)">'+st.repetir+'</div><div class="stat-label">Repetir</div></div></div><div class="stats-box"><div class="stat-item"><div class="stat-num" style="color:var(--success)">'+totalC+'</div><div class="stat-label">Conseguidos</div></div><div class="stat-item"><div class="stat-num" style="color:var(--proceso)">'+totalP+'</div><div class="stat-label">En proceso</div></div><div class="stat-item"><div class="stat-num" style="color:gray">'+totalN+'</div><div class="stat-label">No iniciados</div></div></div><div class="chart-container"><canvas id="chartAusTrim"></canvas></div></div>';setTimeout(renderAsisCharts,100);}
        
        function renderAsisCharts(){const a=alumnos[alumnoActual],st=calcStats(a);const ctx1=document.getElementById('chartAusTrim');if(ctx1){if(charts.ausTrim)charts.ausTrim.destroy();charts.ausTrim=new Chart(ctx1,{type:'bar',data:{labels:['T1','T2','T3'],datasets:[{label:'Ausencias',data:[st.porTrim[1].aus,st.porTrim[2].aus,st.porTrim[3].aus],backgroundColor:'#ef4444'}]},options:{responsive:true,plugins:{legend:{display:false},title:{display:true,text:'Ausencias por trimestre'}}}});}}

        // INFORMES
        function abrirModalInforme(){document.getElementById('informeTrim').value=evalTrim;document.getElementById('informePreview').style.display='none';document.getElementById('btnImprimirInforme').style.display='none';informeData=null;abrirModal('modalInforme');}
        
        function generarInforme(){const trim=parseInt(document.getElementById('informeTrim').value),a=alumnos[alumnoActual],st=calcStats(a);const conseguidos=[],proceso=[],noIniciados=[];if(a.programas){Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};(p.objetivos||[]).forEach((obj,oi)=>{(obj.indicadores||[]).forEach((ind,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+trim,e=a.evaluaciones?a.evaluaciones[k]:null,item={programa:info.nombre,objetivo:'O'+obj.numero,indicador:ind};if(e==='C')conseguidos.push(item);else if(e==='P')proceso.push(item);else noIniciados.push(item);});});});}informeData={alumno:a,trim:trim,conseguidos:conseguidos,proceso:proceso,noIniciados:noIniciados,ausencias:st.porTrim[trim]?st.porTrim[trim].aus:0};const total=conseguidos.length+proceso.length+noIniciados.length,porcC=total?Math.round(conseguidos.length/total*100):0;document.getElementById('informePreview').innerHTML='<h4>T'+trim+' - '+a.siglas+'</h4><p>‚úÖ '+conseguidos.length+' ('+porcC+'%) | üîÑ '+proceso.length+' | ‚≠ï '+noIniciados.length+' | ‚ùå '+informeData.ausencias+' aus.</p>';document.getElementById('informePreview').style.display='block';document.getElementById('btnImprimirInforme').style.display='inline-flex';toast('Generado','success');}
        
        function abrirChatGPTInforme(){const trim=parseInt(document.getElementById('informeTrim').value),a=alumnos[alumnoActual],st=calcStats(a);const conseguidos=[],proceso=[],noIniciados=[];if(a.programas){Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};(p.objetivos||[]).forEach((obj,oi)=>{(obj.indicadores||[]).forEach((ind,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+trim,e=a.evaluaciones?a.evaluaciones[k]:null,item=info.nombre+': '+ind;if(e==='C')conseguidos.push(item);else if(e==='P')proceso.push(item);else noIniciados.push(item);});});});}const prompt='Valoraci√≥n PT para informe.\n\nALUMNO: '+a.siglas+' ('+a.curso+')\nTRIMESTRE: '+trim+'\n\nCONSEGUIDOS ('+conseguidos.length+'):\n'+(conseguidos.slice(0,10).join('\n')||'Ninguno')+'\n\nEN PROCESO ('+proceso.length+'):\n'+(proceso.slice(0,10).join('\n')||'Ninguno')+'\n\nAUSENCIAS: '+(st.porTrim[trim]?st.porTrim[trim].aus:0)+'\n\nEscribe 2-3 p√°rrafos profesionales.';navigator.clipboard.writeText(prompt).then(()=>{toast('Copiado','success');window.open('https://chat.openai.com/','_blank');});}
        
        function abrirChatGPTCuadrante(){const a=alumnos[alumnoActual],dias=a.diasSesion||[1,3,4],mes=MESES[mesActual];let tabla=a.siglas+' - '+mes.nombre+'\n';for(let si=0;si<mes.semanas;si++){const sem=si+1;let fila='S'+sem+': ';dias.forEach(d=>{const k=mesActual+'_'+sem+'_'+d,c=a.programacion?a.programacion[k]:null;if(c&&a.programas&&a.programas[c.pId]){const p=a.programas[c.pId],obj=p.objetivos?p.objetivos[c.oIdx]:null;if(obj){const ind=obj.indicadores?(obj.indicadores[c.iIdx]||''):'';fila+='O'+obj.numero+':'+ind.substring(0,10)+' | ';}else{fila+='- | ';}}else{fila+='- | ';}});tabla+=fila+'\n';}const prompt='Cuadrante bonito para imprimir:\n\n'+tabla;navigator.clipboard.writeText(prompt).then(()=>{toast('Copiado','success');window.open('https://chat.openai.com/','_blank');});}
        
        function imprimirInforme(){if(!informeData)return;const a=informeData.alumno,win=window.open('','_blank');win.document.write('<!DOCTYPE html><html><head><title>Informe</title><style>body{font-family:Arial;padding:30px;max-width:800px;margin:0 auto}h1{color:#1a5f4a}h2{margin-top:20px}.indicador{margin:5px 0 5px 20px}</style></head><body><h1>INFORME T'+informeData.trim+' - '+a.siglas+'</h1><p>Curso: '+a.curso+' | Fecha: '+new Date().toLocaleDateString('es-ES')+'</p><h2>‚úÖ Conseguidos ('+informeData.conseguidos.length+')</h2>'+(informeData.conseguidos.map(x=>'<p class="indicador">‚Ä¢ '+x.programa+': '+x.indicador+'</p>').join('')||'<p>Ninguno</p>')+'<h2>üîÑ En Proceso ('+informeData.proceso.length+')</h2>'+(informeData.proceso.map(x=>'<p class="indicador">‚Ä¢ '+x.programa+': '+x.indicador+'</p>').join('')||'<p>Ninguno</p>')+'<h2>‚≠ï No Iniciados ('+informeData.noIniciados.length+')</h2>'+(informeData.noIniciados.map(x=>'<p class="indicador">‚Ä¢ '+x.programa+': '+x.indicador+'</p>').join('')||'<p>Ninguno</p>')+'<p style="margin-top:40px">Fdo: _______________</p></body></html>');win.document.close();setTimeout(()=>{win.print();},300);}

        // IMPRESI√ìN MASIVA
        function abrirModalImprimir(){if(!Object.keys(alumnos).length){toast('No hay alumnos','error');return;}abrirModal('modalImprimir');}
        
        function imprimirTodos(){const mesSeleccionado=parseInt(document.getElementById('printMes').value);const ids=Object.keys(alumnos);let html='<!DOCTYPE html><html><head><title>Programaciones</title><style>body{font-family:Arial;padding:20px;font-size:11px}h1{color:#1a5f4a;font-size:16px}h2{font-size:14px;border-bottom:2px solid #1a5f4a}table{width:100%;border-collapse:collapse;margin-bottom:15px}th,td{border:1px solid #ccc;padding:6px}th{background:#1a5f4a;color:#fff}td:first-child{background:#2d8a6e;color:#fff;text-align:center;width:50px}.page-break{page-break-after:always}</style></head><body>';ids.forEach((id,idx)=>{const a=alumnos[id],dias=a.diasSesion||[1,3,4];html+='<div'+(idx<ids.length-1?' class="page-break"':'')+'><h1>'+a.siglas+' - '+a.curso+'</h1>';const mesesAImprimir=mesSeleccionado===-1?MESES.map((_,i)=>i):[mesSeleccionado];mesesAImprimir.forEach(mi=>{const mes=MESES[mi];html+='<h2>'+mes.nombre+' (T'+mes.trim+')</h2><table><tr><th>S</th>';dias.forEach(d=>{html+='<th>'+DIAS_C[d]+'</th>';});html+='</tr>';for(let s=1;s<=mes.semanas;s++){html+='<tr><td>'+s+'</td>';dias.forEach(d=>{const k=mi+'_'+s+'_'+d,c=a.programacion?a.programacion[k]:null;if(c&&a.programas&&a.programas[c.pId]){const p=a.programas[c.pId],obj=p.objetivos?p.objetivos[c.oIdx]:null;if(obj){const ind=obj.indicadores?(obj.indicadores[c.iIdx]||''):'';html+='<td><b>O'+obj.numero+'</b><br>'+ind.substring(0,20)+'</td>';}else{html+='<td>-</td>';}}else{html+='<td>-</td>';}});html+='</tr>';}html+='</table>';});html+='</div>';});html+='</body></html>';const win=window.open('','_blank');win.document.write(html);win.document.close();setTimeout(()=>{win.print();},500);cerrarModal('modalImprimir');toast('Generado','success');}

        // MODALES
        function abrirModal(id){document.getElementById(id).classList.add('active');}
        function cerrarModal(id){document.getElementById(id).classList.remove('active');}
        function toast(msg,tipo){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+(tipo||'');setTimeout(()=>{t.classList.add('show');},10);setTimeout(()=>{t.classList.remove('show');},2500);}
    </script>
</body>
</html>
