<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a5f4a">
    <title>Gestor PE</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%232d8a6e'/%3E%3Cstop offset='100%25' stop-color='%231a5f4a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='110' fill='url(%23bg)'/%3E%3Crect x='100' y='70' width='220' height='300' rx='20' fill='white'/%3E%3Ccircle cx='160' cy='140' r='16' fill='%2322c55e'/%3E%3Cpath d='M152 140l6 6 12-12' stroke='white' stroke-width='4' fill='none' stroke-linecap='round'/%3E%3Crect x='195' y='130' width='100' height='18' rx='4' fill='%231a5f4a'/%3E%3Ccircle cx='160' cy='200' r='16' fill='%233b82f6'/%3E%3Crect x='195' y='190' width='80' height='18' rx='4' fill='%231a5f4a'/%3E%3Ccircle cx='370' cy='350' r='100' fill='%23f59e0b'/%3E%3Ccircle cx='370' cy='350' r='80' fill='white'/%3E%3Cpath d='M370 290v60h50' stroke='%231a5f4a' stroke-width='12' stroke-linecap='round' fill='none'/%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Gestor%20PE%22%2C%22short_name%22%3A%22GestorPE%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f5f7f6%22%2C%22theme_color%22%3A%22%231a5f4a%22%7D">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1a5f4a; --primary-light: #2d8a6e; --primary-dark: #134536;
            --bg: #f5f7f6; --bg-card: #ffffff; --text: #1a2a24; --text-light: #5a6b64;
            --border: #d4ddd9; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --proceso: #3b82f6;
            --shadow: 0 4px 20px rgba(26,95,74,0.1); --radius: 16px; --radius-sm: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100dvh; line-height: 1.5; -webkit-tap-highlight-color: transparent; }
        
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .header-logo { display: flex; align-items: center; gap: 10px; }
        .header-icon { width: 38px; height: 38px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .header-icon svg { width: 100%; height: 100%; }
        .header h1 { font-size: 1.15rem; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .status-badge { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--warning); animation: pulse 1.5s infinite; }
        .status-dot.ok { background: var(--success); animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn-header { background: rgba(255,255,255,0.15); border: none; color: white; padding: 6px 10px; border-radius: var(--radius-sm); cursor: pointer; font-family: inherit; font-size: 0.8rem; font-weight: 500; display: none; }
        .btn-header:hover { background: rgba(255,255,255,0.25); }

        .container { max-width: 1200px; margin: 0 auto; padding: 14px; padding-bottom: max(14px, env(safe-area-inset-bottom)); }
        .screen { display: none; }
        .screen.active { display: block; }

        .alumnos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 12px; }
        .alumno-card { background: var(--bg-card); border-radius: var(--radius); padding: 16px 10px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow); border: 2px solid transparent; }
        .alumno-card:hover { transform: translateY(-2px); border-color: var(--primary-light); }
        .alumno-card:active { transform: scale(0.98); }
        .alumno-siglas { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 700; color: var(--primary); margin-bottom: 3px; }
        .alumno-curso { font-size: 0.75rem; color: var(--text-light); }
        .alumno-programas { font-size: 0.65rem; color: var(--primary); margin-top: 4px; }
        .alumno-card-add { background: transparent; border: 2px dashed var(--primary-light); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; color: var(--primary); min-height: 85px; }

        .card { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .card-title { font-size: 1rem; font-weight: 700; color: var(--primary-dark); }

        .tabs { display: flex; gap: 4px; background: var(--bg-card); padding: 4px; border-radius: var(--radius); margin-bottom: 14px; box-shadow: var(--shadow); overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { flex: 1; padding: 9px 8px; border: none; background: transparent; color: var(--text-light); font-family: inherit; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: var(--radius-sm); white-space: nowrap; min-width: fit-content; }
        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.8rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 16px; background: white; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-textarea { min-height: 80px; resize: vertical; }

        .btn { padding: 10px 14px; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 4px; touch-action: manipulation; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: var(--border); cursor: not-allowed; }
        .btn-secondary { background: var(--bg); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
        .btn-ai:hover { background: linear-gradient(135deg, #7c3aed, #4f46e5); }
        .btn-sm { padding: 7px 10px; font-size: 0.75rem; }
        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }

        .area-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        
        .programa-card { background: var(--bg); border-radius: var(--radius-sm); padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .programa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 6px; }
        .programa-titulo { font-weight: 600; font-size: 0.9rem; }

        .objetivo-card { background: white; border-radius: 8px; padding: 10px; margin-bottom: 8px; }
        .objetivo-header { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; flex-wrap: wrap; }
        .objetivo-num { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 600; padding: 2px 5px; border-radius: 4px; background: rgba(26,95,74,0.15); color: var(--primary); }
        .trimestre-badge { font-size: 0.65rem; padding: 2px 5px; border-radius: 4px; font-weight: 600; }
        .trimestre-badge.t1 { background: #8b5cf620; color: #8b5cf6; }
        .trimestre-badge.t2 { background: #06b6d420; color: #06b6d4; }
        .trimestre-badge.t3 { background: #f59e0b20; color: #f59e0b; }
        .objetivo-desc { font-size: 0.8rem; font-weight: 500; }
        .objetivo-section { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); }
        .objetivo-section-title { font-size: 0.65rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 3px; }
        .item-list { list-style: none; font-size: 0.75rem; }
        .item-list li { padding: 2px 0 2px 12px; position: relative; }
        .item-list li::before { content: "‚Ä¢"; position: absolute; left: 0; color: var(--primary); }

        .cuadrante-nav { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .nav-btn { width: 34px; height: 34px; border: 2px solid var(--border); background: white; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .nav-btn:hover { border-color: var(--primary); }

        .cuadrante-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.75rem; }
        .cuadrante-table th, .cuadrante-table td { border: 1px solid var(--border); padding: 5px; text-align: left; vertical-align: top; }
        .cuadrante-table th { background: var(--primary); color: white; font-weight: 600; text-align: center; font-size: 0.7rem; }
        .cuadrante-table td:first-child { background: var(--primary-light); color: white; font-weight: 600; text-align: center; width: 45px; font-size: 0.7rem; }

        .celda { min-height: 50px; cursor: pointer; position: relative; }
        .celda:hover { background: var(--bg); }
        .celda:active { background: #e8f5e9; }
        .celda-vacia { background: #f9fafb; color: var(--text-light); }
        .celda-area { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 3px; }
        .celda-obj { font-weight: 600; color: var(--primary-dark); font-size: 0.7rem; margin-bottom: 2px; }
        .celda-ind { font-size: 0.6rem; color: var(--text); }
        .celda-act { font-size: 0.55rem; color: var(--proceso); font-style: italic; margin-top: 2px; }
        .celda-ausencia { background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 5px, #fee2e2 5px, #fee2e2 10px) !important; }
        .celda-sincole { background: repeating-linear-gradient(45deg, #fefce8, #fefce8 5px, #fef08a 5px, #fef08a 10px) !important; }
        .celda-icon { position: absolute; top: 2px; right: 2px; font-size: 0.6rem; }

        .stats-box { display: flex; gap: 10px; flex-wrap: wrap; padding: 10px; background: var(--bg); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .stat-item { text-align: center; padding: 8px 12px; background: white; border-radius: 8px; min-width: 70px; flex: 1; }
        .stat-num { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .stat-num.ausencias { color: var(--danger); }
        .stat-num.sincole { color: var(--warning); }
        .stat-label { font-size: 0.65rem; color: var(--text-light); }

        .eval-item { display: flex; align-items: center; gap: 6px; padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 5px; flex-wrap: wrap; }
        .eval-text { flex: 1; font-size: 0.8rem; min-width: 140px; }
        .eval-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border); background: white; cursor: pointer; font-size: 0.85rem; }
        .eval-btn.c { border-color: var(--success); color: var(--success); }
        .eval-btn.c.active { background: var(--success); color: white; }
        .eval-btn.p { border-color: var(--proceso); color: var(--proceso); }
        .eval-btn.p.active { background: var(--proceso); color: white; }
        .eval-btn.n { border-color: gray; color: gray; }
        .eval-btn.n.active { background: gray; color: white; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 14px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-card); z-index: 1; }
        .modal-title { font-size: 0.95rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); padding: 0 5px; }
        .modal-body { padding: 16px; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 6px; flex-wrap: wrap; }

        .asistencia-btns { display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap; }
        .asist-btn { flex: 1; padding: 12px 8px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: white; cursor: pointer; text-align: center; font-family: inherit; min-width: 80px; }
        .asist-btn:active { transform: scale(0.98); }
        .asist-btn.selected { border-width: 3px; }
        .asist-btn.asiste.selected { border-color: var(--success); background: rgba(34,197,94,0.1); }
        .asist-btn.no-asiste.selected { border-color: var(--danger); background: rgba(239,68,68,0.1); }
        .asist-btn.sin-cole.selected { border-color: var(--warning); background: rgba(245,158,11,0.1); }
        .asist-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        .asist-text { font-size: 0.7rem; font-weight: 600; }

        .resultado-btns { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .resultado-btn { flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: white; cursor: pointer; text-align: center; font-family: inherit; font-size: 0.8rem; }
        .resultado-btn.selected { border-width: 3px; }
        .resultado-btn.conseguido.selected { border-color: var(--success); background: rgba(34,197,94,0.1); }
        .resultado-btn.noconseguido.selected { border-color: var(--warning); background: rgba(245,158,11,0.1); }

        .alumno-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; flex-wrap: wrap; }
        .alumno-header-siglas { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--primary); background: rgba(26,95,74,0.1); padding: 10px 16px; border-radius: var(--radius); }
        .alumno-header-info h2 { font-size: 0.95rem; }
        .alumno-header-info p { color: var(--text-light); font-size: 0.75rem; }

        .dias-btns { display: flex; gap: 6px; margin-top: 5px; flex-wrap: wrap; }
        .dia-btn { width: 42px; height: 42px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: white; font-family: inherit; font-weight: 600; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .dia-btn:active { transform: scale(0.95); }
        .dia-btn.active { border-color: var(--primary); background: rgba(26,95,74,0.15); color: var(--primary); }

        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius-sm); padding: 20px 14px; text-align: center; cursor: pointer; background: var(--bg); font-size: 0.85rem; }
        .upload-zone:active { background: #e8f5e9; }
        .upload-zone.has-file { border-color: var(--success); background: rgba(34,197,94,0.1); }

        .toast { position: fixed; bottom: max(16px, env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text); color: white; padding: 10px 18px; border-radius: var(--radius-sm); font-weight: 500; font-size: 0.85rem; opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        .empty-state { text-align: center; padding: 25px; color: var(--text-light); }
        .empty-icon { font-size: 2rem; margin-bottom: 6px; opacity: 0.5; }

        .chart-container { background: white; border-radius: var(--radius-sm); padding: 12px; margin-bottom: 12px; }
        .chart-container canvas { max-height: 200px; }

        .config-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; }
        .config-label { font-size: 0.85rem; font-weight: 500; }
        .config-input { width: 200px; }

        .leyenda { display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.7rem; margin-top: 8px; }
        .leyenda-item { display: flex; align-items: center; gap: 4px; }
        .leyenda-color { width: 12px; height: 12px; border-radius: 3px; }

        @media print { .no-print { display: none !important; } }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .alumno-header { flex-direction: column; align-items: flex-start; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-logo">
                <div class="header-icon">
                    <svg viewBox="0 0 100 100"><rect width="100" height="100" rx="22" fill="rgba(255,255,255,0.3)"/><rect x="18" y="12" width="44" height="60" rx="4" fill="white"/><circle cx="30" cy="26" r="4" fill="#22c55e"/><path d="M28 26l1.5 1.5 3-3" stroke="white" stroke-width="1.2" fill="none" stroke-linecap="round"/><rect x="38" y="23" width="20" height="5" rx="1" fill="#1a5f4a"/><circle cx="30" cy="40" r="4" fill="#3b82f6"/><rect x="38" y="37" width="16" height="5" rx="1" fill="#1a5f4a"/><circle cx="72" cy="68" r="22" fill="#f59e0b"/><circle cx="72" cy="68" r="17" fill="white"/><path d="M72 56v12h10" stroke="#1a5f4a" stroke-width="3" stroke-linecap="round" fill="none"/></svg>
                </div>
                <h1>Gestor PE</h1>
            </div>
            <div class="header-right">
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                <button class="btn-header" id="btnConfig" onclick="abrirConfig()">‚öôÔ∏è</button>
                <button class="btn-header" id="btnVolver" onclick="volverInicio()">‚Üê Volver</button>
            </div>
        </div>
    </header>

    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Alumnos</h2>
                    <button class="btn btn-primary btn-sm" onclick="abrirModalNuevoAlumno()">‚ûï Nuevo</button>
                </div>
                <div class="alumnos-grid" id="alumnosGrid"></div>
            </div>
        </div>
    </div>

    <div id="screenAlumno" class="screen">
        <div class="container">
            <div class="alumno-header" id="alumnoHeader"></div>
            <div class="tabs no-print">
                <button class="tab active" onclick="cambiarTab('programas')">üìÑ Programas</button>
                <button class="tab" onclick="cambiarTab('programacion')">üìÖ Programaci√≥n</button>
                <button class="tab" onclick="cambiarTab('evaluacion')">üìä Evaluaci√≥n</button>
                <button class="tab" onclick="cambiarTab('asistencia')">üìà Asistencia</button>
            </div>
            <div id="tabProgramas" class="tab-content active"></div>
            <div id="tabProgramacion" class="tab-content"></div>
            <div id="tabEvaluacion" class="tab-content"></div>
            <div id="tabAsistencia" class="tab-content"></div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="modalNuevoAlumno">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Nuevo Alumno</h3>
                <button class="modal-close" onclick="cerrarModal('modalNuevoAlumno')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Siglas *</label>
                        <input type="text" class="form-input" id="nuevoSiglas" placeholder="M.G.L." maxlength="10" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Curso *</label>
                        <select class="form-select" id="nuevoCurso">
                            <option value="Infantil 3 a√±os">Infantil 3 a√±os</option>
                            <option value="Infantil 4 a√±os">Infantil 4 a√±os</option>
                            <option value="Infantil 5 a√±os" selected>Infantil 5 a√±os</option>
                            <option value="1¬∫ Primaria">1¬∫ Primaria</option>
                            <option value="2¬∫ Primaria">2¬∫ Primaria</option>
                            <option value="3¬∫ Primaria">3¬∫ Primaria</option>
                            <option value="4¬∫ Primaria">4¬∫ Primaria</option>
                            <option value="5¬∫ Primaria">5¬∫ Primaria</option>
                            <option value="6¬∫ Primaria">6¬∫ Primaria</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">D√≠as de sesi√≥n</label>
                    <div class="dias-btns" id="diasBtns">
                        <button type="button" class="dia-btn" data-dia="0" onclick="toggleDia(0)">L</button>
                        <button type="button" class="dia-btn active" data-dia="1" onclick="toggleDia(1)">M</button>
                        <button type="button" class="dia-btn" data-dia="2" onclick="toggleDia(2)">X</button>
                        <button type="button" class="dia-btn active" data-dia="3" onclick="toggleDia(3)">J</button>
                        <button type="button" class="dia-btn active" data-dia="4" onclick="toggleDia(4)">V</button>
                    </div>
                    <p style="font-size:0.7rem;color:var(--text-light);margin-top:4px">Seleccionados: <span id="diasSelCount">3</span> d√≠as</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalNuevoAlumno')">Cancelar</button>
                <button class="btn btn-primary" onclick="crearAlumno()">‚úì Crear</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAddPrograma">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üìÑ A√±adir Programa</h3>
                <button class="modal-close" onclick="cerrarModal('modalAddPrograma')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="addProgTipo" onchange="cambioTipo()">
                        <option value="">Seleccionar...</option>
                        <option value="cognitivo">üß† Estimulaci√≥n cognitiva</option>
                        <option value="atencion">üëÅÔ∏è Atenci√≥n</option>
                        <option value="memoria">üíæ Memoria</option>
                        <option value="comunicacion">üí¨ Comunicaci√≥n</option>
                        <option value="lectoescritura">üìñ Lectoescritura (predefinido)</option>
                        <option value="matematico">üî¢ Razonamiento matem√°tico</option>
                        <option value="social">ü§ù Habilidades sociales</option>
                        <option value="emocional">‚ù§Ô∏è Gesti√≥n emocional</option>
                        <option value="ejecutivas">üéØ Funciones ejecutivas</option>
                        <option value="autonomia">üèÉ Autonom√≠a</option>
                    </select>
                </div>
                <div id="opcionDocx">
                    <div class="form-group">
                        <label class="form-label">Importar DOCX</label>
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('inputFile').click()">üìÑ Toca para seleccionar</div>
                        <input type="file" id="inputFile" accept=".docx" style="display:none" onchange="archivoPrograma(this)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">O pegar contenido</label>
                        <textarea class="form-textarea" id="addProgTexto" placeholder="OBJETIVO 1: ..."></textarea>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="analizarTexto()">üîç Analizar</button>
                </div>
                <div id="opcionLecto" style="display:none">
                    <div style="background:var(--bg);padding:12px;border-radius:8px;font-size:0.85rem">
                        <strong>üìñ Programa Predefinido</strong>
                        <p style="margin-top:6px;color:var(--text-light);font-size:0.8rem">Vocales + consonantes. Una letra por semana.</p>
                    </div>
                </div>
                <div id="previewProg" style="display:none;margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:0.8rem"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalAddPrograma')">Cancelar</button>
                <button class="btn btn-primary" id="btnAddProg" onclick="addPrograma()" disabled>üì• A√±adir</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalCelda">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="celdaTitulo">Sesi√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalCelda')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Estado de la sesi√≥n</label>
                    <div class="asistencia-btns">
                        <button type="button" class="asist-btn asiste" onclick="setEstado('asiste',this)"><span class="asist-icon">‚úÖ</span><span class="asist-text">Asisti√≥</span></button>
                        <button type="button" class="asist-btn no-asiste" onclick="setEstado('ausencia',this)"><span class="asist-icon">‚ùå</span><span class="asist-text">No asisti√≥</span></button>
                        <button type="button" class="asist-btn sin-cole" onclick="setEstado('sincole',this)"><span class="asist-icon">üè´</span><span class="asist-text">Sin cole</span></button>
                    </div>
                </div>
                <div id="contenidoSesion">
                    <div class="form-group">
                        <label class="form-label">Programa</label>
                        <select class="form-select" id="selPrograma" onchange="cargarObjs()"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objetivo</label>
                        <select class="form-select" id="selObjetivo" onchange="cargarInds()"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Indicador</label>
                        <select class="form-select" id="selIndicador"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Actividad personalizada (opcional)</label>
                        <textarea class="form-textarea" id="actividadPersonalizada" placeholder="Describe la actividad realizada..." style="min-height:60px"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Resultado</label>
                        <div class="resultado-btns">
                            <button type="button" class="resultado-btn conseguido" onclick="setRes('conseguido',this)">‚úÖ OK</button>
                            <button type="button" class="resultado-btn noconseguido" onclick="setRes('noconseguido',this)">üîÑ Repetir</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="borrarCelda()">üóëÔ∏è</button>
                <button class="btn btn-secondary" onclick="cerrarModal('modalCelda')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCelda()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfig">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Configuraci√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalConfig')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="config-item">
                    <span class="config-label">ü§ñ API Key Gemini</span>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="geminiKey" placeholder="AIza...">
                    <p style="font-size:0.7rem;color:var(--text-light);margin-top:4px">Se guarda localmente en tu navegador</p>
                </div>
                <button class="btn btn-primary btn-sm" onclick="guardarConfig()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalInforme">
        <div class="modal" style="max-width:600px">
            <div class="modal-header">
                <h3 class="modal-title">üìä Generar Informe</h3>
                <button class="modal-close" onclick="cerrarModal('modalInforme')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Trimestre</label>
                    <select class="form-select" id="informeTrim">
                        <option value="1">1¬∫ Trimestre</option>
                        <option value="2">2¬∫ Trimestre</option>
                        <option value="3">3¬∫ Trimestre</option>
                    </select>
                </div>
                <div class="btn-group" style="flex-direction:column;gap:10px;margin-top:12px">
                    <button class="btn btn-primary" onclick="generarInforme(false)">üìÑ Generar Informe (autom√°tico)</button>
                    <button class="btn btn-ai" onclick="generarInforme(true)" id="btnInformeIA">ü§ñ Generar con Gemini IA</button>
                </div>
                <div id="informePreview" style="display:none;margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;font-size:0.8rem;max-height:300px;overflow-y:auto"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalInforme')">Cerrar</button>
                <button class="btn btn-primary" id="btnDescargarInforme" onclick="descargarInforme()" style="display:none">üì• Descargar DOCX</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- LIBS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.2.0/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // ===== FIREBASE =====
        firebase.initializeApp({ databaseURL: "https://gestorpt-7946b-default-rtdb.europe-west1.firebasedatabase.app" });
        const db = firebase.database();
        
        // ===== DATOS =====
        let alumnos = {};
        let alumnoActual = null;
        let mesActual = 0;
        let diasSel = [1, 3, 4];
        let celdaEditando = null;
        let evalTrim = 1;
        let docExtraido = null;
        let estadoActual = 'asiste';
        let resActual = null;
        let informeData = null;
        let charts = {};

        // Funci√≥n para limpiar la respuesta de Gemini y extraer solo el JSON
        function limpiarRespuestaIA(texto) {
            let limpio = texto.replace(/```json/g, "").replace(/```/g, "").trim();
            const inicio = limpio.indexOf('{');
            const fin = limpio.lastIndexOf('}');
            if (inicio !== -1 && fin !== -1) {
                return limpio.substring(inicio, fin + 1);
            }
            return limpio;
        }

        const AREAS = {
            cognitivo: { nombre: 'Estimulaci√≥n cognitiva', icon: 'üß†', color: '#8b5cf6' },
            atencion: { nombre: 'Atenci√≥n', icon: 'üëÅÔ∏è', color: '#f59e0b' },
            memoria: { nombre: 'Memoria', icon: 'üíæ', color: '#06b6d4' },
            comunicacion: { nombre: 'Comunicaci√≥n', icon: 'üí¨', color: '#10b981' },
            lectoescritura: { nombre: 'Lectoescritura', icon: 'üìñ', color: '#3b82f6' },
            matematico: { nombre: 'Razonamiento matem√°tico', icon: 'üî¢', color: '#ef4444' },
            social: { nombre: 'Habilidades sociales', icon: 'ü§ù', color: '#ec4899' },
            emocional: { nombre: 'Gesti√≥n emocional', icon: '‚ù§Ô∏è', color: '#f97316' },
            ejecutivas: { nombre: 'Funciones ejecutivas', icon: 'üéØ', color: '#6366f1' },
            autonomia: { nombre: 'Autonom√≠a', icon: 'üèÉ', color: '#14b8a6' }
        };

        const MESES = [
            { nombre: 'Septiembre', semanas: 3, trimestre: 1 },
            { nombre: 'Octubre', semanas: 4, trimestre: 1 },
            { nombre: 'Noviembre', semanas: 4, trimestre: 1 },
            { nombre: 'Diciembre', semanas: 3, trimestre: 1 },
            { nombre: 'Enero', semanas: 4, trimestre: 2 },
            { nombre: 'Febrero', semanas: 4, trimestre: 2 },
            { nombre: 'Marzo', semanas: 4, trimestre: 2 },
            { nombre: 'Abril', semanas: 3, trimestre: 3 },
            { nombre: 'Mayo', semanas: 4, trimestre: 3 },
            { nombre: 'Junio', semanas: 3, trimestre: 3 }
        ];
        const DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
        const DIAS_C = ['L', 'M', 'X', 'J', 'V'];

        const LECTO = ['A','E','I','O','U','M','P','S','L','T','N','D','F','B','V','J','R','C','Q','G','H','CH','√ë','Y','LL','Z','X','K','W'].map((l,i) => ({
            numero: i+1, descripcion: `Letra ${l}`, trimestre: i<10?1:i<20?2:3,
            indicadores: [`Reconoce ${l}`, `Traza ${l}`, `Lee s√≠labas con ${l}`],
            contenidos: [`Letra ${l}`, `S√≠labas con ${l}`],
            actividades: [`Presentaci√≥n ${l}`, `Trazo ${l}`, `Lectura con ${l}`]
        }));

        // ===== FIREBASE LISTENER =====
        db.ref('gestorpe/alumnos').on('value', snap => {
            alumnos = snap.val() || {};
            renderInicio();
            if (alumnoActual && alumnos[alumnoActual]) {
                renderProgs(); renderProg(); renderEval(); renderAsis();
            }
            document.getElementById('statusDot').classList.add('ok');
            document.getElementById('statusText').textContent = 'Conectado';
        }, err => {
            console.error(err);
            document.getElementById('statusText').textContent = 'Error';
        });

        // ===== INICIO =====
        function renderInicio() {
            const g = document.getElementById('alumnosGrid');
            const ids = Object.keys(alumnos);
            if (!ids.length) {
                g.innerHTML = `<div class="alumno-card alumno-card-add" onclick="abrirModalNuevoAlumno()"><span style="font-size:1.3rem">‚ûï</span><span style="font-size:0.8rem">A√±adir</span></div>`;
                return;
            }
            g.innerHTML = ids.map(id => {
                const a = alumnos[id];
                const n = a.programas ? Object.keys(a.programas).length : 0;
                return `<div class="alumno-card" onclick="abrirAlumno('${id}')"><div class="alumno-siglas">${a.siglas}</div><div class="alumno-curso">${a.curso}</div><div class="alumno-programas">${n} prog.</div></div>`;
            }).join('') + `<div class="alumno-card alumno-card-add" onclick="abrirModalNuevoAlumno()"><span style="font-size:1.3rem">‚ûï</span></div>`;
        }

        // ===== NUEVO ALUMNO =====
        function abrirModalNuevoAlumno() {
            document.getElementById('nuevoSiglas').value = '';
            diasSel = [1, 3, 4];
            actualizarDiasBtns();
            abrirModal('modalNuevoAlumno');
        }

        function toggleDia(d) {
            const idx = diasSel.indexOf(d);
            if (idx > -1) { if (diasSel.length > 1) diasSel.splice(idx, 1); }
            else { diasSel.push(d); diasSel.sort((a,b) => a-b); }
            actualizarDiasBtns();
        }

        function actualizarDiasBtns() {
            document.querySelectorAll('#diasBtns .dia-btn').forEach(btn => {
                btn.classList.toggle('active', diasSel.includes(parseInt(btn.dataset.dia)));
            });
            document.getElementById('diasSelCount').textContent = diasSel.length;
        }

        function crearAlumno() {
            const siglas = document.getElementById('nuevoSiglas').value.trim().toUpperCase();
            if (!siglas) { toast('Introduce siglas', 'error'); return; }
            if (!diasSel.length) { toast('Selecciona d√≠as', 'error'); return; }

            const alumno = {
                siglas,
                curso: document.getElementById('nuevoCurso').value,
                diasSesion: diasSel.slice(),
                programas: {}, programacion: {}, evaluaciones: {}, ausencias: {}, sinColegio: {}, resultados: {}, actividades: {}
            };

            db.ref('gestorpe/alumnos').push().set(alumno)
                .then(() => { cerrarModal('modalNuevoAlumno'); toast(`${siglas} creado ‚úì`, 'success'); })
                .catch(e => toast('Error: ' + e.message, 'error'));
        }

        // ===== ABRIR ALUMNO =====
        function abrirAlumno(id) {
            alumnoActual = id;
            mesActual = 0;
            evalTrim = 1;

            document.getElementById('screenInicio').classList.remove('active');
            document.getElementById('screenAlumno').classList.add('active');
            document.getElementById('btnVolver').style.display = 'block';
            document.getElementById('btnConfig').style.display = 'block';

            const a = alumnos[id];
            const st = calcStats(a);
            const diasStr = (a.diasSesion || [0,2,4]).map(d => DIAS_C[d]).join('-');

            let progs = '';
            if (a.programas) Object.keys(a.programas).forEach(pId => {
                const info = AREAS[a.programas[pId].tipo] || { icon: 'üìÑ', color: '#666' };
                progs += `<span class="area-badge" style="background:${info.color}20;color:${info.color}">${info.icon}</span> `;
            });

            document.getElementById('alumnoHeader').innerHTML = `
                <div class="alumno-header-siglas">${a.siglas}</div>
                <div class="alumno-header-info"><h2>${a.curso}</h2><p>${diasStr} ¬∑ ${st.ausencias} aus. ¬∑ ${st.sinCole} sin cole</p><div style="margin-top:4px">${progs||''}</div></div>
                <div style="margin-left:auto" class="btn-group no-print">
                    <button class="btn btn-danger btn-sm" onclick="eliminarAlumno('${id}')">üóëÔ∏è</button>
                </div>`;

            document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', i===0));
            document.querySelectorAll('.tab-content').forEach((c,i) => c.classList.toggle('active', i===0));

            renderProgs(); renderProg(); renderEval(); renderAsis();
        }

        function volverInicio() {
            alumnoActual = null;
            document.getElementById('screenAlumno').classList.remove('active');
            document.getElementById('screenInicio').classList.add('active');
            document.getElementById('btnVolver').style.display = 'none';
            document.getElementById('btnConfig').style.display = 'none';
        }

        function cambiarTab(t) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            if (t === 'asistencia') setTimeout(renderAsisCharts, 100);
            if (t === 'evaluacion') setTimeout(renderEvalCharts, 100);
        }

        function eliminarAlumno(id) {
            if (confirm('¬øEliminar?')) {
                db.ref(`gestorpe/alumnos/${id}`).remove();
                volverInicio();
                toast('Eliminado', 'success');
            }
        }

        // ===== ESTAD√çSTICAS =====
        function calcStats(a) {
            const aus = a.ausencias || {}, sc = a.sinColegio || {}, res = a.resultados || {};
            let ausencias = 0, sinCole = 0, conseguidos = 0, noConseguidos = 0;
            const dias = a.diasSesion || [0,2,4];
            const porMes = {}, porTrim = {1:{aus:0,sc:0}, 2:{aus:0,sc:0}, 3:{aus:0,sc:0}};

            MESES.forEach((m, mi) => {
                porMes[mi] = { aus: 0, sc: 0 };
                for (let s = 1; s <= m.semanas; s++) {
                    dias.forEach(d => {
                        const k = `${mi}_${s}_${d}`;
                        if (aus[k]) { ausencias++; porMes[mi].aus++; porTrim[m.trimestre].aus++; }
                        if (sc[k]) { sinCole++; porMes[mi].sc++; porTrim[m.trimestre].sc++; }
                        if (res[k] === 'conseguido') conseguidos++;
                        if (res[k] === 'noconseguido') noConseguidos++;
                    });
                }
            });
            return { ausencias, sinCole, conseguidos, noConseguidos, porMes, porTrim };
        }

        // ===== PROGRAMAS =====
        function renderProgs() {
            const a = alumnos[alumnoActual];
            let h = `<div class="card"><div class="card-header"><h3 class="card-title">üìÑ Programas</h3><button class="btn btn-primary btn-sm no-print" onclick="abrirModalAddProg()">‚ûï</button></div>`;

            if (!a.programas || !Object.keys(a.programas).length) {
                h += `<div class="empty-state"><div class="empty-icon">üìÑ</div><p>Sin programas</p></div>`;
            } else {
                Object.keys(a.programas).forEach(pId => {
                    const p = a.programas[pId];
                    const info = AREAS[p.tipo] || { icon: 'üìÑ', nombre: p.tipo, color: '#666' };
                    h += `<div class="programa-card" style="border-left-color:${info.color}"><div class="programa-header"><span class="programa-titulo">${info.icon} ${info.nombre}</span><button class="btn btn-danger btn-sm no-print" onclick="elimProg('${pId}')">üóëÔ∏è</button></div>`;
                    (p.objetivos||[]).forEach(obj => {
                        h += `<div class="objetivo-card"><div class="objetivo-header"><span class="objetivo-num">O${obj.numero}</span><span class="trimestre-badge t${obj.trimestre}">T${obj.trimestre}</span></div><div class="objetivo-desc">${obj.descripcion}</div>`;
                        if (obj.indicadores?.length) h += `<div class="objetivo-section"><div class="objetivo-section-title">Indicadores</div><ul class="item-list">${obj.indicadores.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
                        if (obj.contenidos?.length) h += `<div class="objetivo-section"><div class="objetivo-section-title">Contenidos</div><ul class="item-list">${obj.contenidos.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
                        if (obj.actividades?.length) h += `<div class="objetivo-section"><div class="objetivo-section-title">Actividades</div><ul class="item-list">${obj.actividades.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
                        h += '</div>';
                    });
                    h += '</div>';
                });
            }
            h += `<div class="btn-group no-print" style="margin-top:8px">
                <button class="btn btn-secondary btn-sm" onclick="regenerar()">üîÑ Regenerar</button>
                <button class="btn btn-ai btn-sm" onclick="regenerarIA()">ü§ñ Regenerar con IA</button>
            </div></div>`;
            document.getElementById('tabProgramas').innerHTML = h;
        }

        function abrirModalAddProg() {
            document.getElementById('addProgTipo').value = '';
            document.getElementById('addProgTexto').value = '';
            document.getElementById('uploadZone').innerHTML = 'üìÑ Toca para seleccionar';
            document.getElementById('uploadZone').classList.remove('has-file');
            document.getElementById('previewProg').style.display = 'none';
            document.getElementById('opcionDocx').style.display = 'block';
            document.getElementById('opcionLecto').style.display = 'none';
            document.getElementById('btnAddProg').disabled = true;
            document.getElementById('inputFile').value = '';
            docExtraido = null;
            abrirModal('modalAddPrograma');
        }

        function cambioTipo() {
            const t = document.getElementById('addProgTipo').value;
            document.getElementById('opcionDocx').style.display = t === 'lectoescritura' ? 'none' : 'block';
            document.getElementById('opcionLecto').style.display = t === 'lectoescritura' ? 'block' : 'none';
            document.getElementById('btnAddProg').disabled = t !== 'lectoescritura' && !docExtraido;
        }

        async function archivoPrograma(inp) {
            const f = inp.files[0];
            if (!f) return;
            document.getElementById('uploadZone').innerHTML = 'üìÑ ' + f.name;
            document.getElementById('uploadZone').classList.add('has-file');
            try {
                const r = await mammoth.extractRawText({ arrayBuffer: await f.arrayBuffer() });
                procesarTexto(r.value);
            } catch (e) { toast('Error', 'error'); }
        }

        function analizarTexto() {
            const t = document.getElementById('addProgTexto').value;
            if (t.length < 20) { toast('M√°s contenido', 'error'); return; }
            procesarTexto(t);
        }

        function procesarTexto(txt) {
            const objs = extraerObjs(txt);
            if (!objs.length) { toast('Sin objetivos', 'error'); return; }
            docExtraido = objs;
            document.getElementById('previewProg').innerHTML = `‚úì ${objs.length} objetivos`;
            document.getElementById('previewProg').style.display = 'block';
            document.getElementById('btnAddProg').disabled = false;
        }

        function extraerObjs(txt) {
            const objs = [];
            const ls = txt.split('\n').map(l => l.trim()).filter(l => l);
            let ac = null, sec = null;
            for (const l of ls) {
                const u = l.toUpperCase(), m = l.match(/^OBJETIVO\s*(\d+)[.:\s]*(.+)?/i);
                if (m) { if (ac) objs.push(ac); ac = { numero: parseInt(m[1]), descripcion: (m[2]||'').trim(), indicadores: [], contenidos: [], actividades: [] }; sec = null; continue; }
                if (u.includes('INDICADOR')) { sec = 'indicadores'; continue; }
                if (u === 'CONTENIDOS' || u.startsWith('CONTENIDOS')) { sec = 'contenidos'; continue; }
                if (u.includes('ACTIVIDADES')) { sec = 'actividades'; continue; }
                if (ac && sec && l.length > 5) { let x = l.replace(/^[-‚Ä¢¬∑‚ñ™‚ñ∫]\s*/, '').trim(); if (x.length > 5) ac[sec].push(x); }
            }
            if (ac) objs.push(ac);
            objs.forEach(o => { if (!o.indicadores.length) o.indicadores = ['Indicador general']; if (!o.actividades.length) o.actividades = ['Actividad general']; });
            const n = objs.length, p = Math.ceil(n/3);
            objs.forEach((o,i) => { o.trimestre = i < p ? 1 : i < p*2 ? 2 : 3; });
            return objs;
        }

        function addPrograma() {
            const tipo = document.getElementById('addProgTipo').value;
            if (!tipo) { toast('Selecciona tipo', 'error'); return; }
            const objetivos = tipo === 'lectoescritura' ? LECTO : docExtraido;
            if (!objetivos) { toast('Sin contenido', 'error'); return; }

            const a = alumnos[alumnoActual];
            const pId = 'p_' + Date.now();
            const prog = { tipo, objetivos };

            db.ref(`gestorpe/alumnos/${alumnoActual}/programas/${pId}`).set(prog).then(() => {
                a.programas = a.programas || {};
                a.programas[pId] = prog;
                const nuevaProg = genProgRotacion(a);
                return db.ref(`gestorpe/alumnos/${alumnoActual}/programacion`).set(nuevaProg);
            }).then(() => {
                cerrarModal('modalAddPrograma');
                abrirAlumno(alumnoActual);
                toast('A√±adido ‚úì', 'success');
            }).catch(e => toast('Error: ' + e.message, 'error'));
        }

        function elimProg(pId) {
            if (!confirm('¬øEliminar?')) return;
            db.ref(`gestorpe/alumnos/${alumnoActual}/programas/${pId}`).remove().then(() => {
                delete alumnos[alumnoActual].programas[pId];
                return db.ref(`gestorpe/alumnos/${alumnoActual}/programacion`).set(genProgRotacion(alumnos[alumnoActual]));
            }).then(() => { abrirAlumno(alumnoActual); toast('Eliminado', 'success'); });
        }

        function regenerar() {
            if (!confirm('¬øRegenerar?')) return;
            const a = alumnos[alumnoActual];
            const nueva = genProgRotacion(a);
            db.ref(`gestorpe/alumnos/${alumnoActual}/programacion`).set(nueva).then(() => {
                a.programacion = nueva;
                renderProg();
                toast('Regenerado ‚úì', 'success');
            });
        }

        // ===== GENERACI√ìN CON ROTACI√ìN =====
        function genProgRotacion(a) {
            const prog = {};
            if (!a.programas) return prog;
            const dias = a.diasSesion || [0,2,4];
            const pIds = Object.keys(a.programas);
            if (!pIds.length) return prog;

            // Crear pool de items por programa y trimestre
            const poolPorTrim = { 1: [], 2: [], 3: [] };
            
            pIds.forEach(pId => {
                const p = a.programas[pId];
                (p.objetivos || []).forEach((o, oi) => {
                    const items = [];
                    // Primero indicadores
                    (o.indicadores || []).forEach((_, ii) => items.push({ pId, oIdx: oi, iIdx: ii, tipo: 'ind' }));
                    // Si no hay suficientes, a√±adir contenidos
                    (o.contenidos || []).forEach((_, ci) => items.push({ pId, oIdx: oi, iIdx: ci, tipo: 'cont' }));
                    
                    items.forEach(item => poolPorTrim[o.trimestre].push(item));
                });
            });

            // Rotaci√≥n por sesi√≥n
            let sesionIdx = 0;
            
            MESES.forEach((m, mi) => {
                const pool = poolPorTrim[m.trimestre];
                if (!pool.length) return;
                
                for (let s = 1; s <= m.semanas; s++) {
                    dias.forEach(d => {
                        const k = `${mi}_${s}_${d}`;
                        // Rotaci√≥n entre programas
                        const pIdx = sesionIdx % pIds.length;
                        const itemsDelProg = pool.filter(x => x.pId === pIds[pIdx]);
                        
                        if (itemsDelProg.length) {
                            const item = itemsDelProg[Math.floor(sesionIdx / pIds.length) % itemsDelProg.length];
                            prog[k] = { pId: item.pId, oIdx: item.oIdx, iIdx: item.iIdx };
                        } else if (pool.length) {
                            const item = pool[sesionIdx % pool.length];
                            prog[k] = { pId: item.pId, oIdx: item.oIdx, iIdx: item.iIdx };
                        }
                        sesionIdx++;
                    });
                }
            });

            return prog;
        }

        // ===== REGENERAR CON IA =====
        async function regenerarIA() {
            const key = localStorage.getItem('geminiKey');
            if (!key) { toast('Configura API Gemini', 'error'); abrirConfig(); return; }
            
            const a = alumnos[alumnoActual];
            if (!a.programas || !Object.keys(a.programas).length) { toast('Sin programas', 'error'); return; }
            
            toast('Consultando Gemini...', '');
            console.log('ü§ñ Iniciando IA...');
            
            const pIds = Object.keys(a.programas);
            const dias = a.diasSesion || [0,2,4];
            
            try {
                // Crear descripci√≥n de programas para la IA
                const programasDesc = pIds.map((pId, idx) => {
                    const p = a.programas[pId];
                    const info = AREAS[p.tipo] || { nombre: p.tipo };
                    const objsT1 = (p.objetivos||[]).filter(o => o.trimestre === 1).length;
                    const objsT2 = (p.objetivos||[]).filter(o => o.trimestre === 2).length;
                    const objsT3 = (p.objetivos||[]).filter(o => o.trimestre === 3).length;
                    return `Programa ${idx}: ${info.nombre} (T1:${objsT1} obj, T2:${objsT2} obj, T3:${objsT3} obj)`;
                }).join('\n');

                const prompt = `Eres especialista en Pedagog√≠a Terap√©utica. Necesito que definas la estrategia de rotaci√≥n para ${pIds.length} programas.

PROGRAMAS:
${programasDesc}

SESIONES: ${dias.length} d√≠as por semana

PREGUNTA: ¬øQu√© porcentaje de sesiones deber√≠a dedicar a cada programa por trimestre para un reparto equilibrado?

IMPORTANTE: Responde √öNICAMENTE con JSON, sin explicaciones:
{"distribucion": [{"programa": 0, "peso": 1}, {"programa": 1, "peso": 1}], "estrategia": "rotacion"}

- "peso" es un n√∫mero relativo (1=igual, 2=doble de sesiones)
- "estrategia" puede ser "rotacion" (A,B,C,A,B,C) o "bloques" (AAA,BBB,CCC)`;

                console.log('ü§ñ Enviando a Gemini...');
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.1 }
                    })
                });

                const data = await response.json();
                console.log('ü§ñ Respuesta Gemini:', data);
                const textoSucio = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                console.log('ü§ñ Texto recibido:', textoSucio);
                const jsonLimpio = limpiarRespuestaIA(textoSucio);
                console.log('ü§ñ JSON limpio:', jsonLimpio);
                const result = JSON.parse(jsonLimpio);
                console.log('ü§ñ Resultado:', result);
                
                // Generar programaci√≥n real con la estrategia de la IA
                const nuevaProg = generarProgConIA(a, result);
                console.log('ü§ñ Sesiones generadas:', Object.keys(nuevaProg).length);
                
                await db.ref(`gestorpe/alumnos/${alumnoActual}/programacion`).set(nuevaProg);
                a.programacion = nuevaProg;
                renderProg();
                toast(`‚úì IA aplicada: ${result.estrategia || 'rotaci√≥n'}`, 'success');
                
            } catch (e) {
                console.error('Error IA:', e);
                // Si falla la IA, usar rotaci√≥n normal
                toast('IA fall√≥, usando rotaci√≥n est√°ndar', 'warning');
                regenerar();
            }
        }

        // Genera programaci√≥n usando estrategia de la IA pero con IDs reales
        function generarProgConIA(a, iaResult) {
            const prog = {};
            const dias = a.diasSesion || [0,2,4];
            const pIds = Object.keys(a.programas);
            if (!pIds.length) return prog;

            // Obtener pesos de la IA o usar 1 por defecto
            const pesos = {};
            pIds.forEach((pId, idx) => {
                const dist = (iaResult.distribucion || []).find(d => d.programa === idx);
                pesos[pId] = dist ? dist.peso : 1;
            });

            // Crear pool expandido seg√∫n pesos
            const poolPorTrim = { 1: [], 2: [], 3: [] };
            
            pIds.forEach(pId => {
                const p = a.programas[pId];
                const peso = pesos[pId] || 1;
                
                (p.objetivos || []).forEach((o, oi) => {
                    const items = [];
                    (o.indicadores || []).forEach((_, ii) => items.push({ pId, oIdx: oi, iIdx: ii }));
                    if (!items.length) {
                        (o.contenidos || []).forEach((_, ci) => items.push({ pId, oIdx: oi, iIdx: ci }));
                    }
                    // A√±adir seg√∫n peso
                    for (let w = 0; w < peso; w++) {
                        items.forEach(item => poolPorTrim[o.trimestre].push(item));
                    }
                });
            });

            // Estrategia de rotaci√≥n o bloques
            const esRotacion = (iaResult.estrategia || 'rotacion') === 'rotacion';
            let sesionIdx = 0;
            
            MESES.forEach((m, mi) => {
                const pool = poolPorTrim[m.trimestre];
                if (!pool.length) return;
                
                for (let s = 1; s <= m.semanas; s++) {
                    dias.forEach(d => {
                        const k = `${mi}_${s}_${d}`;
                        if (esRotacion) {
                            // Rotaci√≥n: alterna entre programas
                            prog[k] = { ...pool[sesionIdx % pool.length] };
                        } else {
                            // Bloques: agrupa por programa
                            const bloqueSize = Math.ceil(pool.length / pIds.length);
                            const idx = Math.min(sesionIdx, pool.length - 1);
                            prog[k] = { ...pool[idx] };
                        }
                        sesionIdx++;
                    });
                }
            });

            return prog;
        }

        // ===== PROGRAMACI√ìN =====
        function renderProg() {
            const a = alumnos[alumnoActual];
            const dias = a.diasSesion || [0,2,4];
            const noms = dias.map(d => DIAS_C[d]);
            const mes = MESES[mesActual];
            const st = calcStats(a);

            let h = `<div class="card">
                <div class="stats-box no-print">
                    <div class="stat-item"><div class="stat-num ausencias">${st.porMes[mesActual]?.aus||0}</div><div class="stat-label">Ausencias</div></div>
                    <div class="stat-item"><div class="stat-num sincole">${st.porMes[mesActual]?.sc||0}</div><div class="stat-label">Sin cole</div></div>
                </div>
                <div class="cuadrante-nav no-print">
                    <button class="nav-btn" onclick="cambiarMes(-1)">‚óÄ</button>
                    <select class="form-select" style="width:auto;font-size:0.85rem" onchange="mesActual=parseInt(this.value);renderProg()">${MESES.map((m,i) => `<option value="${i}" ${i===mesActual?'selected':''}>${m.nombre}</option>`).join('')}</select>
                    <button class="nav-btn" onclick="cambiarMes(1)">‚ñ∂</button>
                    <span class="trimestre-badge t${mes.trimestre}">T${mes.trimestre}</span>
                </div>
                <div class="leyenda no-print">
                    <div class="leyenda-item"><div class="leyenda-color" style="background:#fee2e2"></div>Ausencia</div>
                    <div class="leyenda-item"><div class="leyenda-color" style="background:#fef08a"></div>Sin cole</div>
                    <div class="leyenda-item"><div class="leyenda-color" style="background:#dcfce7"></div>Conseguido</div>
                    <div class="leyenda-item"><div class="leyenda-color" style="background:#fef3c7"></div>Repetir</div>
                </div>
                <div style="overflow-x:auto;margin-top:8px"><table class="cuadrante-table">
                    <thead><tr><th>Sem</th>${noms.map(n => `<th>${n}</th>`).join('')}</tr></thead>
                    <tbody>${Array.from({length:mes.semanas},(_,si) => {
                        const sem = si+1;
                        return `<tr><td>${sem}</td>${dias.map(d => renderCelda(a,`${mesActual}_${sem}_${d}`,d)).join('')}</tr>`;
                    }).join('')}</tbody>
                </table></div>
            </div>`;
            document.getElementById('tabProgramacion').innerHTML = h;
        }

        function renderCelda(a,k,d) {
            const c = a.programacion?.[k];
            const aus = a.ausencias?.[k];
            const sc = a.sinColegio?.[k];
            const res = a.resultados?.[k];
            const act = a.actividades?.[k];
            
            let cls = 'celda', icon = '';
            if (sc) { cls += ' celda-sincole'; icon = 'üè´'; }
            else if (aus) { cls += ' celda-ausencia'; icon = '‚ùå'; }
            else if (res === 'conseguido') icon = '‚úÖ';
            else if (res === 'noconseguido') icon = 'üîÑ';
            
            if (!c || !a.programas?.[c.pId]) return `<td class="${cls} celda-vacia" onclick="editarCelda('${k}',${d})">${icon?`<span class="celda-icon">${icon}</span>`:''}+</td>`;
            
            const p = a.programas[c.pId], obj = p.objetivos?.[c.oIdx];
            if (!obj) return `<td class="${cls}">?</td>`;
            
            const info = AREAS[p.tipo] || {color:'#666'}, ind = obj.indicadores?.[c.iIdx] || '';
            return `<td class="${cls}" onclick="editarCelda('${k}',${d})">${icon?`<span class="celda-icon">${icon}</span>`:''}<div class="celda-obj"><span class="celda-area" style="background:${info.color}"></span>O${obj.numero}</div><div class="celda-ind">${ind.substring(0,22)}${ind.length>22?'...':''}</div>${act?`<div class="celda-act">üìù ${act.substring(0,15)}...</div>`:''}</td>`;
        }

        function cambiarMes(dir) { mesActual = Math.max(0, Math.min(9, mesActual + dir)); renderProg(); }

        // ===== EDITAR CELDA =====
        function editarCelda(k,d) {
            celdaEditando = k;
            estadoActual = 'asiste';
            resActual = null;
            
            const a = alumnos[alumnoActual], c = a.programacion?.[k] || {};
            document.getElementById('celdaTitulo').textContent = DIAS[d];
            
            document.querySelectorAll('.asist-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.resultado-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('actividadPersonalizada').value = a.actividades?.[k] || '';
            
            if (a.sinColegio?.[k]) {
                estadoActual = 'sincole';
                document.querySelector('.asist-btn.sin-cole').classList.add('selected');
                document.getElementById('contenidoSesion').style.display = 'none';
            } else if (a.ausencias?.[k]) {
                estadoActual = 'ausencia';
                document.querySelector('.asist-btn.no-asiste').classList.add('selected');
                document.getElementById('contenidoSesion').style.display = 'none';
            } else {
                document.querySelector('.asist-btn.asiste').classList.add('selected');
                document.getElementById('contenidoSesion').style.display = 'block';
            }
            
            resActual = a.resultados?.[k] || null;
            if (resActual) document.querySelector(`.resultado-btn.${resActual}`)?.classList.add('selected');
            
            const sel = document.getElementById('selPrograma');
            sel.innerHTML = '<option value="">-</option>';
            if (a.programas) Object.keys(a.programas).forEach(pId => {
                const p = a.programas[pId], info = AREAS[p.tipo] || {icon:'üìÑ'};
                sel.innerHTML += `<option value="${pId}" ${c.pId===pId?'selected':''}>${info.icon} ${info.nombre||p.tipo}</option>`;
            });
            
            if (c.pId) {
                cargarObjs();
                setTimeout(() => { document.getElementById('selObjetivo').value = c.oIdx??''; cargarInds(); setTimeout(() => { document.getElementById('selIndicador').value = c.iIdx??''; }, 30); }, 30);
            } else {
                document.getElementById('selObjetivo').innerHTML = '<option value="">-</option>';
                document.getElementById('selIndicador').innerHTML = '<option value="">-</option>';
            }
            abrirModal('modalCelda');
        }

        function setEstado(e, btn) {
            estadoActual = e;
            document.querySelectorAll('.asist-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('contenidoSesion').style.display = e === 'asiste' ? 'block' : 'none';
        }

        function setRes(v, btn) {
            if (resActual === v) { resActual = null; btn.classList.remove('selected'); }
            else { resActual = v; document.querySelectorAll('.resultado-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        }

        function cargarObjs() {
            const a = alumnos[alumnoActual], pId = document.getElementById('selPrograma').value, sel = document.getElementById('selObjetivo');
            sel.innerHTML = '<option value="">-</option>';
            document.getElementById('selIndicador').innerHTML = '<option value="">-</option>';
            if (!pId || !a.programas?.[pId]) return;
            a.programas[pId].objetivos.forEach((o,i) => { sel.innerHTML += `<option value="${i}">O${o.numero}: ${o.descripcion.substring(0,20)}...</option>`; });
        }

        function cargarInds() {
            const a = alumnos[alumnoActual], pId = document.getElementById('selPrograma').value, oIdx = document.getElementById('selObjetivo').value, sel = document.getElementById('selIndicador');
            sel.innerHTML = '<option value="">-</option>';
            if (!pId || oIdx === '') return;
            (a.programas[pId].objetivos[parseInt(oIdx)].indicadores||[]).forEach((x,i) => { sel.innerHTML += `<option value="${i}">${x.substring(0,30)}...</option>`; });
        }

        function guardarCelda() {
            const a = alumnos[alumnoActual];
            const updates = {};
            const actividad = document.getElementById('actividadPersonalizada').value.trim();

            // Limpiar estados previos
            updates[`gestorpe/alumnos/${alumnoActual}/ausencias/${celdaEditando}`] = null;
            updates[`gestorpe/alumnos/${alumnoActual}/sinColegio/${celdaEditando}`] = null;

            if (estadoActual === 'ausencia') {
                updates[`gestorpe/alumnos/${alumnoActual}/ausencias/${celdaEditando}`] = true;
                moverSesion(celdaEditando);
            } else if (estadoActual === 'sincole') {
                updates[`gestorpe/alumnos/${alumnoActual}/sinColegio/${celdaEditando}`] = true;
                moverSesion(celdaEditando);
            } else {
                const pId = document.getElementById('selPrograma').value;
                const oIdx = document.getElementById('selObjetivo').value;
                const iIdx = document.getElementById('selIndicador').value;

                if (pId && oIdx !== '') {
                    updates[`gestorpe/alumnos/${alumnoActual}/programacion/${celdaEditando}`] = { 
                        pId, oIdx: parseInt(oIdx), iIdx: iIdx !== '' ? parseInt(iIdx) : 0 
                    };
                }

                if (resActual) {
                    updates[`gestorpe/alumnos/${alumnoActual}/resultados/${celdaEditando}`] = resActual;
                    if (resActual === 'noconseguido') repetirSem(celdaEditando);
                } else {
                    updates[`gestorpe/alumnos/${alumnoActual}/resultados/${celdaEditando}`] = null;
                }
            }

            // Actividad personalizada
            if (actividad) {
                updates[`gestorpe/alumnos/${alumnoActual}/actividades/${celdaEditando}`] = actividad;
            } else {
                updates[`gestorpe/alumnos/${alumnoActual}/actividades/${celdaEditando}`] = null;
            }

            db.ref().update(updates).then(() => {
                cerrarModal('modalCelda');
                toast('Guardado ‚úì', 'success');
            }).catch(e => toast('Error: ' + e.message, 'error'));
        }

        function moverSesion(k) {
            const a = alumnos[alumnoActual], c = a.programacion?.[k];
            if (!c) return;
            const [mi, sem, dia] = k.split('_').map(Number), dias = a.diasSesion || [0,2,4], di = dias.indexOf(dia);
            
            for (let i = di+1; i < dias.length; i++) {
                const nk = `${mi}_${sem}_${dias[i]}`;
                if (!a.ausencias?.[nk] && !a.sinColegio?.[nk]) {
                    db.ref(`gestorpe/alumnos/${alumnoActual}/programacion/${nk}`).set({...c});
                    return;
                }
            }
            
            let ns = sem+1, nm = mi;
            if (ns > MESES[nm].semanas) { ns = 1; nm++; }
            if (nm < 10) {
                const nk = `${nm}_${ns}_${dias[0]}`;
                db.ref(`gestorpe/alumnos/${alumnoActual}/programacion/${nk}`).set({...c});
            }
        }

        function repetirSem(k) {
            const a = alumnos[alumnoActual], c = a.programacion?.[k];
            if (!c) return;
            const [mi, sem, dia] = k.split('_').map(Number);
            let ns = sem+1, nm = mi;
            if (ns > MESES[nm].semanas) { ns = 1; nm++; }
            if (nm < 10) {
                const nk = `${nm}_${ns}_${dia}`;
                db.ref(`gestorpe/alumnos/${alumnoActual}/programacion/${nk}`).set({...c});
            }
        }

        function borrarCelda() {
            const updates = {};
            ['programacion', 'ausencias', 'sinColegio', 'resultados', 'actividades'].forEach(t => {
                updates[`gestorpe/alumnos/${alumnoActual}/${t}/${celdaEditando}`] = null;
            });
            db.ref().update(updates).then(() => { cerrarModal('modalCelda'); toast('Eliminado', 'success'); });
        }

        // ===== EVALUACI√ìN =====
        function renderEval() {
            const a = alumnos[alumnoActual];
            let h = `<div class="card">
                <div class="card-header"><h3 class="card-title">üìä Evaluaci√≥n</h3></div>
                <div class="btn-group no-print" style="margin-bottom:12px">
                    <button class="btn ${evalTrim===1?'btn-primary':'btn-secondary'} btn-sm" onclick="setTrim(1)">T1</button>
                    <button class="btn ${evalTrim===2?'btn-primary':'btn-secondary'} btn-sm" onclick="setTrim(2)">T2</button>
                    <button class="btn ${evalTrim===3?'btn-primary':'btn-secondary'} btn-sm" onclick="setTrim(3)">T3</button>
                    <button class="btn btn-warning btn-sm" onclick="abrirModalInforme()">üìÑ Crear Informe</button>
                </div>
                <div class="chart-container no-print"><canvas id="chartProgreso"></canvas></div>
                <div id="evalList"></div>
            </div>`;
            document.getElementById('tabEvaluacion').innerHTML = h;
            renderEvalList();
            setTimeout(renderEvalCharts, 100);
        }

        function setTrim(t) { evalTrim = t; renderEval(); }

        function renderEvalCharts() {
            const a = alumnos[alumnoActual];
            if (!a.programas) return;
            
            const ctx = document.getElementById('chartProgreso');
            if (!ctx) return;
            
            if (charts.progreso) charts.progreso.destroy();
            
            const labels = [], conseguidos = [], proceso = [], noIniciados = [];
            
            Object.keys(a.programas).forEach(pId => {
                const p = a.programas[pId];
                const info = AREAS[p.tipo] || { nombre: p.tipo };
                labels.push(info.nombre.substring(0, 15));
                
                let c = 0, pr = 0, n = 0;
                (p.objetivos || []).filter(o => o.trimestre === evalTrim).forEach((obj, oi) => {
                    (obj.indicadores || []).forEach((_, ii) => {
                        const k = `${pId}_${oi}_${ii}_T${evalTrim}`;
                        const e = a.evaluaciones?.[k];
                        if (e === 'C') c++;
                        else if (e === 'P') pr++;
                        else n++;
                    });
                });
                conseguidos.push(c);
                proceso.push(pr);
                noIniciados.push(n);
            });

            charts.progreso = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Conseguido', data: conseguidos, backgroundColor: '#22c55e' },
                        { label: 'En proceso', data: proceso, backgroundColor: '#3b82f6' },
                        { label: 'No iniciado', data: noIniciados, backgroundColor: '#d1d5db' }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        }

        function renderEvalList() {
            const a = alumnos[alumnoActual], c = document.getElementById('evalList');
            let h = '', hay = false;
            if (a.programas) Object.keys(a.programas).forEach(pId => {
                const p = a.programas[pId], info = AREAS[p.tipo] || {icon:'üìÑ',nombre:p.tipo,color:'#666'};
                const objsT = (p.objetivos||[]).filter(o => o.trimestre === evalTrim);
                if (!objsT.length) return;
                hay = true;
                h += `<div class="programa-card" style="border-left-color:${info.color}"><div class="programa-titulo" style="margin-bottom:8px">${info.icon} ${info.nombre}</div>`;
                objsT.forEach((obj, idx) => {
                    const oi = p.objetivos.indexOf(obj);
                    h += `<div style="margin-bottom:8px"><div style="font-weight:600;font-size:0.8rem;margin-bottom:4px">O${obj.numero}: ${obj.descripcion.substring(0,30)}...</div>`;
                    (obj.indicadores||[]).forEach((ind,ii) => {
                        const k = `${pId}_${oi}_${ii}_T${evalTrim}`, e = a.evaluaciones?.[k] || '';
                        h += `<div class="eval-item"><span class="eval-text">${ind}</span><button class="eval-btn c ${e==='C'?'active':''}" onclick="setEval('${pId}',${oi},${ii},'C')">‚úì</button><button class="eval-btn p ${e==='P'?'active':''}" onclick="setEval('${pId}',${oi},${ii},'P')">‚óê</button><button class="eval-btn n ${e==='N'?'active':''}" onclick="setEval('${pId}',${oi},${ii},'N')">‚óã</button></div>`;
                    });
                    h += '</div>';
                });
                h += '</div>';
            });
            c.innerHTML = hay ? h : '<p style="text-align:center;color:var(--text-light)">Sin indicadores en T' + evalTrim + '</p>';
        }

        function setEval(pId, oi, ii, e) {
            const a = alumnos[alumnoActual], k = `${pId}_${oi}_${ii}_T${evalTrim}`;
            a.evaluaciones = a.evaluaciones || {};
            if (a.evaluaciones[k] === e) { db.ref(`gestorpe/alumnos/${alumnoActual}/evaluaciones/${k}`).remove(); delete a.evaluaciones[k]; }
            else { db.ref(`gestorpe/alumnos/${alumnoActual}/evaluaciones/${k}`).set(e); a.evaluaciones[k] = e; }
            renderEvalList();
            setTimeout(renderEvalCharts, 100);
        }

        // ===== ASISTENCIA =====
        function renderAsis() {
            const a = alumnos[alumnoActual], st = calcStats(a);
            document.getElementById('tabAsistencia').innerHTML = `<div class="card">
                <div class="card-header"><h3 class="card-title">üìà Asistencia</h3></div>
                <div class="stats-box">
                    <div class="stat-item"><div class="stat-num ausencias">${st.ausencias}</div><div class="stat-label">Ausencias</div></div>
                    <div class="stat-item"><div class="stat-num sincole">${st.sinCole}</div><div class="stat-label">Sin cole</div></div>
                    <div class="stat-item"><div class="stat-num" style="color:var(--success)">${st.conseguidos}</div><div class="stat-label">Conseguidos</div></div>
                    <div class="stat-item"><div class="stat-num" style="color:var(--warning)">${st.noConseguidos}</div><div class="stat-label">Repetir</div></div>
                </div>
                <div class="chart-container"><canvas id="chartAsistencia"></canvas></div>
                <div class="chart-container"><canvas id="chartEvolucion"></canvas></div>
            </div>`;
            setTimeout(renderAsisCharts, 100);
        }

        function renderAsisCharts() {
            const a = alumnos[alumnoActual], st = calcStats(a);
            
            // Gr√°fica por trimestre
            const ctx1 = document.getElementById('chartAsistencia');
            if (ctx1) {
                if (charts.asistencia) charts.asistencia.destroy();
                charts.asistencia = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['T1', 'T2', 'T3'],
                        datasets: [
                            { label: 'Ausencias', data: [st.porTrim[1].aus, st.porTrim[2].aus, st.porTrim[3].aus], backgroundColor: '#ef4444' },
                            { label: 'Sin cole', data: [st.porTrim[1].sc, st.porTrim[2].sc, st.porTrim[3].sc], backgroundColor: '#f59e0b' }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Por trimestre' } } }
                });
            }

            // Gr√°fica evoluci√≥n mensual
            const ctx2 = document.getElementById('chartEvolucion');
            if (ctx2) {
                if (charts.evolucion) charts.evolucion.destroy();
                charts.evolucion = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: MESES.map(m => m.nombre.substring(0, 3)),
                        datasets: [
                            { label: 'Ausencias', data: MESES.map((_, i) => st.porMes[i]?.aus || 0), borderColor: '#ef4444', tension: 0.3 },
                            { label: 'Sin cole', data: MESES.map((_, i) => st.porMes[i]?.sc || 0), borderColor: '#f59e0b', tension: 0.3 }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Evoluci√≥n mensual' } } }
                });
            }
        }

        // ===== INFORME =====
        function abrirModalInforme() {
            document.getElementById('informeTrim').value = evalTrim;
            document.getElementById('informePreview').style.display = 'none';
            document.getElementById('btnDescargarInforme').style.display = 'none';
            informeData = null;
            abrirModal('modalInforme');
        }

        async function generarInforme(usarIA) {
            console.log('üìÑ generarInforme llamado, usarIA:', usarIA);
            const trim = parseInt(document.getElementById('informeTrim').value);
            const a = alumnos[alumnoActual];
            console.log('üìÑ Alumno:', a?.siglas, 'Trimestre:', trim);
            const st = calcStats(a);

            // Recopilar datos
            const conseguidos = [], proceso = [], noIniciados = [];
            
            if (a.programas) {
                Object.keys(a.programas).forEach(pId => {
                    const p = a.programas[pId];
                    const info = AREAS[p.tipo] || { nombre: p.tipo };
                    
                    (p.objetivos || []).filter(o => o.trimestre === trim).forEach((obj, idx) => {
                        const oi = p.objetivos.indexOf(obj);
                        (obj.indicadores || []).forEach((ind, ii) => {
                            const k = `${pId}_${oi}_${ii}_T${trim}`;
                            const e = a.evaluaciones?.[k];
                            const item = { programa: info.nombre, objetivo: `O${obj.numero}: ${obj.descripcion}`, indicador: ind };
                            if (e === 'C') conseguidos.push(item);
                            else if (e === 'P') proceso.push(item);
                            else noIniciados.push(item);
                        });
                    });
                });
            }
            
            console.log('üìÑ Datos recopilados - C:', conseguidos.length, 'P:', proceso.length, 'N:', noIniciados.length);

            informeData = {
                alumno: a,
                trim,
                conseguidos,
                proceso,
                noIniciados,
                ausencias: st.porTrim[trim]?.aus || 0,
                sinCole: st.porTrim[trim]?.sc || 0,
                valoracion: ''
            };

            const previewEl = document.getElementById('informePreview');
            const btnDescarga = document.getElementById('btnDescargarInforme');
            console.log('üìÑ Elementos encontrados - preview:', !!previewEl, 'btnDescarga:', !!btnDescarga);

            if (usarIA) {
                const key = localStorage.getItem('geminiKey');
                if (!key) { toast('Configura API Gemini', 'error'); return; }
                
                toast('Generando con IA...', '');
                console.log('üìÑ Llamando a Gemini...');
                
                try {
                    const prompt = `Eres un especialista en Pedagog√≠a Terap√©utica. Genera una valoraci√≥n profesional para un informe trimestral.

ALUMNO: ${a.siglas} (${a.curso})
TRIMESTRE: ${trim}

INDICADORES CONSEGUIDOS (${conseguidos.length}):
${conseguidos.slice(0,10).map(c => `- ${c.programa}: ${c.indicador}`).join('\n') || 'Ninguno'}

INDICADORES EN PROCESO (${proceso.length}):
${proceso.slice(0,10).map(c => `- ${c.programa}: ${c.indicador}`).join('\n') || 'Ninguno'}

INDICADORES NO INICIADOS (${noIniciados.length}):
${noIniciados.slice(0,5).map(c => `- ${c.programa}: ${c.indicador}`).join('\n') || 'Ninguno'}

AUSENCIAS: ${informeData.ausencias}
D√çAS SIN CLASE: ${informeData.sinCole}

Genera una valoraci√≥n profesional de 2-3 p√°rrafos. Incluye:
1. Resumen del progreso general
2. Aspectos destacados y logros
3. √Åreas de mejora y propuestas

Usa tono profesional pero cercano. Responde solo con el texto de la valoraci√≥n, sin formato JSON ni markdown.`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    const data = await response.json();
                    informeData.valoracion = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Error al generar valoraci√≥n';
                    toast('Valoraci√≥n IA generada ‚úì', 'success');
                } catch (e) {
                    console.error('Error IA informe:', e);
                    informeData.valoracion = 'Error al conectar con IA. Se usar√° valoraci√≥n autom√°tica.\n\n' + generarValoracionAuto(a, trim, conseguidos, proceso, noIniciados, informeData);
                    toast('Error IA, valoraci√≥n autom√°tica', 'error');
                }
            } else {
                informeData.valoracion = generarValoracionAuto(a, trim, conseguidos, proceso, noIniciados, informeData);
            }

            // Mostrar preview SIEMPRE
            previewEl.innerHTML = `
                <h4 style="margin-bottom:8px">üìÑ Informe T${trim} - ${a.siglas}</h4>
                <p><strong>‚úÖ Conseguidos:</strong> ${conseguidos.length}</p>
                <p><strong>üîÑ En proceso:</strong> ${proceso.length}</p>
                <p><strong>‚≠ï No iniciados:</strong> ${noIniciados.length}</p>
                <p><strong>‚ùå Ausencias:</strong> ${informeData.ausencias}</p>
                <p><strong>üè´ Sin cole:</strong> ${informeData.sinCole}</p>
                <hr style="margin:8px 0">
                <p style="white-space:pre-wrap;font-size:0.75rem">${informeData.valoracion.substring(0, 500)}${informeData.valoracion.length > 500 ? '...' : ''}</p>
            `;
            previewEl.style.display = 'block';
            btnDescarga.style.display = 'inline-flex';
            
            toast('Informe listo para descargar', 'success');
        }

        function generarValoracionAuto(a, trim, conseguidos, proceso, noIniciados, datos) {
            const total = conseguidos.length + proceso.length + noIniciados.length;
            const porcC = total ? Math.round(conseguidos.length / total * 100) : 0;
            const porcP = total ? Math.round(proceso.length / total * 100) : 0;
            
            return `Durante el ${trim}¬∫ trimestre, ${a.siglas} ha trabajado un total de ${total} indicadores de los programas asignados. El ${porcC}% han sido conseguidos, el ${porcP}% est√°n en proceso de adquisici√≥n y el resto no se han iniciado.

Se han registrado ${datos.ausencias} ausencias del alumno/a y ${datos.sinCole} d√≠as sin clase durante este per√≠odo.

Se recomienda continuar trabajando los indicadores en proceso y aquellos no iniciados en el pr√≥ximo trimestre, adaptando las actividades seg√∫n la evoluci√≥n observada.`;
        }

        async function descargarInforme() {
            console.log('üìÑ Iniciando descarga informe...');
            console.log('üìÑ informeData:', informeData);
            
            if (!informeData) {
                toast('No hay datos de informe', 'error');
                console.error('‚ùå informeData es null');
                return;
            }
            
            try {
                console.log('üìÑ Cargando librer√≠a docx...');
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
                console.log('üìÑ Librer√≠a cargada OK');
                
                const a = informeData.alumno;
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                children: [new TextRun({ text: `INFORME DE SEGUIMIENTO - ${informeData.trim}¬∫ TRIMESTRE`, bold: true, size: 32 })],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `Alumno/a: ${a.siglas}`, bold: true }), new TextRun({ text: ` | Curso: ${a.curso}` })],
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `Fecha: ${new Date().toLocaleDateString('es-ES')}` })],
                                spacing: { after: 400 }
                            }),
                            
                            // Resumen
                            new Paragraph({ text: 'RESUMEN DE EVALUACI√ìN', heading: HeadingLevel.HEADING_1, spacing: { before: 200, after: 200 } }),
                            new Paragraph({ children: [
                                new TextRun({ text: `Indicadores conseguidos: `, bold: true }), new TextRun(`${informeData.conseguidos.length}`),
                            ], spacing: { after: 100 } }),
                            new Paragraph({ children: [
                                new TextRun({ text: `Indicadores en proceso: `, bold: true }), new TextRun(`${informeData.proceso.length}`),
                            ], spacing: { after: 100 } }),
                            new Paragraph({ children: [
                                new TextRun({ text: `Indicadores no iniciados: `, bold: true }), new TextRun(`${informeData.noIniciados.length}`),
                            ], spacing: { after: 100 } }),
                            new Paragraph({ children: [
                                new TextRun({ text: `Ausencias del alumno/a: `, bold: true }), new TextRun(`${informeData.ausencias}`),
                            ], spacing: { after: 100 } }),
                            new Paragraph({ children: [
                                new TextRun({ text: `Dias sin clase: `, bold: true }), new TextRun(`${informeData.sinCole}`),
                            ], spacing: { after: 400 } }),
                            
                            // Conseguidos
                            new Paragraph({ text: 'INDICADORES CONSEGUIDOS', heading: HeadingLevel.HEADING_1, spacing: { before: 200, after: 200 } }),
                            ...(informeData.conseguidos.length > 0 ? informeData.conseguidos.map(c => new Paragraph({
                                children: [new TextRun({ text: `- ${c.programa}: `, bold: true }), new TextRun(c.indicador)],
                                spacing: { after: 50 }
                            })) : [new Paragraph({ children: [new TextRun({ text: 'Ninguno', italics: true })] })]),
                            
                            // En proceso
                            new Paragraph({ text: 'INDICADORES EN PROCESO', heading: HeadingLevel.HEADING_1, spacing: { before: 300, after: 200 } }),
                            ...(informeData.proceso.length > 0 ? informeData.proceso.map(c => new Paragraph({
                                children: [new TextRun({ text: `- ${c.programa}: `, bold: true }), new TextRun(c.indicador)],
                                spacing: { after: 50 }
                            })) : [new Paragraph({ children: [new TextRun({ text: 'Ninguno', italics: true })] })]),
                            
                            // No iniciados
                            new Paragraph({ text: 'INDICADORES NO INICIADOS', heading: HeadingLevel.HEADING_1, spacing: { before: 300, after: 200 } }),
                            ...(informeData.noIniciados.length > 0 ? informeData.noIniciados.map(c => new Paragraph({
                                children: [new TextRun({ text: `- ${c.programa}: `, bold: true }), new TextRun(c.indicador)],
                                spacing: { after: 50 }
                            })) : [new Paragraph({ children: [new TextRun({ text: 'Ninguno', italics: true })] })]),
                            
                            // Valoraci√≥n
                            new Paragraph({ text: 'VALORACI√ìN', heading: HeadingLevel.HEADING_1, spacing: { before: 400, after: 200 } }),
                            ...(informeData.valoracion || '').split('\n').filter(p => p.trim()).map(p => new Paragraph({ text: p, spacing: { after: 100 } })),
                            
                            // Firma
                            new Paragraph({ text: '', spacing: { before: 600 } }),
                            new Paragraph({ text: 'Fdo: _______________________', alignment: AlignmentType.RIGHT }),
                            new Paragraph({ text: 'Maestro/a de PT/AL', alignment: AlignmentType.RIGHT, spacing: { after: 100 } })
                        ]
                    }]
                });

                console.log('üìÑ Documento creado, empaquetando...');
                const blob = await Packer.toBlob(doc);
                console.log('üìÑ Blob creado, tama√±o:', blob.size);
                
                saveAs(blob, `Informe_${a.siglas}_T${informeData.trim}.docx`);
                toast('Informe descargado ‚úì', 'success');
                cerrarModal('modalInforme');
                
            } catch (e) {
                console.error('‚ùå Error descargando informe:', e);
                toast('Error: ' + e.message, 'error');
            }
        }

        // ===== CONFIG =====
        function abrirConfig() {
            document.getElementById('geminiKey').value = localStorage.getItem('geminiKey') || '';
            abrirModal('modalConfig');
        }

        function guardarConfig() {
            const key = document.getElementById('geminiKey').value.trim();
            if (key) localStorage.setItem('geminiKey', key);
            else localStorage.removeItem('geminiKey');
            cerrarModal('modalConfig');
            toast('Configuraci√≥n guardada', 'success');
        }

        // ===== UTILS =====
        function abrirModal(id) { document.getElementById(id).classList.add('active'); }
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
        function toast(msg, tipo = '') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + tipo; setTimeout(() => t.classList.add('show'), 10); setTimeout(() => t.classList.remove('show'), 2500); }
    </script>
</body>
</html>
