<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a5f4a">
    <title>Gestor PE - Programas Espec√≠ficos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #1a5f4a;
            --primary-light: #2d8a6e;
            --primary-dark: #134536;
            --bg: #f5f7f6;
            --bg-card: #ffffff;
            --text: #1a2a24;
            --text-light: #5a6b64;
            --border: #d4ddd9;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --proceso: #3b82f6;
            
            --cognitivo: #8b5cf6;
            --atencion: #f59e0b;
            --memoria: #06b6d4;
            --comunicacion: #10b981;
            --lectoescritura: #3b82f6;
            --matematico: #ef4444;
            --social: #ec4899;
            --emocional: #f97316;
            --ejecutivas: #6366f1;
            --autonomia: #14b8a6;
            
            --t1: #8b5cf6;
            --t2: #06b6d4;
            --t3: #f59e0b;
            --shadow: 0 4px 20px rgba(26, 95, 74, 0.1);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 14px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .header h1 { font-size: 1.3rem; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 10px; }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        .status-dot.ok { background: var(--success); animation: none; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .btn-header {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 7px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            display: none;
        }

        .btn-header:hover { background: rgba(255,255,255,0.25); }

        /* ===== CONTAINER ===== */
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; }

        .screen { display: none; }
        .screen.active { display: block; }

        /* ===== GRID ALUMNOS ===== */
        .alumnos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }

        .alumno-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            position: relative;
        }

        .alumno-card:hover { transform: translateY(-3px); border-color: var(--primary-light); }

        .alumno-siglas {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .alumno-curso { font-size: 0.8rem; color: var(--text-light); }

        .alumno-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alumno-card-add {
            background: transparent;
            border: 2px dashed var(--primary-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--primary);
            min-height: 90px;
        }

        /* ===== CARD ===== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-title { font-size: 1.05rem; font-weight: 700; color: var(--primary-dark); }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 5px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .tab {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
        }

        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== FORMS ===== */
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9rem;
            background: white;
        }

        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-primary:disabled { background: var(--border); cursor: not-allowed; }
        .btn-secondary { background: var(--bg); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 7px 12px; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* ===== UPLOAD ===== */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 30px 16px;
            text-align: center;
            cursor: pointer;
            background: var(--bg);
        }

        .upload-zone:hover { border-color: var(--primary); }
        .upload-zone.has-file { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .upload-icon { font-size: 2rem; margin-bottom: 8px; }

        /* ===== SESIONES BTNS ===== */
        .sesiones-btns { display: flex; gap: 8px; margin-top: 6px; }

        .sesion-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: white;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .sesion-btn:hover { border-color: var(--primary-light); }
        .sesion-btn.active { border-color: var(--primary); background: rgba(26, 95, 74, 0.1); }

        /* ===== PREVIEW ===== */
        .preview-box {
            display: none;
            margin-top: 14px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 14px;
        }

        .preview-box.active { display: block; }

        .preview-obj {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 6px;
            border-left: 3px solid var(--primary);
        }

        .preview-obj h4 { font-size: 0.85rem; margin-bottom: 3px; }
        .preview-obj p { font-size: 0.75rem; color: var(--text-light); }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius);
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-light); }
        .modal-body { padding: 18px; }
        .modal-footer { padding: 14px 18px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }

        /* ===== ALUMNO HEADER ===== */
        .alumno-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .alumno-header-siglas {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            background: rgba(26, 95, 74, 0.1);
            padding: 12px 20px;
            border-radius: var(--radius);
        }

        .alumno-header-info h2 { font-size: 1.1rem; }
        .alumno-header-info p { color: var(--text-light); font-size: 0.85rem; }

        /* ===== OBJETIVO CARD ===== */
        .objetivo-card {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .objetivo-header { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; }

        .objetivo-num {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(26, 95, 74, 0.15);
            color: var(--primary);
        }

        .trimestre-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .trimestre-badge.t1 { background: #8b5cf620; color: #8b5cf6; }
        .trimestre-badge.t2 { background: #06b6d420; color: #06b6d4; }
        .trimestre-badge.t3 { background: #f59e0b20; color: #f59e0b; }

        .objetivo-desc { font-weight: 500; font-size: 0.9rem; margin-bottom: 8px; }

        .objetivo-section { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
        .objetivo-section-title { font-size: 0.7rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; }

        .item-list { list-style: none; }
        .item-list li { font-size: 0.8rem; padding: 4px 0 4px 14px; position: relative; }
        .item-list li::before { content: "‚Ä¢"; position: absolute; left: 0; color: var(--primary); }

        /* ===== CUADRANTE ===== */
        .cuadrante-nav {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .nav-btn:hover { border-color: var(--primary); }

        .cuadrante-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 0.8rem;
        }

        .cuadrante-table th, .cuadrante-table td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }

        .cuadrante-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
        }

        .cuadrante-table td:first-child {
            background: var(--primary-light);
            color: white;
            font-weight: 600;
            text-align: center;
            width: 60px;
            font-size: 0.75rem;
        }

        .celda { min-height: 60px; cursor: pointer; }
        .celda:hover { background: var(--bg); }
        .celda-vacia { background: #f9fafb; color: var(--text-light); font-size: 0.75rem; }

        .celda-obj { font-weight: 600; color: var(--primary-dark); font-size: 0.75rem; margin-bottom: 2px; }
        .celda-ind { font-size: 0.7rem; color: var(--text); margin-bottom: 2px; }
        .celda-act { font-size: 0.65rem; color: var(--text-light); font-style: italic; }

        /* ===== EVALUACI√ìN ===== */
        .eval-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .eval-text { flex: 1; font-size: 0.85rem; min-width: 150px; }

        .eval-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .eval-btn.c { border-color: var(--success); color: var(--success); }
        .eval-btn.c.active { background: var(--success); color: white; }
        .eval-btn.p { border-color: var(--proceso); color: var(--proceso); }
        .eval-btn.p.active { background: var(--proceso); color: white; }
        .eval-btn.n { border-color: gray; color: gray; }
        .eval-btn.n.active { background: gray; color: white; }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 10px 18px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        .empty-state { text-align: center; padding: 30px; color: var(--text-light); }
        .empty-icon { font-size: 2.5rem; margin-bottom: 8px; opacity: 0.5; }

        /* ===== PRINT STYLES ===== */
        @media print {
            body { background: white; }
            .header, .tabs, .btn, .nav-btn, .cuadrante-nav, .modal-overlay, .toast, .btn-group { display: none !important; }
            .screen, .tab-content, .card { display: block !important; box-shadow: none; }
            .container { max-width: 100%; padding: 0; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333; }
            .print-header h1 { font-size: 1.4rem; margin-bottom: 5px; }
            .print-header p { font-size: 0.9rem; color: #666; }
            .cuadrante-table { font-size: 0.7rem; }
            .cuadrante-table th, .cuadrante-table td { padding: 4px; }
            .objetivo-card { break-inside: avoid; }
            .page-break { page-break-before: always; }
        }

        .print-header { display: none; }

        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .alumno-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üìã Gestor PE</h1>
            <div class="header-right">
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                <button class="btn-header" id="btnVolver" onclick="volverInicio()">‚Üê Volver</button>
            </div>
        </div>
    </header>

    <!-- PANTALLA INICIO -->
    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Alumnos</h2>
                    <button class="btn btn-primary btn-sm" onclick="abrirModalImportar()">üìÑ Importar DOCX</button>
                </div>
                <div class="alumnos-grid" id="alumnosGrid"></div>
            </div>
        </div>
    </div>

    <!-- PANTALLA ALUMNO -->
    <div id="screenAlumno" class="screen">
        <div class="container">
            <div class="print-header" id="printHeader"></div>
            <div class="alumno-header" id="alumnoHeader"></div>
            <div class="tabs" id="tabsContainer">
                <button class="tab active" onclick="cambiarTab('programa')">üìÑ Programa</button>
                <button class="tab" onclick="cambiarTab('programacion')">üìÖ Programaci√≥n</button>
                <button class="tab" onclick="cambiarTab('evaluacion')">üìä Evaluaci√≥n</button>
            </div>
            <div id="tabPrograma" class="tab-content active"></div>
            <div id="tabProgramacion" class="tab-content"></div>
            <div id="tabEvaluacion" class="tab-content"></div>
        </div>
    </div>

    <!-- MODAL IMPORTAR -->
    <div class="modal-overlay" id="modalImportar">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üìÑ Importar Programa</h3>
                <button class="modal-close" onclick="cerrarModal('modalImportar')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Siglas *</label>
                        <input type="text" class="form-input" id="inputSiglas" placeholder="M.G.L." maxlength="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Curso *</label>
                        <select class="form-select" id="inputCurso">
                            <option value="Infantil 3 a√±os">Infantil 3 a√±os</option>
                            <option value="Infantil 4 a√±os">Infantil 4 a√±os</option>
                            <option value="Infantil 5 a√±os" selected>Infantil 5 a√±os</option>
                            <option value="1¬∫ Primaria">1¬∫ Primaria</option>
                            <option value="2¬∫ Primaria">2¬∫ Primaria</option>
                            <option value="3¬∫ Primaria">3¬∫ Primaria</option>
                            <option value="4¬∫ Primaria">4¬∫ Primaria</option>
                            <option value="5¬∫ Primaria">5¬∫ Primaria</option>
                            <option value="6¬∫ Primaria">6¬∫ Primaria</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Sesiones por semana *</label>
                    <div class="sesiones-btns">
                        <button type="button" class="sesion-btn" onclick="selSesiones(1)">1 sesi√≥n</button>
                        <button type="button" class="sesion-btn" onclick="selSesiones(2)">2 sesiones</button>
                        <button type="button" class="sesion-btn active" onclick="selSesiones(3)">3 sesiones</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">√Årea del programa *</label>
                    <select class="form-select" id="inputArea">
                        <option value="cognitivo">üß† Estimulaci√≥n cognitiva</option>
                        <option value="atencion">üëÅÔ∏è Atenci√≥n</option>
                        <option value="memoria">üíæ Memoria</option>
                        <option value="comunicacion" selected>üí¨ Comunicaci√≥n y lenguaje</option>
                        <option value="lectoescritura">üìñ Lectoescritura</option>
                        <option value="matematico">üî¢ Razonamiento matem√°tico</option>
                        <option value="social">ü§ù Habilidades sociales</option>
                        <option value="emocional">‚ù§Ô∏è Gesti√≥n emocional</option>
                        <option value="ejecutivas">üéØ Funciones ejecutivas</option>
                        <option value="autonomia">üèÉ Autonom√≠a</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Archivo DOCX *</label>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('inputFile').click()">
                        <div class="upload-icon">üìÑ</div>
                        <span id="uploadText">Haz clic para seleccionar</span>
                    </div>
                    <input type="file" id="inputFile" accept=".docx" style="display:none" onchange="archivoSeleccionado(this)">
                </div>

                <div class="preview-box" id="previewBox"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalImportar')">Cancelar</button>
                <button class="btn btn-primary" id="btnImportar" onclick="importarAlumno()" disabled>üì• Importar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR CELDA -->
    <div class="modal-overlay" id="modalCelda">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="celdaTitulo">Editar sesi√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalCelda')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Objetivo</label>
                    <select class="form-select" id="selObjetivo" onchange="cargarIndicadores()"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Indicador</label>
                    <select class="form-select" id="selIndicador"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Actividad</label>
                    <select class="form-select" id="selActividad"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="borrarCelda()">üóëÔ∏è</button>
                <button class="btn btn-secondary" onclick="cerrarModal('modalCelda')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCelda()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            databaseURL: "https://gestorpt-7946b-default-rtdb.europe-west1.firebasedatabase.app"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            window.db = db;
            window.dbRef = ref;
            window.dbSet = set;
            window.dbRemove = remove;
            window.dbPush = push;
            window.dbOnValue = onValue;

            const alumnosRef = ref(db, 'gestorpe/alumnos');
            
            onValue(alumnosRef, (snapshot) => {
                window.alumnos = snapshot.val() || {};
                window.renderInicio();
                document.getElementById('statusDot').classList.add('ok');
                document.getElementById('statusText').textContent = 'Conectado';
            }, (error) => {
                console.error('Error Firebase:', error);
                document.getElementById('statusText').textContent = 'Error';
            });
            
        } catch (err) {
            console.error('Error inicializaci√≥n:', err);
            document.getElementById('statusText').textContent = 'Error';
        }
    </script>

    <script>
        // ===== DATOS =====
        window.alumnos = {};
        let alumnoActual = null;
        let mesActual = 0;
        let sesionesSeleccionadas = 3;
        let docExtraido = null;
        let celdaEditando = null;
        let evalTrim = 1;

        const AREAS = {
            cognitivo: { nombre: 'üß† Estimulaci√≥n cognitiva', color: '#8b5cf6' },
            atencion: { nombre: 'üëÅÔ∏è Atenci√≥n', color: '#f59e0b' },
            memoria: { nombre: 'üíæ Memoria', color: '#06b6d4' },
            comunicacion: { nombre: 'üí¨ Comunicaci√≥n y lenguaje', color: '#10b981' },
            lectoescritura: { nombre: 'üìñ Lectoescritura', color: '#3b82f6' },
            matematico: { nombre: 'üî¢ Razonamiento matem√°tico', color: '#ef4444' },
            social: { nombre: 'ü§ù Habilidades sociales', color: '#ec4899' },
            emocional: { nombre: '‚ù§Ô∏è Gesti√≥n emocional', color: '#f97316' },
            ejecutivas: { nombre: 'üéØ Funciones ejecutivas', color: '#6366f1' },
            autonomia: { nombre: 'üèÉ Autonom√≠a', color: '#14b8a6' }
        };

        const MESES = [
            { nombre: 'Septiembre', semanas: 3, trimestre: 1 },
            { nombre: 'Octubre', semanas: 4, trimestre: 1 },
            { nombre: 'Noviembre', semanas: 4, trimestre: 1 },
            { nombre: 'Diciembre', semanas: 3, trimestre: 1 },
            { nombre: 'Enero', semanas: 4, trimestre: 2 },
            { nombre: 'Febrero', semanas: 4, trimestre: 2 },
            { nombre: 'Marzo', semanas: 4, trimestre: 2 },
            { nombre: 'Abril', semanas: 3, trimestre: 3 },
            { nombre: 'Mayo', semanas: 4, trimestre: 3 },
            { nombre: 'Junio', semanas: 3, trimestre: 3 }
        ];

        const DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];

        // ===== INICIO =====
        window.renderInicio = function() {
            const grid = document.getElementById('alumnosGrid');
            const ids = Object.keys(window.alumnos);

            if (ids.length === 0) {
                grid.innerHTML = `<div class="alumno-card alumno-card-add" onclick="abrirModalImportar()">
                    <span style="font-size:1.5rem">‚ûï</span><span>A√±adir</span>
                </div>`;
                return;
            }

            let html = '';
            ids.forEach(id => {
                const a = window.alumnos[id];
                html += `<div class="alumno-card" onclick="abrirAlumno('${id}')">
                    <div class="alumno-badge">‚úì</div>
                    <div class="alumno-siglas">${a.siglas}</div>
                    <div class="alumno-curso">${a.curso}</div>
                </div>`;
            });
            html += `<div class="alumno-card alumno-card-add" onclick="abrirModalImportar()">
                <span style="font-size:1.5rem">‚ûï</span><span>A√±adir</span>
            </div>`;
            grid.innerHTML = html;
        };

        function abrirAlumno(id) {
            alumnoActual = id;
            mesActual = 0;
            evalTrim = 1;

            document.getElementById('screenInicio').classList.remove('active');
            document.getElementById('screenAlumno').classList.add('active');
            document.getElementById('btnVolver').style.display = 'block';

            const a = window.alumnos[id];
            const areaInfo = AREAS[a.area] || { nombre: a.area };

            document.getElementById('printHeader').innerHTML = `
                <h1>Programa Espec√≠fico - ${a.siglas}</h1>
                <p>${a.curso} ¬∑ ${areaInfo.nombre} ¬∑ ${a.sesionesSemana} sesiones/semana</p>
            `;

            document.getElementById('alumnoHeader').innerHTML = `
                <div class="alumno-header-siglas">${a.siglas}</div>
                <div class="alumno-header-info">
                    <h2>${a.curso}</h2>
                    <p>${a.sesionesSemana} sesiones/semana ¬∑ ${areaInfo.nombre}</p>
                </div>
                <button class="btn btn-danger btn-sm" onclick="eliminarAlumno('${id}')" style="margin-left:auto">üóëÔ∏è</button>
            `;

            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === 0));
            document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === 0));

            renderPrograma();
            renderProgramacion();
            renderEvaluacion();
        }

        function volverInicio() {
            alumnoActual = null;
            document.getElementById('screenAlumno').classList.remove('active');
            document.getElementById('screenInicio').classList.add('active');
            document.getElementById('btnVolver').style.display = 'none';
        }

        function cambiarTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        function eliminarAlumno(id) {
            if (confirm('¬øEliminar este alumno y todos sus datos?')) {
                window.dbRemove(window.dbRef(window.db, `gestorpe/alumnos/${id}`));
                volverInicio();
                toast('Alumno eliminado', 'success');
            }
        }

        // ===== MODAL IMPORTAR =====
        function abrirModalImportar() {
            document.getElementById('inputSiglas').value = '';
            document.getElementById('uploadZone').classList.remove('has-file');
            document.getElementById('uploadText').textContent = 'Haz clic para seleccionar';
            document.getElementById('previewBox').classList.remove('active');
            document.getElementById('btnImportar').disabled = true;
            document.getElementById('inputFile').value = '';
            docExtraido = null;
            sesionesSeleccionadas = 3;
            document.querySelectorAll('.sesion-btn').forEach((b, i) => b.classList.toggle('active', i === 2));
            abrirModal('modalImportar');
        }

        function selSesiones(n) {
            sesionesSeleccionadas = n;
            document.querySelectorAll('.sesion-btn').forEach((b, i) => b.classList.toggle('active', i === n - 1));
        }

        function archivoSeleccionado(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.docx')) {
                toast('Solo archivos DOCX', 'error');
                return;
            }

            document.getElementById('uploadZone').classList.add('has-file');
            document.getElementById('uploadText').textContent = file.name;
            procesarDOCX(file);
        }

        async function procesarDOCX(file) {
            try {
                const buffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: buffer });
                const objetivos = extraerObjetivos(result.value);

                if (objetivos.length === 0) {
                    toast('No se encontraron objetivos', 'error');
                    return;
                }

                docExtraido = objetivos;

                let html = '<strong style="font-size:0.85rem">Contenido extra√≠do:</strong>';
                objetivos.forEach(obj => {
                    html += `<div class="preview-obj">
                        <h4>Objetivo ${obj.numero}: ${obj.descripcion.substring(0, 40)}...</h4>
                        <p>${obj.indicadores.length} ind. ¬∑ ${obj.contenidos.length} cont. ¬∑ ${obj.actividades.length} act.</p>
                    </div>`;
                });

                document.getElementById('previewBox').innerHTML = html;
                document.getElementById('previewBox').classList.add('active');
                document.getElementById('btnImportar').disabled = false;

            } catch (err) {
                console.error(err);
                toast('Error: ' + err.message, 'error');
            }
        }

        function extraerObjetivos(texto) {
            const objetivos = [];
            const lineas = texto.split('\n').map(l => l.trim()).filter(l => l);

            let actual = null;
            let seccion = null;

            for (const linea of lineas) {
                const upper = linea.toUpperCase();

                const match = linea.match(/^OBJETIVO\s*(\d+)[.:\s]*(.+)?/i);
                if (match) {
                    if (actual) objetivos.push(actual);
                    actual = {
                        numero: parseInt(match[1]),
                        descripcion: (match[2] || '').trim(),
                        indicadores: [],
                        contenidos: [],
                        actividades: []
                    };
                    seccion = null;
                    continue;
                }

                if (upper.includes('INDICADOR')) { seccion = 'indicadores'; continue; }
                if (upper === 'CONTENIDOS' || upper.startsWith('CONTENIDOS')) { seccion = 'contenidos'; continue; }
                if (upper.includes('ACTIVIDADES')) { seccion = 'actividades'; continue; }
                if (upper.includes('ORGANIZACI√ìN') || upper.startsWith('SESI√ìN') || upper.startsWith('ESPECIALIDAD')) continue;

                if (actual && seccion && linea.length > 5) {
                    let txt = linea.replace(/^[-‚Ä¢¬∑‚ñ™‚ñ∫]\s*/, '').replace(/^[""]|[""]$/g, '').trim();
                    if (txt.length > 5) actual[seccion].push(txt);
                }
            }

            if (actual) objetivos.push(actual);

            objetivos.forEach(obj => {
                if (obj.indicadores.length === 0) obj.indicadores = ['Indicador general'];
                if (obj.actividades.length === 0) obj.actividades = ['Actividad general'];
            });

            return objetivos;
        }

        function importarAlumno() {
            const siglas = document.getElementById('inputSiglas').value.trim().toUpperCase();
            if (!siglas) { toast('Introduce las siglas', 'error'); return; }
            if (!docExtraido) { toast('Sube un documento', 'error'); return; }

            const curso = document.getElementById('inputCurso').value;
            const area = document.getElementById('inputArea').value;

            const total = docExtraido.length;
            const porT = Math.ceil(total / 3);

            const objetivos = docExtraido.map((obj, idx) => ({
                ...obj,
                trimestre: idx < porT ? 1 : idx < porT * 2 ? 2 : 3
            }));

            const alumno = {
                siglas,
                curso,
                area,
                sesionesSemana: sesionesSeleccionadas,
                objetivos,
                programacion: {},
                evaluaciones: {}
            };

            alumno.programacion = generarProgramacion(alumno);

            const newRef = window.dbPush(window.dbRef(window.db, 'gestorpe/alumnos'));
            window.dbSet(newRef, alumno).then(() => {
                cerrarModal('modalImportar');
                toast(`${siglas} importado ‚úì`, 'success');
            }).catch(err => {
                console.error(err);
                toast('Error al guardar', 'error');
            });
        }

        // ===== PROGRAMACI√ìN =====
        function generarProgramacion(alumno) {
            const prog = {};
            const sesiones = alumno.sesionesSemana;

            let dias;
            if (sesiones === 1) dias = [2];
            else if (sesiones === 2) dias = [1, 3];
            else dias = [0, 2, 4];

            MESES.forEach((mes, mIdx) => {
                const trim = mes.trimestre;
                const objsTrim = alumno.objetivos.filter(o => o.trimestre === trim);
                if (objsTrim.length === 0) return;

                let pool = [];
                objsTrim.forEach(obj => {
                    const oIdx = alumno.objetivos.indexOf(obj);
                    obj.indicadores.forEach((ind, iIdx) => {
                        obj.actividades.forEach((act, aIdx) => {
                            pool.push({ oIdx, iIdx, aIdx });
                        });
                    });
                });

                let pIdx = 0;
                for (let sem = 1; sem <= mes.semanas; sem++) {
                    dias.forEach(dia => {
                        const key = `${mIdx}_${sem}_${dia}`;
                        prog[key] = pool[pIdx % pool.length];
                        pIdx++;
                    });
                }
            });

            return prog;
        }

        // ===== RENDER PROGRAMA =====
        function renderPrograma() {
            const a = window.alumnos[alumnoActual];
            const container = document.getElementById('tabPrograma');

            if (!a.objetivos?.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÑ</div><p>Sin objetivos</p></div>';
                return;
            }

            let html = `<div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìÑ Objetivos del Programa</h3>
                    <button class="btn btn-secondary btn-sm" onclick="imprimirPrograma()">üñ®Ô∏è Imprimir</button>
                </div>`;

            a.objetivos.forEach(obj => {
                html += `<div class="objetivo-card">
                    <div class="objetivo-header">
                        <span class="objetivo-num">O${obj.numero}</span>
                        <span class="trimestre-badge t${obj.trimestre}">T${obj.trimestre}</span>
                    </div>
                    <div class="objetivo-desc">${obj.descripcion}</div>`;

                if (obj.indicadores?.length) {
                    html += `<div class="objetivo-section">
                        <div class="objetivo-section-title">Indicadores</div>
                        <ul class="item-list">${obj.indicadores.map(i => `<li>${i}</li>`).join('')}</ul>
                    </div>`;
                }

                if (obj.contenidos?.length) {
                    html += `<div class="objetivo-section">
                        <div class="objetivo-section-title">Contenidos</div>
                        <ul class="item-list">${obj.contenidos.map(c => `<li>${c}</li>`).join('')}</ul>
                    </div>`;
                }

                if (obj.actividades?.length) {
                    html += `<div class="objetivo-section">
                        <div class="objetivo-section-title">Actividades</div>
                        <ul class="item-list">${obj.actividades.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>`;
                }

                html += '</div>';
            });

            html += `<div class="btn-group" style="margin-top:12px">
                <button class="btn btn-primary btn-sm" onclick="regenerar()">üîÑ Regenerar Programaci√≥n</button>
            </div></div>`;

            container.innerHTML = html;
        }

        function regenerar() {
            if (!confirm('¬øRegenerar programaci√≥n?')) return;
            const a = window.alumnos[alumnoActual];
            a.programacion = generarProgramacion(a);
            window.dbSet(window.dbRef(window.db, `gestorpe/alumnos/${alumnoActual}/programacion`), a.programacion);
            renderProgramacion();
            toast('Regenerado ‚úì', 'success');
        }

        function imprimirPrograma() {
            window.print();
        }

        // ===== RENDER PROGRAMACI√ìN =====
        function renderProgramacion() {
            const a = window.alumnos[alumnoActual];
            const container = document.getElementById('tabProgramacion');
            const sesiones = a.sesionesSemana;

            let dias, nombres;
            if (sesiones === 1) { dias = [2]; nombres = ['Mi√©rcoles']; }
            else if (sesiones === 2) { dias = [1, 3]; nombres = ['Martes', 'Jueves']; }
            else { dias = [0, 2, 4]; nombres = ['Lunes', 'Mi√©rcoles', 'Viernes']; }

            let html = `<div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìÖ Programaci√≥n Anual</h3>
                    <button class="btn btn-secondary btn-sm" onclick="imprimirProgramacion()">üñ®Ô∏è Imprimir Todo</button>
                </div>

                <div class="cuadrante-nav">
                    <button class="nav-btn" onclick="cambiarMes(-1)">‚óÄ</button>
                    <select class="form-select" style="width:auto" onchange="mesActual=parseInt(this.value);renderProgramacion()">
                        ${MESES.map((m, i) => `<option value="${i}" ${i === mesActual ? 'selected' : ''}>${m.nombre}</option>`).join('')}
                    </select>
                    <button class="nav-btn" onclick="cambiarMes(1)">‚ñ∂</button>
                    <span class="trimestre-badge t${MESES[mesActual].trimestre}">T${MESES[mesActual].trimestre}</span>
                </div>

                <div style="overflow-x:auto">
                    <table class="cuadrante-table">
                        <thead><tr><th>Sem</th>${nombres.map(n => `<th>${n}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${Array.from({length: MESES[mesActual].semanas}, (_, sIdx) => {
                                const sem = sIdx + 1;
                                return `<tr><td>${sem}</td>${dias.map(dia => {
                                    const key = `${mesActual}_${sem}_${dia}`;
                                    const c = a.programacion?.[key];
                                    return renderCelda(a, key, c, dia);
                                }).join('')}</tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="printAllMonths" style="display:none"></div>`;

            container.innerHTML = html;
            generarTodosLosMeses(a, dias, nombres);
        }

        function generarTodosLosMeses(a, dias, nombres) {
            let html = '';
            MESES.forEach((mes, mIdx) => {
                html += `<div class="page-break" style="margin-top:20px">
                    <h3 style="margin-bottom:10px">${mes.nombre} - T${mes.trimestre}</h3>
                    <table class="cuadrante-table">
                        <thead><tr><th>Sem</th>${nombres.map(n => `<th>${n}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${Array.from({length: mes.semanas}, (_, sIdx) => {
                                const sem = sIdx + 1;
                                return `<tr><td>${sem}</td>${dias.map(dia => {
                                    const key = `${mIdx}_${sem}_${dia}`;
                                    const c = a.programacion?.[key];
                                    return renderCeldaPrint(a, c);
                                }).join('')}</tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
            });
            document.getElementById('printAllMonths').innerHTML = html;
        }

        function renderCelda(alumno, key, c, dia) {
            if (!c) return `<td class="celda celda-vacia" onclick="editarCelda('${key}', ${dia})">+</td>`;

            const obj = alumno.objetivos[c.oIdx];
            if (!obj) return `<td class="celda celda-vacia" onclick="editarCelda('${key}', ${dia})">?</td>`;

            const ind = obj.indicadores[c.iIdx] || '';
            const act = obj.actividades[c.aIdx] || '';

            return `<td class="celda" onclick="editarCelda('${key}', ${dia})">
                <div class="celda-obj">O${obj.numero}</div>
                <div class="celda-ind">${ind.substring(0, 35)}${ind.length > 35 ? '...' : ''}</div>
                <div class="celda-act">${act.substring(0, 25)}${act.length > 25 ? '...' : ''}</div>
            </td>`;
        }

        function renderCeldaPrint(alumno, c) {
            if (!c) return `<td class="celda-vacia">-</td>`;
            const obj = alumno.objetivos[c.oIdx];
            if (!obj) return `<td>?</td>`;
            const ind = obj.indicadores[c.iIdx] || '';
            const act = obj.actividades[c.aIdx] || '';
            return `<td><div class="celda-obj">O${obj.numero}</div><div class="celda-ind">${ind.substring(0, 30)}...</div></td>`;
        }

        function cambiarMes(dir) {
            mesActual = Math.max(0, Math.min(MESES.length - 1, mesActual + dir));
            renderProgramacion();
        }

        function editarCelda(key, dia) {
            celdaEditando = key;
            const a = window.alumnos[alumnoActual];
            const c = a.programacion?.[key] || {};

            document.getElementById('celdaTitulo').textContent = DIAS[dia];

            const sel = document.getElementById('selObjetivo');
            sel.innerHTML = '<option value="">Seleccionar...</option>';
            a.objetivos.forEach((obj, idx) => {
                sel.innerHTML += `<option value="${idx}" ${c.oIdx === idx ? 'selected' : ''}>O${obj.numero}: ${obj.descripcion.substring(0, 35)}...</option>`;
            });

            if (c.oIdx !== undefined) {
                cargarIndicadores();
                setTimeout(() => {
                    document.getElementById('selIndicador').value = c.iIdx ?? '';
                    document.getElementById('selActividad').value = c.aIdx ?? '';
                }, 50);
            } else {
                document.getElementById('selIndicador').innerHTML = '<option value="">-</option>';
                document.getElementById('selActividad').innerHTML = '<option value="">-</option>';
            }

            abrirModal('modalCelda');
        }

        function cargarIndicadores() {
            const a = window.alumnos[alumnoActual];
            const oIdx = document.getElementById('selObjetivo').value;
            const selI = document.getElementById('selIndicador');
            const selA = document.getElementById('selActividad');

            selI.innerHTML = '<option value="">Seleccionar...</option>';
            selA.innerHTML = '<option value="">Seleccionar...</option>';

            if (oIdx === '') return;

            const obj = a.objetivos[parseInt(oIdx)];
            obj.indicadores.forEach((ind, i) => selI.innerHTML += `<option value="${i}">${ind.substring(0, 45)}...</option>`);
            obj.actividades.forEach((act, i) => selA.innerHTML += `<option value="${i}">${act.substring(0, 45)}...</option>`);
        }

        function guardarCelda() {
            const oIdx = document.getElementById('selObjetivo').value;
            if (oIdx === '') { toast('Selecciona objetivo', 'error'); return; }

            const iIdx = document.getElementById('selIndicador').value;
            const aIdx = document.getElementById('selActividad').value;

            const data = {
                oIdx: parseInt(oIdx),
                iIdx: iIdx !== '' ? parseInt(iIdx) : 0,
                aIdx: aIdx !== '' ? parseInt(aIdx) : 0
            };

            window.dbSet(window.dbRef(window.db, `gestorpe/alumnos/${alumnoActual}/programacion/${celdaEditando}`), data);
            window.alumnos[alumnoActual].programacion[celdaEditando] = data;

            cerrarModal('modalCelda');
            renderProgramacion();
            toast('Guardado ‚úì', 'success');
        }

        function borrarCelda() {
            window.dbRemove(window.dbRef(window.db, `gestorpe/alumnos/${alumnoActual}/programacion/${celdaEditando}`));
            delete window.alumnos[alumnoActual].programacion[celdaEditando];
            cerrarModal('modalCelda');
            renderProgramacion();
            toast('Eliminado', 'success');
        }

        function imprimirProgramacion() {
            document.getElementById('printAllMonths').style.display = 'block';
            document.querySelector('.cuadrante-nav').style.display = 'none';
            document.querySelector('.cuadrante-table').style.display = 'none';
            window.print();
            setTimeout(() => {
                document.getElementById('printAllMonths').style.display = 'none';
                document.querySelector('.cuadrante-nav').style.display = 'flex';
                document.querySelector('.cuadrante-table').style.display = 'table';
            }, 500);
        }

        // ===== EVALUACI√ìN =====
        function renderEvaluacion() {
            const a = window.alumnos[alumnoActual];
            const container = document.getElementById('tabEvaluacion');

            let html = `<div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Evaluaci√≥n</h3>
                    <button class="btn btn-secondary btn-sm" onclick="imprimirEvaluacion()">üñ®Ô∏è Imprimir T${evalTrim}</button>
                </div>
                <div class="btn-group" style="margin-bottom:14px">
                    <button class="btn ${evalTrim === 1 ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="setTrim(1)">T1</button>
                    <button class="btn ${evalTrim === 2 ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="setTrim(2)">T2</button>
                    <button class="btn ${evalTrim === 3 ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="setTrim(3)">T3</button>
                </div>
                <div id="evalList"></div>
            </div>`;

            container.innerHTML = html;
            renderEvalList();
        }

        function setTrim(t) {
            evalTrim = t;
            renderEvaluacion();
        }

        function renderEvalList() {
            const a = window.alumnos[alumnoActual];
            const container = document.getElementById('evalList');

            let html = '';
            let hayIndicadores = false;

            a.objetivos.forEach((obj, oIdx) => {
                if (obj.trimestre !== evalTrim) return;
                hayIndicadores = true;

                html += `<div style="margin-bottom:14px">
                    <div style="font-weight:600;margin-bottom:6px;font-size:0.9rem">O${obj.numero}: ${obj.descripcion.substring(0, 45)}...</div>`;

                obj.indicadores.forEach((ind, iIdx) => {
                    const key = `${oIdx}_${iIdx}_T${evalTrim}`;
                    const estado = a.evaluaciones?.[key] || '';

                    html += `<div class="eval-item">
                        <span class="eval-text">${ind}</span>
                        <button class="eval-btn c ${estado === 'C' ? 'active' : ''}" onclick="setEval(${oIdx},${iIdx},'C')">‚úì</button>
                        <button class="eval-btn p ${estado === 'P' ? 'active' : ''}" onclick="setEval(${oIdx},${iIdx},'P')">‚óê</button>
                        <button class="eval-btn n ${estado === 'N' ? 'active' : ''}" onclick="setEval(${oIdx},${iIdx},'N')">‚óã</button>
                    </div>`;
                });

                html += '</div>';
            });

            container.innerHTML = hayIndicadores ? html : '<p style="text-align:center;color:var(--text-light)">No hay indicadores en este trimestre</p>';
        }

        function setEval(oIdx, iIdx, estado) {
            const a = window.alumnos[alumnoActual];
            const key = `${oIdx}_${iIdx}_T${evalTrim}`;

            if (!a.evaluaciones) a.evaluaciones = {};

            if (a.evaluaciones[key] === estado) {
                delete a.evaluaciones[key];
                window.dbRemove(window.dbRef(window.db, `gestorpe/alumnos/${alumnoActual}/evaluaciones/${key}`));
            } else {
                a.evaluaciones[key] = estado;
                window.dbSet(window.dbRef(window.db, `gestorpe/alumnos/${alumnoActual}/evaluaciones/${key}`), estado);
            }

            renderEvalList();
        }

        function imprimirEvaluacion() {
            window.print();
        }

        // ===== UTILS =====
        function abrirModal(id) { document.getElementById(id).classList.add('active'); }
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

        function toast(msg, tipo = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + tipo;
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
