<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a5f4a">
    <title>Gestor PE - Programas Espec√≠ficos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root {
            --primary: #1a5f4a;
            --primary-light: #2d8a6e;
            --primary-dark: #134536;
            --bg: #f5f7f6;
            --bg-card: #ffffff;
            --text: #1a2a24;
            --text-light: #5a6b64;
            --border: #d4ddd9;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --proceso: #3b82f6;
            --cognitivo: #8b5cf6;
            --linguistico: #06b6d4;
            --t1: #8b5cf6;
            --t2: #06b6d4;
            --t3: #f59e0b;
            --shadow: 0 4px 20px rgba(26, 95, 74, 0.1);
            --shadow-lg: 0 8px 40px rgba(26, 95, 74, 0.15);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        .status-dot.connected { background: var(--success); animation: none; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .btn-back {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-back:hover { background: rgba(255,255,255,0.25); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Alumnos Grid */
        .alumnos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 14px;
            margin-top: 16px;
        }

        .alumno-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            position: relative;
        }

        .alumno-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .alumno-siglas {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .alumno-curso { font-size: 0.8rem; color: var(--text-light); }

        .alumno-estado {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .alumno-estado.con-programa { background: var(--success); color: white; }
        .alumno-estado.sin-programa { background: var(--border); color: var(--text-light); }

        .alumno-card-add {
            background: transparent;
            border: 2px dashed var(--primary-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--primary);
            min-height: 100px;
        }

        .alumno-card-add:hover { background: rgba(26, 95, 74, 0.05); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 90px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 74, 0.1);
        }

        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: var(--bg); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        /* √Årea badges */
        .area-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .area-badge.cognitivo { background: rgba(139, 92, 246, 0.15); color: var(--cognitivo); }
        .area-badge.linguistico { background: rgba(6, 182, 212, 0.15); color: var(--linguistico); }

        .area-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .area-dot.cognitivo { background: var(--cognitivo); }
        .area-dot.linguistico { background: var(--linguistico); }

        /* Programa Section */
        .programa-section {
            margin-bottom: 24px;
            border-left: 4px solid var(--primary);
            padding-left: 16px;
        }

        .programa-section.cognitivo { border-left-color: var(--cognitivo); }
        .programa-section.linguistico { border-left-color: var(--linguistico); }

        .programa-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .programa-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .objetivo-item {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
        }

        .objetivo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .objetivo-badges { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }

        .objetivo-codigo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .objetivo-codigo.cognitivo { background: rgba(139, 92, 246, 0.15); color: var(--cognitivo); }
        .objetivo-codigo.linguistico { background: rgba(6, 182, 212, 0.15); color: var(--linguistico); }

        .trimestre-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .trimestre-badge.t1 { background: rgba(139, 92, 246, 0.15); color: var(--t1); }
        .trimestre-badge.t2 { background: rgba(6, 182, 212, 0.15); color: var(--t2); }
        .trimestre-badge.t3 { background: rgba(245, 158, 11, 0.15); color: var(--t3); }

        .objetivo-descripcion { font-weight: 500; font-size: 0.95rem; margin-bottom: 10px; }

        .indicador-item {
            background: white;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .indicador-bullet {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .indicador-bullet.cognitivo { background: var(--cognitivo); }
        .indicador-bullet.linguistico { background: var(--linguistico); }

        /* ========== CUADRANTE SEMANAL ========== */
        .cuadrante-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .semana-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .semana-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .semana-nav-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .semana-nav-btn:hover { border-color: var(--primary); color: var(--primary); }

        .semana-titulo {
            font-weight: 700;
            font-size: 1rem;
            min-width: 200px;
            text-align: center;
        }

        .cuadrante {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 2px;
            background: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            min-width: 700px;
        }

        .cuadrante-header {
            background: var(--primary);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .cuadrante-dia {
            background: var(--primary-light);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .cuadrante-celda {
            background: white;
            padding: 8px;
            min-height: 100px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .cuadrante-celda:hover { background: var(--bg); }

        .cuadrante-celda.empty {
            background: #f9fafb;
        }

        .celda-contenido {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .celda-area {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .celda-objetivo {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .celda-indicador {
            color: var(--text);
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .celda-actividad {
            color: var(--text-light);
            font-size: 0.7rem;
            font-style: italic;
        }

        .celda-add {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: var(--bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .cuadrante-celda:hover .celda-add { opacity: 1; }

        /* Leyenda */
        .leyenda {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-light); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* Empty state */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

        /* Alumno info */
        .alumno-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .alumno-info-siglas {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            background: rgba(26, 95, 74, 0.1);
            padding: 14px 20px;
            border-radius: var(--radius);
        }

        .alumno-info-details { flex: 1; }
        .alumno-info-curso { font-size: 1.1rem; font-weight: 600; }
        .alumno-info-programas { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-primary { background: rgba(26, 95, 74, 0.1); color: var(--primary); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        /* Loading */
        .loading { display: flex; flex-direction: column; align-items: center; padding: 40px; gap: 12px; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .instrucciones-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }

        /* Evaluaci√≥n */
        .eval-periodo { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }

        .eval-periodo-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .eval-periodo-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .eval-indicador {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .eval-indicador-text { flex: 1; min-width: 180px; font-size: 0.9rem; }
        .eval-estados { display: flex; gap: 6px; }

        .eval-estado-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border);
            border-radius: 50%;
            background: white;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .eval-estado-btn.conseguido { border-color: var(--success); color: var(--success); }
        .eval-estado-btn.conseguido.active { background: var(--success); color: white; }
        .eval-estado-btn.proceso { border-color: var(--proceso); color: var(--proceso); }
        .eval-estado-btn.proceso.active { background: var(--proceso); color: white; }
        .eval-estado-btn.no-iniciado { border-color: var(--text-light); color: var(--text-light); }
        .eval-estado-btn.no-iniciado.active { background: var(--text-light); color: white; }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 20px; }
        .chart-container { background: var(--bg); border-radius: var(--radius-sm); padding: 16px; text-align: center; }
        .chart-title { font-weight: 600; margin-bottom: 12px; color: var(--primary-dark); font-size: 0.95rem; }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(26, 95, 74, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(26, 95, 74, 0.1);
        }

        .upload-zone.has-file {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .upload-zone span {
            display: block;
            color: var(--text-light);
        }

        .upload-zone.has-file span {
            color: var(--success);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.2rem; }
            .cuadrante { min-width: 600px; }
            .alumno-info { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üìã Gestor PE</h1>
            <div class="header-right">
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                <button class="btn-back" id="btnVolver" style="display: none;" onclick="volverInicio()">‚Üê Volver</button>
            </div>
        </div>
    </header>

    <!-- Pantalla Principal -->
    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Alumnos</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="abrirModalSubirPDF()">ü§ñ Subir PDF con IA</button>
                        <button class="btn btn-secondary btn-sm" onclick="abrirModalImportJSON()">üì• JSON</button>
                        <button class="btn btn-secondary btn-sm" onclick="abrirModal('modalConfig')" title="Configurar API">‚öôÔ∏è</button>
                    </div>
                </div>
                <div class="alumnos-grid" id="alumnosGrid">
                    <div class="loading"><div class="spinner"></div><span>Cargando...</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla Alumno -->
    <div id="screenAlumno" class="screen">
        <div class="container">
            <div class="alumno-info" id="alumnoInfoHeader"></div>

            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('programa', this)">üìÑ Programa</button>
                <button class="tab" onclick="cambiarTab('programacion', this)">üìÖ Programaci√≥n</button>
                <button class="tab" onclick="cambiarTab('evaluacion', this)">üìä Evaluaci√≥n</button>
            </div>

            <div id="tabPrograma" class="tab-content active">
                <div id="programaContent"></div>
            </div>

            <div id="tabProgramacion" class="tab-content">
                <div id="programacionContent"></div>
            </div>

            <div id="tabEvaluacion" class="tab-content">
                <div id="evaluacionContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal A√±adir Alumno -->
    <div class="modal-overlay" id="modalAlumno">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">A√±adir Alumno</h3>
                <button class="modal-close" onclick="cerrarModal('modalAlumno')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Siglas *</label>
                    <input type="text" class="form-input" id="inputSiglas" placeholder="A.G.M." maxlength="10">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Curso *</label>
                        <select class="form-select" id="inputCurso">
                            <option value="">Seleccionar...</option>
                            <option value="Infantil 3 a√±os">Infantil 3 a√±os</option>
                            <option value="Infantil 4 a√±os">Infantil 4 a√±os</option>
                            <option value="Infantil 5 a√±os">Infantil 5 a√±os</option>
                            <option value="1¬∫ Primaria">1¬∫ Primaria</option>
                            <option value="2¬∫ Primaria">2¬∫ Primaria</option>
                            <option value="3¬∫ Primaria">3¬∫ Primaria</option>
                            <option value="4¬∫ Primaria">4¬∫ Primaria</option>
                            <option value="5¬∫ Primaria">5¬∫ Primaria</option>
                            <option value="6¬∫ Primaria">6¬∫ Primaria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sesiones/semana</label>
                        <select class="form-select" id="inputSesiones">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalAlumno')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarAlumno()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Importar JSON -->
    <div class="modal-overlay" id="modalImportJSON">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üì• Importar JSON</h3>
                <button class="modal-close" onclick="cerrarModal('modalImportJSON')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="instrucciones-box">
                    Pega el JSON generado por Claude con los programas del alumno.
                </div>
                <textarea class="form-textarea" id="inputImportJSON" rows="12" placeholder='{"siglas": "V.R.F.", "programas": [...]}'></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalImportJSON')">Cancelar</button>
                <button class="btn btn-primary" onclick="importarJSON()">üì• Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Celda -->
    <div class="modal-overlay" id="modalCelda">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalCeldaTitulo">Editar Sesi√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalCelda')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">√Årea</label>
                    <select class="form-select" id="celdaArea">
                        <option value="cognitivo">üß† Cognitivo</option>
                        <option value="linguistico">üí¨ Ling√º√≠stico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Objetivo</label>
                    <select class="form-select" id="celdaObjetivo">
                        <option value="">Seleccionar objetivo...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Indicador</label>
                    <select class="form-select" id="celdaIndicador">
                        <option value="">Seleccionar indicador...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Actividad</label>
                    <textarea class="form-textarea" id="celdaActividad" rows="3" placeholder="Describe la actividad..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="limpiarCelda()">üóëÔ∏è Limpiar</button>
                <button class="btn btn-secondary" onclick="cerrarModal('modalCelda')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCelda()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Modal Configuraci√≥n API -->
    <div class="modal-overlay" id="modalConfig">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Configuraci√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalConfig')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="instrucciones-box">
                    <strong>üîë API Key de Gemini (gratuita)</strong><br>
                    1. Ve a <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
                    2. Crea una API Key<br>
                    3. P√©gala aqu√≠
                </div>
                <div class="form-group">
                    <label class="form-label">API Key de Gemini</label>
                    <input type="password" class="form-input" id="inputApiKey" placeholder="AIza...">
                </div>
                <div id="apiKeyStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalConfig')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarApiKey()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Subir PDF con IA -->
    <div class="modal-overlay" id="modalSubirPDF">
        <div class="modal" style="max-width:550px">
            <div class="modal-header">
                <h3 class="modal-title">ü§ñ Procesar PDF con IA</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirPDF')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Siglas del alumno *</label>
                    <input type="text" class="form-input" id="pdfSiglas" placeholder="V.R.F." maxlength="10">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Curso *</label>
                        <select class="form-select" id="pdfCurso">
                            <option value="Infantil 3 a√±os">Infantil 3 a√±os</option>
                            <option value="Infantil 4 a√±os">Infantil 4 a√±os</option>
                            <option value="Infantil 5 a√±os">Infantil 5 a√±os</option>
                            <option value="1¬∫ Primaria" selected>1¬∫ Primaria</option>
                            <option value="2¬∫ Primaria">2¬∫ Primaria</option>
                            <option value="3¬∫ Primaria">3¬∫ Primaria</option>
                            <option value="4¬∫ Primaria">4¬∫ Primaria</option>
                            <option value="5¬∫ Primaria">5¬∫ Primaria</option>
                            <option value="6¬∫ Primaria">6¬∫ Primaria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sesiones/semana</label>
                        <select class="form-select" id="pdfSesiones">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">√Åreas a extraer</label>
                    <div style="display:flex;gap:12px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="checkbox" id="areaCognitivo" checked> üß† Cognitivo
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="checkbox" id="areaLinguistico" checked> üí¨ Ling√º√≠stico
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">A√±adir contenidos curriculares de Andaluc√≠a</label>
                    <div style="display:flex;gap:12px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="checkbox" id="curriculoLectura"> üìñ Lectura (vocales‚Üítrabadas)
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="checkbox" id="curriculoNumeros"> üî¢ Numeraci√≥n (0-50)
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Archivo PDF del programa espec√≠fico *</label>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('inputPDF').click()">
                        <input type="file" id="inputPDF" accept=".pdf" style="display:none" onchange="pdfSeleccionado(this)">
                        <div id="uploadZoneContent">
                            <span style="font-size:2rem">üìÑ</span>
                            <span>Clic o arrastra el PDF aqu√≠</span>
                        </div>
                    </div>
                </div>
                <div id="pdfProcesando" style="display:none">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span id="pdfProcesoTexto">Procesando con Gemini...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalSubirPDF')">Cancelar</button>
                <button class="btn btn-primary" id="btnProcesarPDF" onclick="procesarPDFConIA()" disabled>ü§ñ Procesar</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7NgtJ1lUecZr5LR3jK1wURfzNIakJ1-8",
            authDomain: "gestorpt-7946b.firebaseapp.com",
            databaseURL: "https://gestorpt-7946b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestorpt-7946b",
            storageBucket: "gestorpt-7946b.firebasestorage.app",
            messagingSenderId: "415895342026",
            appId: "1:415895342026:web:c516c24d7dc27cc89d1d33"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.database = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbPush = push;
        window.dbOnValue = onValue;
        window.dbRemove = remove;

        window.initApp();
    </script>

    <script>
        let alumnos = {};
        let alumnoActual = null;
        let semanaActual = 1;
        let mesActual = 0;
        let celdaEditando = null;
        let chartPie = null;
        let chartBar = null;
        let trimestreEval = 1;

        const DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
        const MESES = [
            { nombre: 'Septiembre', semanas: 4, trimestre: 1 },
            { nombre: 'Octubre', semanas: 4, trimestre: 1 },
            { nombre: 'Noviembre', semanas: 4, trimestre: 1 },
            { nombre: 'Diciembre', semanas: 3, trimestre: 1 },
            { nombre: 'Enero', semanas: 4, trimestre: 2 },
            { nombre: 'Febrero', semanas: 4, trimestre: 2 },
            { nombre: 'Marzo', semanas: 4, trimestre: 2 },
            { nombre: 'Abril', semanas: 4, trimestre: 3 },
            { nombre: 'Mayo', semanas: 4, trimestre: 3 },
            { nombre: 'Junio', semanas: 3, trimestre: 3 }
        ];

        window.initApp = function() {
            const alumnosRef = window.dbRef(window.database, 'alumnos');
            window.dbOnValue(alumnosRef, (snapshot) => {
                alumnos = snapshot.val() || {};
                renderizarAlumnos();
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Conectado';
            }, (error) => {
                document.getElementById('statusText').textContent = 'Error';
                document.getElementById('alumnosGrid').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error de conexi√≥n</p></div>`;
            });
        };

        function renderizarAlumnos() {
            const grid = document.getElementById('alumnosGrid');
            const arr = Object.entries(alumnos);
            
            if (arr.length === 0) {
                grid.innerHTML = `<div class="alumno-card alumno-card-add" onclick="abrirModal('modalAlumno')"><span style="font-size:1.5rem">‚ûï</span><span>A√±adir</span></div>`;
                return;
            }

            let html = '';
            arr.forEach(([id, a]) => {
                const tiene = a.programas?.length > 0;
                html += `<div class="alumno-card ${!tiene ? 'sin-programa' : ''}" onclick="abrirAlumno('${id}')">
                    <div class="alumno-estado ${tiene ? 'con-programa' : 'sin-programa'}">${tiene ? '‚úì' : '‚óã'}</div>
                    <div class="alumno-siglas">${a.siglas}</div>
                    <div class="alumno-curso">${a.curso}</div>
                </div>`;
            });
            html += `<div class="alumno-card alumno-card-add" onclick="abrirModal('modalAlumno')"><span style="font-size:1.5rem">‚ûï</span><span>A√±adir</span></div>`;
            grid.innerHTML = html;
        }

        function abrirAlumno(id) {
            alumnoActual = id;
            const a = alumnos[id];
            semanaActual = 1;
            mesActual = 0;

            document.getElementById('screenInicio').classList.remove('active');
            document.getElementById('screenAlumno').classList.add('active');
            document.getElementById('btnVolver').style.display = 'flex';

            let programasBadges = '';
            if (a.programas) {
                a.programas.forEach(p => {
                    programasBadges += `<span class="area-badge ${p.area}"><span class="area-dot ${p.area}"></span>${p.tipo}</span>`;
                });
            }

            document.getElementById('alumnoInfoHeader').innerHTML = `
                <div class="alumno-info-siglas">${a.siglas}</div>
                <div class="alumno-info-details">
                    <div class="alumno-info-curso">${a.curso}</div>
                    <div class="alumno-info-programas">${programasBadges || '<span class="badge badge-primary">Sin programas</span>'}</div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="eliminarAlumno('${id}')">üóëÔ∏è</button>
            `;

            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === 0));
            document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === 0));

            renderizarPrograma();
            renderizarProgramacion();
            renderizarEvaluacion();
        }

        function volverInicio() {
            alumnoActual = null;
            document.getElementById('screenAlumno').classList.remove('active');
            document.getElementById('screenInicio').classList.add('active');
            document.getElementById('btnVolver').style.display = 'none';
        }

        function cambiarTab(tab, btn) {
            btn.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            if (tab === 'evaluacion') setTimeout(renderizarGraficas, 100);
        }

        // ========== PROGRAMA ==========
        function renderizarPrograma() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('programaContent');

            if (!a.programas?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No hay programas cargados</p>
                    <button class="btn btn-primary" onclick="abrirModal('modalImportJSON')">üì• Importar JSON</button></div>`;
                return;
            }

            let html = '';
            a.programas.forEach((prog, pIdx) => {
                html += `<div class="programa-section ${prog.area}">
                    <div class="programa-header">
                        <span class="area-badge ${prog.area}"><span class="area-dot ${prog.area}"></span>${prog.tipo}</span>
                        <span style="color:var(--text-light);font-size:0.85rem">${prog.objetivos?.length || 0} objetivos</span>
                    </div>`;

                (prog.objetivos || []).forEach((obj, oIdx) => {
                    html += `<div class="objetivo-item">
                        <div class="objetivo-header">
                            <div class="objetivo-badges">
                                <span class="objetivo-codigo ${prog.area}">${prog.area === 'cognitivo' ? 'C' : 'L'}.${oIdx + 1}</span>
                                <span class="trimestre-badge t${obj.trimestre || 1}">T${obj.trimestre || 1}</span>
                            </div>
                        </div>
                        <div class="objetivo-descripcion">${obj.descripcion}</div>
                        <div style="margin-top:8px">`;
                    
                    (obj.indicadores || []).forEach(ind => {
                        html += `<div class="indicador-item">
                            <div class="indicador-bullet ${prog.area}"></div>
                            <span>${ind.descripcion}</span>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                html += `</div>`;
            });

            html += `<div class="btn-group" style="margin-top:20px">
                <button class="btn btn-primary" onclick="generarProgramacion()">üìÖ Generar Programaci√≥n</button>
            </div>`;

            container.innerHTML = html;
        }

        // ========== PROGRAMACI√ìN CON CUADRANTE ==========
        function renderizarProgramacion() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('programacionContent');

            if (!a.programas?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Primero importa los programas</p></div>`;
                return;
            }

            const mes = MESES[mesActual];
            const trimestre = mes.trimestre;

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìÖ Programaci√≥n Semanal</h3>
                        <button class="btn btn-secondary btn-sm" onclick="generarProgramacion()">üîÑ Regenerar</button>
                    </div>

                    <div class="semana-selector">
                        <div class="semana-nav">
                            <button class="semana-nav-btn" onclick="cambiarMes(-1)">‚óÄ</button>
                            <select class="form-select" style="width:auto" onchange="mesActual=parseInt(this.value);semanaActual=1;renderizarProgramacion()">
                                ${MESES.map((m, i) => `<option value="${i}" ${i === mesActual ? 'selected' : ''}>${m.nombre}</option>`).join('')}
                            </select>
                            <button class="semana-nav-btn" onclick="cambiarMes(1)">‚ñ∂</button>
                        </div>
                        <div class="semana-nav">
                            <button class="semana-nav-btn" onclick="cambiarSemana(-1)">‚óÄ</button>
                            <span class="semana-titulo">Semana ${semanaActual} de ${mes.semanas}</span>
                            <button class="semana-nav-btn" onclick="cambiarSemana(1)">‚ñ∂</button>
                        </div>
                        <span class="trimestre-badge t${trimestre}">T${trimestre}</span>
                    </div>

                    <div class="cuadrante-container">
                        <div class="cuadrante">
                            <div class="cuadrante-header"></div>
                            ${[1,2,3,4,5].map(s => `<div class="cuadrante-header">Sesi√≥n ${s}</div>`).join('')}
                            ${DIAS.map((dia, dIdx) => {
                                let row = `<div class="cuadrante-dia">${dia}</div>`;
                                for (let s = 1; s <= 5; s++) {
                                    const clave = `${mesActual}_${semanaActual}_${dIdx}_${s}`;
                                    const celda = a.programacion?.[clave];
                                    row += renderizarCelda(celda, clave, dIdx, s);
                                }
                                return row;
                            }).join('')}
                        </div>
                    </div>

                    <div class="leyenda">
                        <div class="leyenda-item"><span class="area-dot cognitivo"></span> Cognitivo</div>
                        <div class="leyenda-item"><span class="area-dot linguistico"></span> Ling√º√≠stico</div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderizarCelda(celda, clave, dia, sesion) {
            if (!celda) {
                return `<div class="cuadrante-celda empty" onclick="editarCelda('${clave}', ${dia}, ${sesion})">
                    <div class="celda-add">+</div>
                </div>`;
            }

            return `<div class="cuadrante-celda" onclick="editarCelda('${clave}', ${dia}, ${sesion})">
                <div class="celda-contenido">
                    <div class="celda-objetivo"><span class="celda-area" style="background:var(--${celda.area})"></span>${celda.objetivo || ''}</div>
                    <div class="celda-indicador">${celda.indicador || ''}</div>
                    <div class="celda-actividad">${celda.actividad || ''}</div>
                </div>
            </div>`;
        }

        function cambiarMes(dir) {
            mesActual = Math.max(0, Math.min(MESES.length - 1, mesActual + dir));
            semanaActual = 1;
            renderizarProgramacion();
        }

        function cambiarSemana(dir) {
            const max = MESES[mesActual].semanas;
            semanaActual = Math.max(1, Math.min(max, semanaActual + dir));
            renderizarProgramacion();
        }

        function editarCelda(clave, dia, sesion) {
            celdaEditando = clave;
            const a = alumnos[alumnoActual];
            const celda = a.programacion?.[clave] || {};

            document.getElementById('modalCeldaTitulo').textContent = `${DIAS[dia]} - Sesi√≥n ${sesion}`;
            document.getElementById('celdaArea').value = celda.area || 'cognitivo';
            document.getElementById('celdaActividad').value = celda.actividad || '';

            actualizarSelectObjetivos();
            
            if (celda.objetivoIdx !== undefined) {
                document.getElementById('celdaObjetivo').value = `${celda.area}_${celda.objetivoIdx}`;
                actualizarSelectIndicadores();
                if (celda.indicadorIdx !== undefined) {
                    document.getElementById('celdaIndicador').value = celda.indicadorIdx;
                }
            }

            abrirModal('modalCelda');
        }

        function actualizarSelectObjetivos() {
            const a = alumnos[alumnoActual];
            const area = document.getElementById('celdaArea').value;
            const select = document.getElementById('celdaObjetivo');
            const trimestre = MESES[mesActual].trimestre;

            select.innerHTML = '<option value="">Seleccionar objetivo...</option>';
            
            const prog = a.programas?.find(p => p.area === area);
            if (prog?.objetivos) {
                prog.objetivos.forEach((obj, idx) => {
                    if ((obj.trimestre || 1) === trimestre) {
                        const codigo = area === 'cognitivo' ? 'C' : 'L';
                        select.innerHTML += `<option value="${area}_${idx}">${codigo}.${idx + 1}: ${obj.descripcion.substring(0, 40)}...</option>`;
                    }
                });
            }

            document.getElementById('celdaIndicador').innerHTML = '<option value="">Seleccionar indicador...</option>';
        }

        function actualizarSelectIndicadores() {
            const a = alumnos[alumnoActual];
            const [area, objIdx] = (document.getElementById('celdaObjetivo').value || '_').split('_');
            const select = document.getElementById('celdaIndicador');

            select.innerHTML = '<option value="">Seleccionar indicador...</option>';

            if (!area || objIdx === '') return;

            const prog = a.programas?.find(p => p.area === area);
            const obj = prog?.objetivos?.[parseInt(objIdx)];
            
            if (obj?.indicadores) {
                obj.indicadores.forEach((ind, idx) => {
                    select.innerHTML += `<option value="${idx}">${ind.descripcion.substring(0, 50)}...</option>`;
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('celdaArea')?.addEventListener('change', actualizarSelectObjetivos);
            document.getElementById('celdaObjetivo')?.addEventListener('change', actualizarSelectIndicadores);
        });

        function guardarCelda() {
            const a = alumnos[alumnoActual];
            const area = document.getElementById('celdaArea').value;
            const objVal = document.getElementById('celdaObjetivo').value;
            const indVal = document.getElementById('celdaIndicador').value;
            const actividad = document.getElementById('celdaActividad').value.trim();

            if (!objVal) {
                mostrarToast('Selecciona un objetivo', 'error');
                return;
            }

            const [_, objIdx] = objVal.split('_');
            const prog = a.programas?.find(p => p.area === area);
            const obj = prog?.objetivos?.[parseInt(objIdx)];
            const ind = indVal !== '' ? obj?.indicadores?.[parseInt(indVal)] : null;

            const codigo = area === 'cognitivo' ? 'C' : 'L';
            const celda = {
                area,
                objetivoIdx: parseInt(objIdx),
                objetivo: `${codigo}.${parseInt(objIdx) + 1}`,
                objetivoDesc: obj?.descripcion || '',
                indicadorIdx: indVal !== '' ? parseInt(indVal) : null,
                indicador: ind?.descripcion || '',
                actividad: actividad || ind?.actividades?.[0] || ''
            };

            if (!a.programacion) a.programacion = {};
            a.programacion[celdaEditando] = celda;

            const progRef = window.dbRef(window.database, `alumnos/${alumnoActual}/programacion`);
            window.dbSet(progRef, a.programacion).then(() => {
                cerrarModal('modalCelda');
                renderizarProgramacion();
                mostrarToast('Sesi√≥n guardada', 'success');
            });
        }

        function limpiarCelda() {
            const a = alumnos[alumnoActual];
            if (a.programacion?.[celdaEditando]) {
                delete a.programacion[celdaEditando];
                const progRef = window.dbRef(window.database, `alumnos/${alumnoActual}/programacion`);
                window.dbSet(progRef, a.programacion).then(() => {
                    cerrarModal('modalCelda');
                    renderizarProgramacion();
                    mostrarToast('Sesi√≥n eliminada', 'success');
                });
            }
        }

        function generarProgramacion() {
            const a = alumnos[alumnoActual];
            if (!a.programas?.length) {
                mostrarToast('Primero importa los programas', 'error');
                return;
            }

            const sesiones = parseInt(a.sesionesSemana) || 3;
            const programacion = {};

            // Para cada mes
            MESES.forEach((mes, mIdx) => {
                const trimestre = mes.trimestre;
                
                // Obtener objetivos del trimestre de ambas √°reas
                let pool = [];
                a.programas.forEach(prog => {
                    (prog.objetivos || []).forEach((obj, oIdx) => {
                        if ((obj.trimestre || 1) === trimestre) {
                            (obj.indicadores || []).forEach((ind, iIdx) => {
                                (ind.actividades || ['Actividad seg√∫n indicador']).forEach(act => {
                                    pool.push({
                                        area: prog.area,
                                        objetivoIdx: oIdx,
                                        objetivo: `${prog.area === 'cognitivo' ? 'C' : 'L'}.${oIdx + 1}`,
                                        objetivoDesc: obj.descripcion,
                                        indicadorIdx: iIdx,
                                        indicador: ind.descripcion,
                                        actividad: act
                                    });
                                });
                            });
                        }
                    });
                });

                if (pool.length === 0) return;

                // Mezclar alternando √°reas
                const cognitivo = pool.filter(p => p.area === 'cognitivo').sort(() => Math.random() - 0.5);
                const linguistico = pool.filter(p => p.area === 'linguistico').sort(() => Math.random() - 0.5);
                
                let poolAlternado = [];
                const max = Math.max(cognitivo.length, linguistico.length);
                for (let i = 0; i < max; i++) {
                    if (cognitivo[i]) poolAlternado.push(cognitivo[i]);
                    if (linguistico[i]) poolAlternado.push(linguistico[i]);
                }

                let idx = 0;

                // Para cada semana del mes
                for (let sem = 1; sem <= mes.semanas; sem++) {
                    // Para cada d√≠a
                    for (let dia = 0; dia < 5; dia++) {
                        // Para cada sesi√≥n (seg√∫n sesiones/semana, distribuidas en la semana)
                        for (let ses = 1; ses <= 5; ses++) {
                            // Solo llenar las sesiones configuradas (ej: 3 sesiones = 3 primeras)
                            if (ses <= sesiones && dia < sesiones) {
                                const clave = `${mIdx}_${sem}_${dia}_${ses}`;
                                programacion[clave] = { ...poolAlternado[idx % poolAlternado.length] };
                                idx++;
                            }
                        }
                    }
                }
            });

            a.programacion = programacion;

            const progRef = window.dbRef(window.database, `alumnos/${alumnoActual}/programacion`);
            window.dbSet(progRef, programacion).then(() => {
                mostrarToast('Programaci√≥n generada', 'success');
                renderizarProgramacion();
                document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === 1));
                document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === 1));
            });
        }

        // ========== EVALUACI√ìN ==========
        function renderizarEvaluacion() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('evaluacionContent');

            if (!a.programas?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No hay programas</p></div>`;
                return;
            }

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Evaluaci√≥n</h3>
                    </div>
                    <div class="eval-periodo">
                        ${[1,2,3].map(t => `<button class="eval-periodo-btn ${trimestreEval === t ? 'active' : ''}" onclick="trimestreEval=${t};renderizarEvaluacion()">T${t}</button>`).join('')}
                    </div>
                    <div id="evalIndicadores">${renderizarIndicadoresEval()}</div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container"><div class="chart-title">Estados</div><canvas id="chartPie"></canvas></div>
                    <div class="chart-container"><div class="chart-title">Progreso</div><canvas id="chartBar"></canvas></div>
                </div>
            `;

            container.innerHTML = html;
            setTimeout(renderizarGraficas, 100);
        }

        function renderizarIndicadoresEval() {
            const a = alumnos[alumnoActual];
            let html = '';

            a.programas?.forEach(prog => {
                const objetivosTrimestre = (prog.objetivos || []).filter(o => (o.trimestre || 1) === trimestreEval);
                if (objetivosTrimestre.length === 0) return;

                html += `<h4 style="margin:16px 0 10px;display:flex;align-items:center;gap:8px">
                    <span class="area-dot ${prog.area}"></span>${prog.tipo}</h4>`;

                objetivosTrimestre.forEach((obj, oIdx) => {
                    const realIdx = prog.objetivos.indexOf(obj);
                    const codigo = prog.area === 'cognitivo' ? 'C' : 'L';
                    
                    html += `<p style="font-weight:600;font-size:0.9rem;margin:12px 0 8px">${codigo}.${realIdx + 1}: ${obj.descripcion.substring(0, 50)}...</p>`;

                    (obj.indicadores || []).forEach((ind, iIdx) => {
                        const estado = ind.evaluaciones?.[`T${trimestreEval}`]?.estado || '';
                        html += `
                            <div class="eval-indicador">
                                <div class="eval-indicador-text">${ind.descripcion}</div>
                                <div class="eval-estados">
                                    <button class="eval-estado-btn conseguido ${estado === 'conseguido' ? 'active' : ''}" 
                                        onclick="marcarEstado('${prog.area}', ${realIdx}, ${iIdx}, 'conseguido')">‚úì</button>
                                    <button class="eval-estado-btn proceso ${estado === 'proceso' ? 'active' : ''}" 
                                        onclick="marcarEstado('${prog.area}', ${realIdx}, ${iIdx}, 'proceso')">‚óê</button>
                                    <button class="eval-estado-btn no-iniciado ${estado === 'no-iniciado' ? 'active' : ''}" 
                                        onclick="marcarEstado('${prog.area}', ${realIdx}, ${iIdx}, 'no-iniciado')">‚óã</button>
                                </div>
                            </div>
                        `;
                    });
                });
            });

            return html || '<p style="text-align:center;color:var(--text-light)">No hay objetivos en este trimestre</p>';
        }

        function marcarEstado(area, objIdx, indIdx, estado) {
            const a = alumnos[alumnoActual];
            const prog = a.programas?.find(p => p.area === area);
            if (!prog) return;

            if (!prog.objetivos[objIdx].indicadores[indIdx].evaluaciones) {
                prog.objetivos[objIdx].indicadores[indIdx].evaluaciones = {};
            }
            prog.objetivos[objIdx].indicadores[indIdx].evaluaciones[`T${trimestreEval}`] = {
                estado,
                fecha: new Date().toISOString()
            };

            const ref = window.dbRef(window.database, `alumnos/${alumnoActual}/programas`);
            window.dbSet(ref, a.programas).then(() => {
                document.getElementById('evalIndicadores').innerHTML = renderizarIndicadoresEval();
                renderizarGraficas();
                mostrarToast('Guardado', 'success');
            });
        }

        function renderizarGraficas() {
            const a = alumnos[alumnoActual];
            if (!a.programas) return;

            let conseguido = 0, proceso = 0, noIniciado = 0, sinEvaluar = 0;
            let porArea = { cognitivo: { total: 0, conseguido: 0 }, linguistico: { total: 0, conseguido: 0 } };

            a.programas.forEach(prog => {
                (prog.objetivos || []).filter(o => (o.trimestre || 1) === trimestreEval).forEach(obj => {
                    (obj.indicadores || []).forEach(ind => {
                        const estado = ind.evaluaciones?.[`T${trimestreEval}`]?.estado;
                        porArea[prog.area].total++;
                        if (estado === 'conseguido') { conseguido++; porArea[prog.area].conseguido++; }
                        else if (estado === 'proceso') proceso++;
                        else if (estado === 'no-iniciado') noIniciado++;
                        else sinEvaluar++;
                    });
                });
            });

            const ctxPie = document.getElementById('chartPie');
            if (ctxPie) {
                if (chartPie) chartPie.destroy();
                chartPie = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ['Conseguido', 'En proceso', 'No iniciado', 'Sin evaluar'],
                        datasets: [{ data: [conseguido, proceso, noIniciado, sinEvaluar], backgroundColor: ['#22c55e', '#3b82f6', '#9ca3af', '#e5e7eb'] }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });
            }

            const ctxBar = document.getElementById('chartBar');
            if (ctxBar) {
                if (chartBar) chartBar.destroy();
                chartBar = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: ['Cognitivo', 'Ling√º√≠stico'],
                        datasets: [{
                            label: '% Conseguido',
                            data: [
                                porArea.cognitivo.total ? Math.round(porArea.cognitivo.conseguido / porArea.cognitivo.total * 100) : 0,
                                porArea.linguistico.total ? Math.round(porArea.linguistico.conseguido / porArea.linguistico.total * 100) : 0
                            ],
                            backgroundColor: ['#8b5cf6', '#06b6d4']
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
                });
            }
        }

        // ========== MODALES ==========
        function abrirModal(id) { document.getElementById(id).classList.add('active'); }
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

        function guardarAlumno() {
            const siglas = document.getElementById('inputSiglas').value.trim().toUpperCase();
            const curso = document.getElementById('inputCurso').value;
            if (!siglas || !curso) { mostrarToast('Completa los campos', 'error'); return; }

            const nuevo = {
                siglas,
                curso,
                sesionesSemana: parseInt(document.getElementById('inputSesiones').value),
                fechaCreacion: new Date().toISOString()
            };

            window.dbPush(window.dbRef(window.database, 'alumnos'), nuevo).then(() => {
                cerrarModal('modalAlumno');
                document.getElementById('inputSiglas').value = '';
                mostrarToast('Alumno a√±adido', 'success');
            });
        }

        function importarJSON() {
            const texto = document.getElementById('inputImportJSON').value.trim();
            if (!texto) { mostrarToast('Pega el JSON', 'error'); return; }

            try {
                const data = JSON.parse(texto);
                if (!data.siglas) { mostrarToast('Falta "siglas"', 'error'); return; }

                const nuevo = {
                    siglas: data.siglas.toUpperCase(),
                    curso: data.curso || '1¬∫ Primaria',
                    sesionesSemana: parseInt(data.sesionesSemana) || 3,
                    fechaCreacion: new Date().toISOString(),
                    programas: (data.programas || []).map(prog => ({
                        tipo: prog.tipo,
                        area: prog.area || 'cognitivo',
                        color: prog.color,
                        objetivos: (prog.objetivos || []).map(obj => ({
                            descripcion: obj.descripcion,
                            trimestre: obj.trimestre || 1,
                            contenidos: obj.contenidos || [],
                            indicadores: (obj.indicadores || []).map(ind => ({
                                descripcion: typeof ind === 'string' ? ind : ind.descripcion,
                                actividades: ind.actividades || [],
                                evaluaciones: {}
                            }))
                        }))
                    }))
                };

                window.dbPush(window.dbRef(window.database, 'alumnos'), nuevo).then(() => {
                    cerrarModal('modalImportJSON');
                    document.getElementById('inputImportJSON').value = '';
                    mostrarToast(`${nuevo.siglas} importado`, 'success');
                });
            } catch (e) {
                mostrarToast('Error JSON: ' + e.message, 'error');
            }
        }

        function eliminarAlumno(id) {
            if (!confirm('¬øEliminar alumno?')) return;
            window.dbRemove(window.dbRef(window.database, `alumnos/${id}`)).then(() => {
                volverInicio();
                mostrarToast('Eliminado', 'success');
            });
        }

        function mostrarToast(msg, tipo = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + tipo + ' show';
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ========== CONFIGURACI√ìN API ==========
        function cargarApiKey() {
            const key = localStorage.getItem('gemini_api_key') || '';
            document.getElementById('inputApiKey').value = key;
            actualizarEstadoApiKey();
        }

        function guardarApiKey() {
            const key = document.getElementById('inputApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                mostrarToast('API Key guardada', 'success');
                cerrarModal('modalConfig');
            } else {
                localStorage.removeItem('gemini_api_key');
                mostrarToast('API Key eliminada', 'success');
            }
            actualizarEstadoApiKey();
        }

        function actualizarEstadoApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            const status = document.getElementById('apiKeyStatus');
            if (key) {
                status.innerHTML = '<span style="color:var(--success)">‚úì API Key configurada</span>';
            } else {
                status.innerHTML = '<span style="color:var(--text-light)">Sin configurar</span>';
            }
        }

        // ========== SUBIR PDF CON IA ==========
        let pdfFile = null;
        let pdfNombre = null;

        // Configurar pdf.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        function abrirModalSubirPDF() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                mostrarToast('Primero configura la API Key de Gemini', 'error');
                abrirModal('modalConfig');
                return;
            }
            
            pdfFile = null;
            pdfNombre = null;
            document.getElementById('inputPDF').value = '';
            document.getElementById('pdfSiglas').value = '';
            document.getElementById('uploadZoneContent').innerHTML = '<span style="font-size:2rem">üìÑ</span><span>Clic o arrastra el PDF aqu√≠</span>';
            document.getElementById('uploadZone').classList.remove('has-file');
            document.getElementById('btnProcesarPDF').disabled = true;
            document.getElementById('pdfProcesando').style.display = 'none';
            abrirModal('modalSubirPDF');
            
            // Drag and drop
            const zone = document.getElementById('uploadZone');
            zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
            zone.ondragleave = () => zone.classList.remove('dragover');
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files[0]) {
                    document.getElementById('inputPDF').files = e.dataTransfer.files;
                    pdfSeleccionado(document.getElementById('inputPDF'));
                }
            };
        }

        function abrirModalImportJSON() {
            document.getElementById('inputImportJSON').value = '';
            abrirModal('modalImportJSON');
        }

        function pdfSeleccionado(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                mostrarToast('Solo archivos PDF', 'error');
                return;
            }

            pdfFile = file;
            pdfNombre = file.name;
            
            document.getElementById('uploadZoneContent').innerHTML = `<span style="font-size:2rem">‚úÖ</span><span>${pdfNombre}</span>`;
            document.getElementById('uploadZone').classList.add('has-file');
            document.getElementById('btnProcesarPDF').disabled = false;
        }

        async function extraerTextoPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let textoCompleto = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                textoCompleto += `\n--- P√°gina ${i} ---\n${pageText}`;
            }
            
            return textoCompleto;
        }

        async function procesarPDFConIA() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                mostrarToast('Configura la API Key primero', 'error');
                return;
            }

            const siglas = document.getElementById('pdfSiglas').value.trim().toUpperCase();
            if (!siglas) {
                mostrarToast('Introduce las siglas del alumno', 'error');
                return;
            }

            if (!pdfFile) {
                mostrarToast('Selecciona un PDF', 'error');
                return;
            }

            const curso = document.getElementById('pdfCurso').value;
            const sesiones = document.getElementById('pdfSesiones').value;
            const areaCognitivo = document.getElementById('areaCognitivo').checked;
            const areaLinguistico = document.getElementById('areaLinguistico').checked;
            const curriculoLectura = document.getElementById('curriculoLectura').checked;
            const curriculoNumeros = document.getElementById('curriculoNumeros').checked;

            if (!areaCognitivo && !areaLinguistico) {
                mostrarToast('Selecciona al menos un √°rea', 'error');
                return;
            }

            // Mostrar loading
            document.getElementById('pdfProcesando').style.display = 'block';
            document.getElementById('btnProcesarPDF').disabled = true;
            document.getElementById('pdfProcesoTexto').textContent = 'Extrayendo texto del PDF...';

            try {
                // Extraer texto del PDF
                const textoPDF = await extraerTextoPDF(pdfFile);
                console.log('Texto extra√≠do:', textoPDF.length, 'caracteres');

                document.getElementById('pdfProcesoTexto').textContent = 'Enviando a Gemini...';

                const prompt = construirPrompt(siglas, curso, sesiones, areaCognitivo, areaLinguistico, curriculoLectura, curriculoNumeros, textoPDF);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 8192
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Error de API');
                }

                const data = await response.json();
                const textoRespuesta = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                document.getElementById('pdfProcesoTexto').textContent = 'Procesando respuesta...';

                // Extraer JSON de la respuesta
                const jsonMatch = textoRespuesta.match(/```json\s*([\s\S]*?)\s*```/) || textoRespuesta.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    console.log('Respuesta:', textoRespuesta);
                    throw new Error('No se pudo extraer el JSON de la respuesta');
                }

                const jsonStr = jsonMatch[1] || jsonMatch[0];
                const alumnoData = JSON.parse(jsonStr);

                // Crear alumno en Firebase
                const nuevo = {
                    siglas: alumnoData.siglas || siglas,
                    curso: alumnoData.curso || curso,
                    sesionesSemana: parseInt(alumnoData.sesionesSemana || sesiones),
                    fechaCreacion: new Date().toISOString(),
                    programas: alumnoData.programas || []
                };

                window.dbPush(window.dbRef(window.database, 'alumnos'), nuevo).then(() => {
                    cerrarModal('modalSubirPDF');
                    mostrarToast(`${nuevo.siglas} importado con IA ‚úì`, 'success');
                });

            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error: ' + error.message, 'error');
                document.getElementById('pdfProcesando').style.display = 'none';
                document.getElementById('btnProcesarPDF').disabled = false;
            }
        }

        function construirPrompt(siglas, curso, sesiones, areaCognitivo, areaLinguistico, curriculoLectura, curriculoNumeros, textoPDF) {
            let areasTexto = '';
            if (areaCognitivo && areaLinguistico) {
                areasTexto = 'Extrae AMBOS tipos de programas: Desarrollo Cognitivo/Matem√°tico Y Comunicaci√≥n/Lenguaje.';
            } else if (areaCognitivo) {
                areasTexto = 'Extrae SOLO el programa de Desarrollo Cognitivo/Matem√°tico.';
            } else {
                areasTexto = 'Extrae SOLO el programa de Comunicaci√≥n y Lenguaje.';
            }

            let curriculoTexto = '';
            if (curriculoLectura) {
                curriculoTexto += `
IMPORTANTE: A√±ade objetivos de lectura del curr√≠culo de 1¬∫ Primaria Andaluc√≠a si no est√°n en el documento:
- T1: Vocales (A,E,I,O,U) + Consonantes M,P,L,S + s√≠labas directas
- T2: Consonantes T,D,N,F,B,V + C,Q,R,RR,H,CH + frases cortas
- T3: Consonantes G,J,√ë,LL,Y,Z + s√≠labas inversas + trabadas (pl,br,tr...)`;
            }
            if (curriculoNumeros) {
                curriculoTexto += `
IMPORTANTE: A√±ade objetivos de numeraci√≥n del curr√≠culo de 1¬∫ Primaria Andaluc√≠a si no est√°n en el documento:
- T1: N√∫meros 0-10 (reconocimiento, trazo, asociaci√≥n cantidad-graf√≠a)
- T2: N√∫meros 11-20, concepto de decena, clasificaciones
- T3: N√∫meros hasta 50, sumas y restas sin llevada`;
            }

            return `Eres un experto en educaci√≥n especial. Analiza este Programa Espec√≠fico (PE) de un alumno NEAE de Andaluc√≠a.

${areasTexto}
${curriculoTexto}

DOCUMENTO DEL PROGRAMA ESPEC√çFICO:
"""
${textoPDF}
"""

Devuelve SOLO un JSON v√°lido con esta estructura exacta (sin explicaciones, solo el JSON):

\`\`\`json
{
  "siglas": "${siglas}",
  "curso": "${curso}",
  "sesionesSemana": ${sesiones},
  "programas": [
    {
      "tipo": "Desarrollo Cognitivo Matem√°tico",
      "area": "cognitivo",
      "color": "#8b5cf6",
      "objetivos": [
        {
          "descripcion": "Descripci√≥n del objetivo extra√≠do del documento",
          "trimestre": 1,
          "contenidos": ["Contenido 1", "Contenido 2"],
          "indicadores": [
            {
              "descripcion": "Indicador de evaluaci√≥n del documento",
              "actividades": ["Actividad 1", "Actividad 2", "Actividad 3"]
            }
          ]
        }
      ]
    },
    {
      "tipo": "Comunicaci√≥n y Lenguaje",
      "area": "linguistico",
      "color": "#06b6d4",
      "objetivos": [...]
    }
  ]
}
\`\`\`

REGLAS:
1. Extrae TODOS los objetivos e indicadores del documento
2. Asigna trimestre seg√∫n el contenido (T1: b√°sico, T2: intermedio, T3: avanzado)
3. Si hay actividades en el documento, incl√∫yelas. Si no, genera 2-3 actividades apropiadas
4. Usa "area": "cognitivo" o "area": "linguistico" seg√∫n corresponda
5. Los indicadores son criterios de evaluaci√≥n medibles
6. Responde SOLO con el JSON, sin texto adicional`;
        }

        // Cargar API Key al inicio
        document.addEventListener('DOMContentLoaded', cargarApiKey);
    </script>
</body>
</html>
