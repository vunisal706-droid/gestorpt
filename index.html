<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a5f4a">
    <title>Gestor PE v3</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='110' fill='%231a5f4a'/%3E%3Crect x='100' y='70' width='220' height='300' rx='20' fill='white'/%3E%3Ccircle cx='160' cy='140' r='16' fill='%2322c55e'/%3E%3Ccircle cx='370' cy='350' r='100' fill='%23f59e0b'/%3E%3Ccircle cx='370' cy='350' r='80' fill='white'/%3E%3Cpath d='M370 290v60h50' stroke='%231a5f4a' stroke-width='12' stroke-linecap='round' fill='none'/%3E%3C/svg%3E">
    <style>
        :root{--primary:#1a5f4a;--primary-light:#2d8a6e;--primary-dark:#134536;--bg:#f5f7f6;--bg-card:#fff;--text:#1a2a24;--text-light:#5a6b64;--border:#d4ddd9;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--proceso:#3b82f6;--shadow:0 4px 20px rgba(26,95,74,0.1);--radius:16px;--radius-sm:10px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:12px 16px;position:sticky;top:0;z-index:100}
        .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .header h1{font-size:1.1rem}
        .status{display:flex;align-items:center;gap:5px;font-size:.7rem;background:rgba(255,255,255,.2);padding:4px 10px;border-radius:20px}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--warning)}
        .status-dot.ok{background:var(--success)}
        .container{max-width:1200px;margin:0 auto;padding:14px}
        .screen{display:none}.screen.active{display:block}
        .card{background:var(--bg-card);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
        .card-title{font-size:1rem;font-weight:700;color:var(--primary)}
        .btn{padding:10px 14px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-secondary{background:var(--bg);color:var(--text);border:2px solid var(--border)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-ai{background:#10a37f;color:#fff}
        .btn-sm{padding:7px 10px;font-size:.75rem}
        .btn-group{display:flex;gap:6px;flex-wrap:wrap}
        .alumnos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:12px}
        .alumno-card{background:var(--bg-card);border-radius:var(--radius);padding:16px 10px;text-align:center;cursor:pointer;border:2px solid transparent;box-shadow:var(--shadow)}
        .alumno-card:hover{border-color:var(--primary-light)}
        .alumno-siglas{font-family:monospace;font-size:1.3rem;font-weight:700;color:var(--primary)}
        .alumno-curso{font-size:.75rem;color:var(--text-light)}
        .alumno-progs{font-size:.65rem;color:var(--primary);margin-top:4px}
        .alumno-card-add{background:transparent;border:2px dashed var(--primary-light);color:var(--primary);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:85px}
        .tabs{display:flex;gap:4px;background:var(--bg-card);padding:4px;border-radius:var(--radius);margin-bottom:14px;overflow-x:auto}
        .tab{flex:1;padding:9px 8px;border:none;background:transparent;color:var(--text-light);font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer;border-radius:var(--radius-sm);white-space:nowrap}
        .tab.active{background:var(--primary);color:#fff}
        .tab-content{display:none}.tab-content.active{display:block}
        .form-group{margin-bottom:12px}
        .form-label{display:block;font-weight:600;margin-bottom:4px;font-size:.8rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:16px}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:14px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:var(--radius);width:100%;max-width:500px;max-height:85vh;overflow-y:auto}
        .modal-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:.95rem;font-weight:700}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light)}
        .modal-body{padding:16px}
        .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:6px}
        .dias-btns{display:flex;gap:6px;margin-top:5px}
        .dia-btn{width:42px;height:42px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;font-weight:600;cursor:pointer}
        .dia-btn.active{border-color:var(--primary);background:rgba(26,95,74,.15);color:var(--primary)}
        .programa-card{background:var(--bg);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px;border-left:4px solid var(--primary)}
        .programa-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .programa-titulo{font-weight:600;font-size:.9rem}
        .objetivo-card{background:#fff;border-radius:8px;padding:10px;margin-bottom:8px}
        .objetivo-header{display:flex;gap:5px;margin-bottom:5px;align-items:center}
        .objetivo-num{font-family:monospace;font-size:.7rem;font-weight:600;padding:2px 5px;border-radius:4px;background:rgba(26,95,74,.15);color:var(--primary)}
        .trimestre-badge{font-size:.65rem;padding:2px 5px;border-radius:4px;font-weight:600}
        .t1{background:#8b5cf620;color:#8b5cf6}.t2{background:#06b6d420;color:#06b6d4}.t3{background:#f59e0b20;color:#f59e0b}
        .objetivo-desc{font-size:.8rem}
        .indicadores-list{font-size:.75rem;margin-top:6px;padding-top:6px;border-top:1px solid var(--border);list-style:none}
        .indicadores-list li{padding:2px 0}
        .cuadrante-nav{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
        .nav-btn{width:34px;height:34px;border:2px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
        .cuadrante-table{width:100%;border-collapse:collapse;font-size:.75rem}
        .cuadrante-table th,.cuadrante-table td{border:1px solid var(--border);padding:5px;text-align:left;vertical-align:top}
        .cuadrante-table th{background:var(--primary);color:#fff;text-align:center}
        .cuadrante-table td:first-child{background:var(--primary-light);color:#fff;text-align:center;width:40px}
        .celda{min-height:50px;cursor:pointer;position:relative}
        .celda:hover{background:var(--bg)}
        .celda-vacia{background:#f9fafb;color:var(--text-light)}
        .celda-obj{font-weight:600;color:var(--primary);font-size:.7rem}
        .celda-ind{font-size:.6rem;color:var(--text)}
        .celda-ausencia{background:#fee2e2!important}
        .celda-sincole{background:#e0e7ff!important}
        .celda-icon{position:absolute;top:2px;right:2px;font-size:.6rem}
        .upload-zone{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:20px;text-align:center;cursor:pointer;background:var(--bg)}
        .upload-zone.has-file{border-color:var(--success);background:rgba(34,197,94,.1)}
        .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:#fff;padding:10px 18px;border-radius:var(--radius-sm);font-weight:500;opacity:0;transition:all .3s;z-index:2000}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.success{background:var(--success)}
        .toast.error{background:var(--danger)}
        .empty-state{text-align:center;padding:25px;color:var(--text-light)}
        .leyenda{display:flex;gap:12px;flex-wrap:wrap;font-size:.7rem;margin-top:8px}
        .leyenda-item{display:flex;align-items:center;gap:4px}
        .leyenda-color{width:12px;height:12px;border-radius:3px}
        .alumno-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
        .alumno-header-siglas{font-family:monospace;font-size:1.5rem;font-weight:700;color:var(--primary);background:rgba(26,95,74,.1);padding:10px 16px;border-radius:var(--radius)}
        .stats-box{display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:12px}
        .stat-item{text-align:center;padding:8px 12px;background:#fff;border-radius:8px;min-width:70px;flex:1}
        .stat-num{font-size:1.3rem;font-weight:700}
        .stat-label{font-size:.65rem;color:var(--text-light)}
        .eval-item{display:flex;align-items:center;gap:6px;padding:8px;background:var(--bg);border-radius:6px;margin-bottom:5px;flex-wrap:wrap}
        .eval-text{flex:1;font-size:.8rem;min-width:140px}
        .eval-btn{width:32px;height:32px;border-radius:50%;border:2px solid var(--border);background:#fff;cursor:pointer;font-size:.85rem}
        .eval-btn.c{border-color:var(--success);color:var(--success)}
        .eval-btn.c.active{background:var(--success);color:#fff}
        .eval-btn.p{border-color:var(--proceso);color:var(--proceso)}
        .eval-btn.p.active{background:var(--proceso);color:#fff}
        .eval-btn.n{border-color:#888;color:#888}
        .eval-btn.n.active{background:#888;color:#fff}
        .asist-btns{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
        .asist-btn{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;cursor:pointer;text-align:center;min-width:80px}
        .asist-btn.selected{border-width:3px}
        .asist-btn.asiste.selected{border-color:var(--success);background:rgba(34,197,94,.1)}
        .asist-btn.ausencia.selected{border-color:var(--danger);background:rgba(239,68,68,.1)}
        .asist-btn.sincole.selected{border-color:#6366f1;background:rgba(99,102,241,.1)}
        .resultado-btns{display:flex;gap:8px;margin-top:10px}
        .resultado-btn{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius-sm);background:#fff;cursor:pointer;text-align:center;font-size:.8rem}
        .resultado-btn.selected{border-width:3px}
        .resultado-btn.conseguido.selected{border-color:var(--success);background:rgba(34,197,94,.1)}
        .resultado-btn.repetir.selected{border-color:var(--warning);background:rgba(245,158,11,.1)}
        .chart-container{background:#fff;border-radius:var(--radius-sm);padding:12px;margin-bottom:12px}
        .chart-container canvas{max-height:200px}
        .informe-preview{background:#fff;border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-top:12px;font-size:.85rem;max-height:400px;overflow-y:auto}
        .pasado-badge{font-size:.6rem;background:#fef3c7;color:#92400e;padding:1px 4px;border-radius:3px;margin-left:4px}
        .print-option{padding:12px;border:2px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer;transition:all .2s}
        .print-option:hover{border-color:var(--primary);background:rgba(26,95,74,.05)}
        .print-option h4{margin-bottom:4px;color:var(--primary)}
        .print-option p{font-size:.8rem;color:var(--text-light)}
        @media print{.no-print{display:none!important}body{background:#fff}.card{box-shadow:none;border:1px solid #ddd}}
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="header-content">
            <h1>üìã Gestor PE v3</h1>
            <div class="status"><div class="status-dot" id="statusDot"></div><span id="statusText">Conectando...</span></div>
        </div>
    </header>
    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Alumnos</h2>
                    <div class="btn-group">
                        <button class="btn btn-secondary btn-sm" onclick="abrirModalImprimir()">üñ®Ô∏è Imprimir</button>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalNuevo()">‚ûï Nuevo</button>
                    </div>
                </div>
                <div class="alumnos-grid" id="alumnosGrid"></div>
            </div>
        </div>
    </div>
    <div id="screenAlumno" class="screen">
        <div class="container">
            <div class="alumno-header" id="alumnoHeader"></div>
            <div class="tabs no-print">
                <button class="tab active" onclick="cambiarTab('programas')">üìÑ Programas</button>
                <button class="tab" onclick="cambiarTab('programacion')">üìÖ Programaci√≥n</button>
                <button class="tab" onclick="cambiarTab('evaluacion')">üìä Evaluaci√≥n</button>
                <button class="tab" onclick="cambiarTab('asistencia')">üìà Resumen</button>
            </div>
            <div id="tabProgramas" class="tab-content active"></div>
            <div id="tabProgramacion" class="tab-content"></div>
            <div id="tabEvaluacion" class="tab-content"></div>
            <div id="tabAsistencia" class="tab-content"></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalNuevo">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">‚ûï Nuevo Alumno</h3><button class="modal-close" onclick="cerrarModal('modalNuevo')">√ó</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Siglas *</label><input type="text" class="form-input" id="nuevoSiglas" placeholder="M.G.L." maxlength="10"></div>
                    <div class="form-group"><label class="form-label">Curso *</label><select class="form-select" id="nuevoCurso"><option>Infantil 3 a√±os</option><option>Infantil 4 a√±os</option><option selected>Infantil 5 a√±os</option><option>1¬∫ Primaria</option><option>2¬∫ Primaria</option><option>3¬∫ Primaria</option><option>4¬∫ Primaria</option><option>5¬∫ Primaria</option><option>6¬∫ Primaria</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">D√≠as de sesi√≥n</label><div class="dias-btns" id="diasBtns"><button type="button" class="dia-btn" data-dia="0" onclick="toggleDia(0)">L</button><button type="button" class="dia-btn active" data-dia="1" onclick="toggleDia(1)">M</button><button type="button" class="dia-btn" data-dia="2" onclick="toggleDia(2)">X</button><button type="button" class="dia-btn active" data-dia="3" onclick="toggleDia(3)">J</button><button type="button" class="dia-btn active" data-dia="4" onclick="toggleDia(4)">V</button></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalNuevo')">Cancelar</button><button class="btn btn-primary" onclick="crearAlumno()">‚úì Crear</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalAddProg">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">üìÑ A√±adir Programa</h3><button class="modal-close" onclick="cerrarModal('modalAddProg')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Tipo de programa</label><select class="form-select" id="addProgTipo" onchange="cambioTipoProg()"><option value="">Seleccionar...</option><option value="cognitivo">üß† Estimulaci√≥n cognitiva</option><option value="atencion">üëÅÔ∏è Atenci√≥n</option><option value="memoria">üíæ Memoria</option><option value="comunicacion">üí¨ Comunicaci√≥n</option><option value="lectoescritura">üìñ Lectoescritura (predefinido)</option><option value="matematico">üî¢ Razonamiento matem√°tico</option><option value="social">ü§ù Habilidades sociales</option><option value="emocional">‚ù§Ô∏è Gesti√≥n emocional</option><option value="ejecutivas">üéØ Funciones ejecutivas</option><option value="autonomia">üèÉ Autonom√≠a</option></select></div>
                <div id="zonaDocx"><div class="form-group"><label class="form-label">Importar DOCX</label><div class="upload-zone" id="uploadZone" onclick="document.getElementById('inputFile').click()">üìÑ Toca para seleccionar</div><input type="file" id="inputFile" accept=".docx" style="display:none" onchange="cargarDocx(this)"></div><div class="form-group"><label class="form-label">O pegar texto</label><textarea class="form-input" id="addProgTexto" rows="3" placeholder="OBJETIVO 1: ..."></textarea></div><button class="btn btn-secondary btn-sm" onclick="analizarTexto()">üîç Analizar</button></div>
                <div id="zonaLecto" style="display:none"><div style="background:var(--bg);padding:12px;border-radius:8px"><strong>üìñ Programa predefinido</strong><p style="font-size:.8rem;color:var(--text-light)">Vocales y consonantes</p></div></div>
                <div id="previewProg" style="display:none;margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:.8rem"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalAddProg')">Cancelar</button><button class="btn btn-primary" id="btnAddProg" onclick="addPrograma()" disabled>üì• A√±adir</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalCelda">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="celdaTitulo">Sesi√≥n</h3><button class="modal-close" onclick="cerrarModal('modalCelda')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Estado</label><div class="asist-btns"><button type="button" class="asist-btn asiste" onclick="setEstado('asiste',this)">‚úÖ Asiste</button><button type="button" class="asist-btn ausencia" onclick="setEstado('ausencia',this)">‚ùå Ausencia</button><button type="button" class="asist-btn sincole" onclick="setEstado('sincole',this)">üè´ Sin cole</button></div></div>
                <div id="contenidoSesion">
                    <div class="form-group"><label class="form-label">Programa</label><select class="form-select" id="selPrograma" onchange="cargarObjetivos()"></select></div>
                    <div class="form-group"><label class="form-label">Objetivo</label><select class="form-select" id="selObjetivo" onchange="cargarIndicadores()"></select></div>
                    <div class="form-group"><label class="form-label">Indicador</label><select class="form-select" id="selIndicador"></select></div>
                    <div class="form-group"><label class="form-label">Resultado</label><div class="resultado-btns"><button type="button" class="resultado-btn conseguido" onclick="setResultado('conseguido',this)">‚úÖ Conseguido</button><button type="button" class="resultado-btn repetir" onclick="setResultado('repetir',this)">üîÑ Repetir</button></div></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-danger btn-sm" onclick="borrarCelda()">üóëÔ∏è</button><button class="btn btn-secondary" onclick="cerrarModal('modalCelda')">Cancelar</button><button class="btn btn-primary" onclick="guardarCelda()">üíæ Guardar</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalInforme">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3 class="modal-title">üìÑ Generar Informe</h3><button class="modal-close" onclick="cerrarModal('modalInforme')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Trimestre</label><select class="form-select" id="informeTrim"><option value="1">1¬∫ Trimestre</option><option value="2">2¬∫ Trimestre</option><option value="3">3¬∫ Trimestre</option></select></div>
                <div class="btn-group" style="flex-direction:column;gap:8px"><button class="btn btn-primary" onclick="generarInforme()">üìÑ Generar Informe</button><button class="btn btn-ai" onclick="abrirChatGPTInforme()">ü§ñ ChatGPT - Valoraci√≥n</button></div>
                <div id="informePreview" class="informe-preview" style="display:none"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalInforme')">Cerrar</button><button class="btn btn-primary" id="btnImprimirInforme" onclick="imprimirInforme()" style="display:none">üñ®Ô∏è Imprimir/PDF</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalImportJSON">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3 class="modal-title">üì• Importar Programaci√≥n (JSON)</h3><button class="modal-close" onclick="cerrarModal('modalImportJSON')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Pega aqu√≠ el JSON de ChatGPT:</label><textarea class="form-textarea" id="jsonInput" rows="10" placeholder='{"0_1_1": {"pId": "...", "oIdx": 0, "iIdx": 0}, ...}'></textarea></div>
                <p style="font-size:.75rem;color:var(--text-light)">El JSON debe tener el formato exacto generado por ChatGPT</p>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalImportJSON')">Cancelar</button><button class="btn btn-primary" onclick="importarJSON()">üì• Importar</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalImprimir">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3 class="modal-title">üñ®Ô∏è Imprimir Programaciones</h3><button class="modal-close" onclick="cerrarModal('modalImprimir')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Selecciona el mes</label>
                    <select class="form-select" id="printMes">
                        <option value="-1">üìÖ Todo el curso (todos los meses)</option>
                        <option value="0">Septiembre</option>
                        <option value="1">Octubre</option>
                        <option value="2">Noviembre</option>
                        <option value="3">Diciembre</option>
                        <option value="4">Enero</option>
                        <option value="5">Febrero</option>
                        <option value="6">Marzo</option>
                        <option value="7">Abril</option>
                        <option value="8">Mayo</option>
                        <option value="9">Junio</option>
                    </select>
                </div>
                <div class="print-option" onclick="imprimirTodos()">
                    <h4>üñ®Ô∏è Imprimir</h4>
                    <p>Genera un documento con las programaciones de todos los alumnos</p>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('modalImprimir')">Cerrar</button></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        firebase.initializeApp({databaseURL:"https://gestorpt-7946b-default-rtdb.europe-west1.firebasedatabase.app"});
        const db=firebase.database();
        let alumnos={},alumnoActual=null,mesActual=0,diasSel=[1,3,4],celdaEditando=null,docExtraido=null,estadoCelda='asiste',resultadoCelda=null,evalTrim=1,charts={},informeData=null;
        const AREAS={cognitivo:{nombre:'Estimulaci√≥n cognitiva',icon:'üß†',color:'#8b5cf6'},atencion:{nombre:'Atenci√≥n',icon:'üëÅÔ∏è',color:'#f59e0b'},memoria:{nombre:'Memoria',icon:'üíæ',color:'#06b6d4'},comunicacion:{nombre:'Comunicaci√≥n',icon:'üí¨',color:'#10b981'},lectoescritura:{nombre:'Lectoescritura',icon:'üìñ',color:'#3b82f6'},matematico:{nombre:'Razonamiento matem√°tico',icon:'üî¢',color:'#ef4444'},social:{nombre:'Habilidades sociales',icon:'ü§ù',color:'#ec4899'},emocional:{nombre:'Gesti√≥n emocional',icon:'‚ù§Ô∏è',color:'#f97316'},ejecutivas:{nombre:'Funciones ejecutivas',icon:'üéØ',color:'#6366f1'},autonomia:{nombre:'Autonom√≠a',icon:'üèÉ',color:'#14b8a6'}};
        const MESES=[
            {nombre:'Septiembre',semanas:3,trim:1,inicio:'10 sept',fin:'30 sept'},
            {nombre:'Octubre',semanas:4,trim:1,inicio:'1 oct',fin:'31 oct'},
            {nombre:'Noviembre',semanas:4,trim:1,inicio:'3 nov',fin:'28 nov'},
            {nombre:'Diciembre',semanas:2,trim:1,inicio:'1 dic',fin:'19 dic'},
            {nombre:'Enero',semanas:3,trim:2,inicio:'8 ene',fin:'31 ene'},
            {nombre:'Febrero',semanas:4,trim:2,inicio:'2 feb',fin:'27 feb'},
            {nombre:'Marzo',semanas:3,trim:2,inicio:'2 mar',fin:'27 mar'},
            {nombre:'Abril',semanas:3,trim:3,inicio:'7 abr',fin:'30 abr'},
            {nombre:'Mayo',semanas:4,trim:3,inicio:'4 may',fin:'29 may'},
            {nombre:'Junio',semanas:3,trim:3,inicio:'2 jun',fin:'22 jun'}
        ];
        const DIAS=['Lunes','Martes','Mi√©rcoles','Jueves','Viernes'],DIAS_C=['L','M','X','J','V'];
        const LECTO=['A','E','I','O','U','M','P','S','L','T','N','D','F','B','V','J','R','C','Q','G','H','CH','√ë','Y','LL','Z','X','K','W'].map((l,i)=>({numero:i+1,descripcion:'Letra '+l,trimestre:i<10?1:(i<20?2:3),indicadores:['Reconoce '+l,'Traza '+l,'Lee s√≠labas con '+l]}));
        
        db.ref('gestorpe/alumnos').on('value',snap=>{alumnos=snap.val()||{};renderInicio();if(alumnoActual&&alumnos[alumnoActual]){renderProgs();renderProg();renderEval();renderAsis();}document.getElementById('statusDot').classList.add('ok');document.getElementById('statusText').textContent='Conectado';});
        
        function renderInicio(){const g=document.getElementById('alumnosGrid'),ids=Object.keys(alumnos);if(!ids.length){g.innerHTML='<div class="alumno-card alumno-card-add" onclick="abrirModalNuevo()"><span style="font-size:1.3rem">‚ûï</span><span style="font-size:.8rem">A√±adir</span></div>';return;}let h=ids.map(id=>{const a=alumnos[id],n=a.programas?Object.keys(a.programas).length:0;return'<div class="alumno-card" onclick="abrirAlumno(\''+id+'\')"><div class="alumno-siglas">'+a.siglas+'</div><div class="alumno-curso">'+a.curso+'</div><div class="alumno-progs">'+n+' prog.</div></div>';}).join('');h+='<div class="alumno-card alumno-card-add" onclick="abrirModalNuevo()"><span style="font-size:1.3rem">‚ûï</span></div>';g.innerHTML=h;}
        
        function abrirModalNuevo(){document.getElementById('nuevoSiglas').value='';diasSel=[1,3,4];actualizarDiasBtns();abrirModal('modalNuevo');}
        function toggleDia(d){const idx=diasSel.indexOf(d);if(idx>-1){if(diasSel.length>1)diasSel.splice(idx,1);}else{diasSel.push(d);diasSel.sort((a,b)=>a-b);}actualizarDiasBtns();}
        function actualizarDiasBtns(){document.querySelectorAll('#diasBtns .dia-btn').forEach(btn=>{btn.classList.toggle('active',diasSel.includes(parseInt(btn.dataset.dia)));});}
        function crearAlumno(){const siglas=document.getElementById('nuevoSiglas').value.trim().toUpperCase();if(!siglas){toast('Introduce siglas','error');return;}db.ref('gestorpe/alumnos').push().set({siglas:siglas,curso:document.getElementById('nuevoCurso').value,diasSesion:diasSel.slice(),programas:{},programacion:{},evaluaciones:{},ausencias:{},sincole:{},resultados:{},pasados:{}}).then(()=>{cerrarModal('modalNuevo');toast(siglas+' creado ‚úì','success');});}
        
        function abrirAlumno(id){alumnoActual=id;mesActual=0;evalTrim=1;document.getElementById('screenInicio').classList.remove('active');document.getElementById('screenAlumno').classList.add('active');const a=alumnos[id],diasStr=(a.diasSesion||[0,2,4]).map(d=>DIAS_C[d]).join('-');document.getElementById('alumnoHeader').innerHTML='<div class="alumno-header-siglas">'+a.siglas+'</div><div><h2 style="font-size:.95rem">'+a.curso+'</h2><p style="color:var(--text-light);font-size:.75rem">'+diasStr+'</p></div><div style="margin-left:auto" class="btn-group no-print"><button class="btn btn-secondary btn-sm" onclick="volverInicio()">‚Üê Volver</button><button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è</button><button class="btn btn-danger btn-sm" onclick="eliminarAlumno(\''+id+'\')">üóëÔ∏è</button></div>';document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===0));document.querySelectorAll('.tab-content').forEach((c,i)=>c.classList.toggle('active',i===0));renderProgs();renderProg();renderEval();renderAsis();}
        function volverInicio(){alumnoActual=null;document.getElementById('screenAlumno').classList.remove('active');document.getElementById('screenInicio').classList.add('active');}
        function cambiarTab(t){document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');if(t==='asistencia')setTimeout(renderAsisCharts,100);if(t==='evaluacion')setTimeout(renderEvalCharts,100);}
        function eliminarAlumno(id){if(confirm('¬øEliminar alumno?')){db.ref('gestorpe/alumnos/'+id).remove();volverInicio();toast('Eliminado','success');}}
        
        function renderProgs(){const a=alumnos[alumnoActual];let h='<div class="card"><div class="card-header"><h3 class="card-title">üìÑ Programas</h3><button class="btn btn-primary btn-sm no-print" onclick="abrirModalAddProg()">‚ûï</button></div>';if(!a.programas||!Object.keys(a.programas).length){h+='<div class="empty-state">Sin programas</div>';}else{Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{icon:'üìÑ',nombre:p.tipo,color:'#666'};h+='<div class="programa-card" style="border-left-color:'+info.color+'"><div class="programa-header"><span class="programa-titulo">'+info.icon+' '+info.nombre+'</span><button class="btn btn-danger btn-sm no-print" onclick="elimProg(\''+pId+'\')">üóëÔ∏è</button></div>';(p.objetivos||[]).forEach(obj=>{h+='<div class="objetivo-card"><div class="objetivo-header"><span class="objetivo-num">O'+obj.numero+'</span><span class="trimestre-badge t'+obj.trimestre+'">T'+obj.trimestre+'</span></div><div class="objetivo-desc">'+obj.descripcion+'</div>';if(obj.indicadores&&obj.indicadores.length){h+='<ul class="indicadores-list">'+obj.indicadores.map(x=>'<li>‚Ä¢ '+x+'</li>').join('')+'</ul>';}h+='</div>';});h+='</div>';});}h+='<div class="btn-group no-print" style="margin-top:12px"><button class="btn btn-secondary btn-sm" onclick="regenerarProg()">üîÑ Regenerar</button><button class="btn btn-ai btn-sm" onclick="generarPromptIA()">ü§ñ IA</button><button class="btn btn-warning btn-sm" onclick="abrirModal(\'modalImportJSON\')">üì• Importar JSON</button></div></div>';document.getElementById('tabProgramas').innerHTML=h;}
        
        function abrirModalAddProg(){document.getElementById('addProgTipo').value='';document.getElementById('addProgTexto').value='';document.getElementById('uploadZone').innerHTML='üìÑ Toca para seleccionar';document.getElementById('uploadZone').classList.remove('has-file');document.getElementById('previewProg').style.display='none';document.getElementById('zonaDocx').style.display='block';document.getElementById('zonaLecto').style.display='none';document.getElementById('btnAddProg').disabled=true;document.getElementById('inputFile').value='';docExtraido=null;abrirModal('modalAddProg');}
        function cambioTipoProg(){const t=document.getElementById('addProgTipo').value;document.getElementById('zonaDocx').style.display=t==='lectoescritura'?'none':'block';document.getElementById('zonaLecto').style.display=t==='lectoescritura'?'block':'none';document.getElementById('btnAddProg').disabled=t!=='lectoescritura'&&!docExtraido;}
        async function cargarDocx(inp){const f=inp.files[0];if(!f)return;document.getElementById('uploadZone').innerHTML='üìÑ '+f.name;document.getElementById('uploadZone').classList.add('has-file');try{const r=await mammoth.extractRawText({arrayBuffer:await f.arrayBuffer()});procesarTexto(r.value);}catch(e){toast('Error','error');}}
        function analizarTexto(){const t=document.getElementById('addProgTexto').value;if(t.length<20){toast('Pega m√°s contenido','error');return;}procesarTexto(t);}
        function procesarTexto(txt){const objs=extraerObjetivos(txt);if(!objs.length){toast('No se encontraron objetivos','error');return;}docExtraido=objs;document.getElementById('previewProg').innerHTML='‚úì '+objs.length+' objetivos';document.getElementById('previewProg').style.display='block';document.getElementById('btnAddProg').disabled=false;}
        function extraerObjetivos(txt){const objs=[],lineas=txt.split('\n');let actual=null,seccion=null;for(let i=0;i<lineas.length;i++){const lt=lineas[i].trim();if(!lt)continue;const m=lt.match(/^OBJETIVO\s*(\d+)[.:]\s*(.+)?/i)||lt.match(/^(\d+)[.\-)\s]+(.{15,})/);if(m){if(actual)objs.push(actual);actual={numero:parseInt(m[1]),descripcion:(m[2]||'').trim(),indicadores:[],trimestre:1};seccion=null;continue;}if(lt.toUpperCase().indexOf('INDICADOR')>-1){seccion='indicadores';continue;}if(actual&&seccion==='indicadores'&&lt.length>5){const ind=lt.replace(/^[-‚Ä¢¬∑‚ñ™‚ñ∫‚óè‚óã‚ó¶‚Ä£‚ÅÉ*]\s*/,'').trim();if(ind.length>5)actual.indicadores.push(ind);}}if(actual)objs.push(actual);const n=objs.length,p=Math.ceil(n/3);objs.forEach((o,i)=>{o.trimestre=i<p?1:(i<p*2?2:3);if(!o.indicadores.length)o.indicadores=['Indicador de '+o.descripcion.substring(0,20)];});return objs;}
        function addPrograma(){const tipo=document.getElementById('addProgTipo').value;if(!tipo){toast('Selecciona tipo','error');return;}const objetivos=tipo==='lectoescritura'?LECTO:docExtraido;if(!objetivos||!objetivos.length){toast('Sin objetivos','error');return;}const a=alumnos[alumnoActual],pId='p_'+Date.now();db.ref('gestorpe/alumnos/'+alumnoActual+'/programas/'+pId).set({tipo:tipo,objetivos:objetivos}).then(()=>{a.programas=a.programas||{};a.programas[pId]={tipo:tipo,objetivos:objetivos};const nueva=generarProgramacion(a);return db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(nueva);}).then(()=>{cerrarModal('modalAddProg');renderProgs();renderProg();toast('Programa a√±adido ‚úì','success');}).catch(e=>{toast('Error: '+e.message,'error');});}
        function elimProg(pId){if(!confirm('¬øEliminar?'))return;db.ref('gestorpe/alumnos/'+alumnoActual+'/programas/'+pId).remove().then(()=>{delete alumnos[alumnoActual].programas[pId];return db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(generarProgramacion(alumnos[alumnoActual]));}).then(()=>{renderProgs();renderProg();toast('Eliminado','success');});}
        
        function getIndicadoresPasados(a,trim){const pasados=a.pasados||{},result=[];Object.keys(pasados).forEach(k=>{if(pasados[k]===trim){const parts=k.split('_');result.push({pId:parts[0],oIdx:parseInt(parts[1]),iIdx:parseInt(parts[2]),key:k});}});return result;}
        
        function getTodasLasSesiones(a){
            const dias=a.diasSesion||[1,3,4],keys=[];
            for(let mi=0;mi<MESES.length;mi++){
                const m=MESES[mi];
                for(let s=1;s<=m.semanas;s++){
                    for(let di=0;di<dias.length;di++){
                        keys.push(mi+'_'+s+'_'+dias[di]);
                    }
                }
            }
            return keys;
        }
        
        function generarProgramacion(a){
            const prog={};if(!a.programas)return prog;
            const pIds=Object.keys(a.programas);if(!pIds.length)return prog;
            const todasSesiones=getTodasLasSesiones(a);
            const sesionesPorTrim={1:0,2:0,3:0};
            todasSesiones.forEach(k=>{const mi=parseInt(k.split('_')[0]);sesionesPorTrim[MESES[mi].trim]++;});
            const poolT={1:[],2:[],3:[]};
            pIds.forEach(pId=>{const p=a.programas[pId];(p.objetivos||[]).forEach((o,oi)=>{const trim=o.trimestre||1;(o.indicadores||['Indicador']).forEach((_,ii)=>{poolT[trim].push({pId:pId,oIdx:oi,iIdx:ii});});});});
            [2,3].forEach(t=>{getIndicadoresPasados(a,t).forEach(p=>poolT[t].push({pId:p.pId,oIdx:p.oIdx,iIdx:p.iIdx}));});
            [1,2,3].forEach(t=>{if(poolT[t].length<2)return;const porProg={};poolT[t].forEach(item=>{if(!porProg[item.pId])porProg[item.pId]=[];porProg[item.pId].push(item);});const pIdsEnPool=Object.keys(porProg);if(pIdsEnPool.length<2)return;const nuevo=[];let maxLen=Math.max(...pIdsEnPool.map(id=>porProg[id].length));for(let i=0;i<maxLen;i++){pIdsEnPool.forEach(id=>{if(porProg[id][i])nuevo.push(porProg[id][i]);});}poolT[t]=nuevo;});
            [1,2,3].forEach(t=>{if(!poolT[t].length)return;const sesiones=sesionesPorTrim[t];while(poolT[t].length<sesiones){const original=[...poolT[t]];for(let i=0;i<original.length&&poolT[t].length<sesiones;i++){poolT[t].push({...original[i]});}}});
            let idxT={1:0,2:0,3:0};
            todasSesiones.forEach(k=>{const mi=parseInt(k.split('_')[0]);const trim=MESES[mi].trim;const pool=poolT[trim];if(!pool.length)return;prog[k]=pool[idxT[trim]%pool.length];idxT[trim]++;});
            return prog;
        }
        
        function regenerarProg(){const a=alumnos[alumnoActual];if(!a.programas||!Object.keys(a.programas).length){toast('A√±ade un programa','error');return;}const nueva=generarProgramacion(a);db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(nueva).then(()=>{a.programacion=nueva;renderProg();toast('Regenerado: '+Object.keys(nueva).length+' sesiones','success');});}
        
        function reajustarDesde(a,desdeClave){
            const todasSesiones=getTodasLasSesiones(a);const idx=todasSesiones.indexOf(desdeClave);if(idx<0)return a.programacion;
            const nueva={...a.programacion};
            for(let i=todasSesiones.length-1;i>idx;i--){const keyActual=todasSesiones[i];const keyAnterior=todasSesiones[i-1];if(nueva[keyAnterior]){nueva[keyActual]=nueva[keyAnterior];}}
            delete nueva[desdeClave];return nueva;
        }
        
        function insertarRepeticion(a,clave,contenido){
            const todasSesiones=getTodasLasSesiones(a);const idx=todasSesiones.indexOf(clave);if(idx<0)return a.programacion;
            const dias=a.diasSesion||[1,3,4];let idxRepetir=idx+dias.length;if(idxRepetir>=todasSesiones.length)idxRepetir=todasSesiones.length-1;const claveRepetir=todasSesiones[idxRepetir];
            const nueva={...a.programacion};
            for(let i=todasSesiones.length-1;i>idxRepetir;i--){const keyActual=todasSesiones[i];const keyAnterior=todasSesiones[i-1];if(nueva[keyAnterior]){nueva[keyActual]=nueva[keyAnterior];}}
            nueva[claveRepetir]=contenido;return nueva;
        }
        
        function generarPromptIA(){
            const a=alumnos[alumnoActual];if(!a.programas||!Object.keys(a.programas).length){toast('A√±ade programas primero','error');return;}
            const dias=a.diasSesion||[1,3,4];const todasSesiones=getTodasLasSesiones(a);
            let prompt=`Eres un experto en Pedagog√≠a Terap√©utica. Genera una programaci√≥n COMPLETA para TODO el curso escolar 2025/2026 de Granada (septiembre a junio).\n\nüìÖ CALENDARIO ESCOLAR GRANADA 25/26:\n- Septiembre: 10 sept - 30 sept (3 semanas lectivas)\n- Octubre: 1 oct - 31 oct (4 semanas)\n- Noviembre: 3 nov - 28 nov (4 semanas)\n- Diciembre: 1 dic - 19 dic (2 semanas) - Vacaciones Navidad 22 dic\n- Enero: 8 ene - 31 ene (3 semanas) - Vuelta 8 enero\n- Febrero: 2 feb - 27 feb (4 semanas) - 28F festivo Andaluc√≠a\n- Marzo: 2 mar - 27 mar (3 semanas) - Semana Santa aprox 28 mar\n- Abril: 7 abr - 30 abr (3 semanas) - Vuelta Semana Santa\n- Mayo: 4 may - 29 may (4 semanas)\n- Junio: 2 jun - 22 jun (3 semanas) - Fin de curso\n\nüë§ ALUMNO: ${a.siglas} (${a.curso})\nüìÜ D√çAS DE SESI√ìN: ${dias.map(d=>DIAS_C[d]).join(', ')}\nüìä TOTAL SESIONES: ${todasSesiones.length}\n\nüìö PROGRAMAS Y CONTENIDOS:\n`;
            Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};prompt+=`\nüî∑ PROGRAMA: ${info.nombre}\n   ID: "${pId}"\n`;(p.objetivos||[]).forEach((obj,oi)=>{prompt+=`   üìå Objetivo ${obj.numero} (oIdx:${oi}, T${obj.trimestre}): ${obj.descripcion}\n`;(obj.indicadores||[]).forEach((ind,ii)=>{prompt+=`      - Indicador (iIdx:${ii}): ${ind}\n`;});});});
            prompt+=`\nüìã SESIONES A PROGRAMAR (${todasSesiones.length} sesiones):\n`;MESES.forEach((m,mi)=>{const sesionesDelMes=todasSesiones.filter(k=>k.startsWith(mi+'_')).length;prompt+=`${m.nombre} (mes ${mi}, T${m.trim}): ${sesionesDelMes} sesiones\n`;});
            prompt+=`\n‚öôÔ∏è REGLAS IMPORTANTES:\n1. ALTERNAR entre programas en cada sesi√≥n (50%-50% si hay 2 programas)\n2. RESPETAR trimestres: T1 solo en sept-dic, T2 en ene-mar, T3 en abr-jun\n3. REPETIR indicadores si hay m√°s sesiones que indicadores (distribuir equilibradamente)\n4. PROGRESI√ìN l√≥gica: de m√°s simple a m√°s complejo\n5. No repetir el mismo indicador en 2 sesiones consecutivas\n6. Cubrir TODO el curso: las ${todasSesiones.length} sesiones\n\nüì§ FORMATO DE RESPUESTA:\nDevuelve SOLO un JSON v√°lido con TODAS las ${todasSesiones.length} sesiones:\n{\n  "0_1_${dias[0]}": {"pId": "p_xxx", "oIdx": 0, "iIdx": 0},\n  ...\n  "9_3_${dias[dias.length-1]}": {"pId": "...", "oIdx": ..., "iIdx": ...}\n}\n\n‚ö†Ô∏è USA LOS IDs DE PROGRAMA EXACTOS QUE TE HE DADO.\n‚ö†Ô∏è GENERA EL JSON COMPLETO PARA TODO EL CURSO (${todasSesiones.length} entradas).\n‚ö†Ô∏è NO incluyas texto adicional, SOLO el JSON.`;
            navigator.clipboard.writeText(prompt).then(()=>{toast('Prompt copiado - Pega en ChatGPT','success');window.open('https://chat.openai.com/','_blank');}).catch(()=>{const ta=document.createElement('textarea');ta.value=prompt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Prompt copiado - Pega en ChatGPT','success');window.open('https://chat.openai.com/','_blank');});
        }
        
        function importarJSON(){
            const txt=document.getElementById('jsonInput').value.trim();if(!txt){toast('Pega el JSON','error');return;}
            try{let cleanJSON=txt;if(cleanJSON.includes('```')){cleanJSON=cleanJSON.replace(/```json?\n?/g,'').replace(/```/g,'').trim();}const prog=JSON.parse(cleanJSON);const keys=Object.keys(prog);if(!keys.length)throw new Error('JSON vac√≠o');db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(prog).then(()=>{alumnos[alumnoActual].programacion=prog;cerrarModal('modalImportJSON');document.getElementById('jsonInput').value='';renderProg();toast('Importado: '+keys.length+' sesiones','success');});}catch(e){toast('Error JSON: '+e.message,'error');}
        }
        
        function renderProg(){const a=alumnos[alumnoActual],dias=a.diasSesion||[1,3,4],noms=dias.map(d=>DIAS_C[d]),mes=MESES[mesActual],st=calcStats(a);let h='<div class="card"><div class="stats-box no-print"><div class="stat-item"><div class="stat-num" style="color:var(--danger)">'+(st.porMes[mesActual]?st.porMes[mesActual].aus:0)+'</div><div class="stat-label">Ausencias</div></div></div><div class="cuadrante-nav no-print"><button class="nav-btn" onclick="cambiarMes(-1)">‚óÄ</button><select class="form-select" style="width:auto" onchange="mesActual=parseInt(this.value);renderProg()">';for(let i=0;i<MESES.length;i++){h+='<option value="'+i+'"'+(i===mesActual?' selected':'')+'>'+MESES[i].nombre+'</option>';}h+='</select><button class="nav-btn" onclick="cambiarMes(1)">‚ñ∂</button><span class="trimestre-badge t'+mes.trim+'">T'+mes.trim+'</span><button class="btn btn-ai btn-sm" onclick="abrirChatGPTCuadrante()">ü§ñ ChatGPT</button></div>';h+='<div class="leyenda no-print"><div class="leyenda-item"><div class="leyenda-color" style="background:#fee2e2"></div>Ausencia</div><div class="leyenda-item"><div class="leyenda-color" style="background:#e0e7ff"></div>Sin cole</div><div class="leyenda-item"><div class="leyenda-color" style="background:#dcfce7"></div>Conseguido</div><div class="leyenda-item"><div class="leyenda-color" style="background:#fef3c7"></div>Repetir</div></div>';h+='<div style="overflow-x:auto;margin-top:8px"><table class="cuadrante-table"><thead><tr><th>S</th>';for(let i=0;i<noms.length;i++){h+='<th>'+noms[i]+'</th>';}h+='</tr></thead><tbody>';for(let si=0;si<mes.semanas;si++){const sem=si+1;h+='<tr><td>'+sem+'</td>';for(let di=0;di<dias.length;di++){h+=renderCelda(a,mesActual+'_'+sem+'_'+dias[di],dias[di]);}h+='</tr>';}h+='</tbody></table></div></div>';document.getElementById('tabProgramacion').innerHTML=h;}
        
        function renderCelda(a,k,d){const c=a.programacion?a.programacion[k]:null,aus=a.ausencias?a.ausencias[k]:false,sc=a.sincole?a.sincole[k]:false,res=a.resultados?a.resultados[k]:null;let cls='celda',icon='';if(sc){cls+=' celda-sincole';icon='üè´';}else if(aus){cls+=' celda-ausencia';icon='‚ùå';}else if(res==='conseguido'){icon='‚úÖ';}else if(res==='repetir'){icon='üîÑ';}if(!c||!a.programas||!a.programas[c.pId]){return'<td class="'+cls+' celda-vacia" onclick="editarCelda(\''+k+'\','+d+')">'+(icon?'<span class="celda-icon">'+icon+'</span>':'')+'+</td>';}const p=a.programas[c.pId],obj=p.objetivos?p.objetivos[c.oIdx]:null;if(!obj)return'<td class="'+cls+'">?</td>';const info=AREAS[p.tipo]||{color:'#666'},ind=obj.indicadores?(obj.indicadores[c.iIdx]||''):'';return'<td class="'+cls+'" onclick="editarCelda(\''+k+'\','+d+')">'+(icon?'<span class="celda-icon">'+icon+'</span>':'')+'<div class="celda-obj" style="color:'+info.color+'">O'+obj.numero+'</div><div class="celda-ind">'+ind.substring(0,25)+(ind.length>25?'...':'')+'</div></td>';}
        function cambiarMes(dir){mesActual=Math.max(0,Math.min(9,mesActual+dir));renderProg();}
        
        function editarCelda(k,d){celdaEditando=k;estadoCelda='asiste';resultadoCelda=null;const a=alumnos[alumnoActual],c=a.programacion?a.programacion[k]:{};document.getElementById('celdaTitulo').textContent=DIAS[d];document.querySelectorAll('.asist-btn').forEach(b=>b.classList.remove('selected'));document.querySelectorAll('.resultado-btn').forEach(b=>b.classList.remove('selected'));if(a.sincole&&a.sincole[k]){estadoCelda='sincole';document.querySelector('.asist-btn.sincole').classList.add('selected');document.getElementById('contenidoSesion').style.display='none';}else if(a.ausencias&&a.ausencias[k]){estadoCelda='ausencia';document.querySelector('.asist-btn.ausencia').classList.add('selected');document.getElementById('contenidoSesion').style.display='none';}else{document.querySelector('.asist-btn.asiste').classList.add('selected');document.getElementById('contenidoSesion').style.display='block';}resultadoCelda=(a.resultados&&a.resultados[k])?a.resultados[k]:null;if(resultadoCelda){const btn=document.querySelector('.resultado-btn.'+resultadoCelda);if(btn)btn.classList.add('selected');}const sel=document.getElementById('selPrograma');sel.innerHTML='<option value="">-</option>';if(a.programas){Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{icon:'üìÑ'};sel.innerHTML+='<option value="'+pId+'"'+(c.pId===pId?' selected':'')+'>'+info.icon+' '+(info.nombre||p.tipo)+'</option>';});}if(c.pId){cargarObjetivos();setTimeout(()=>{document.getElementById('selObjetivo').value=c.oIdx!==undefined?c.oIdx:'';cargarIndicadores();setTimeout(()=>{document.getElementById('selIndicador').value=c.iIdx!==undefined?c.iIdx:'';},30);},30);}else{document.getElementById('selObjetivo').innerHTML='<option value="">-</option>';document.getElementById('selIndicador').innerHTML='<option value="">-</option>';}abrirModal('modalCelda');}
        
        function setEstado(e,btn){estadoCelda=e;document.querySelectorAll('.asist-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');document.getElementById('contenidoSesion').style.display=e==='asiste'?'block':'none';}
        function setResultado(r,btn){if(resultadoCelda===r){resultadoCelda=null;btn.classList.remove('selected');}else{resultadoCelda=r;document.querySelectorAll('.resultado-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');}}
        function cargarObjetivos(){const a=alumnos[alumnoActual],pId=document.getElementById('selPrograma').value,sel=document.getElementById('selObjetivo');sel.innerHTML='<option value="">-</option>';document.getElementById('selIndicador').innerHTML='<option value="">-</option>';if(!pId||!a.programas||!a.programas[pId])return;a.programas[pId].objetivos.forEach((o,i)=>{sel.innerHTML+='<option value="'+i+'">O'+o.numero+': '+o.descripcion.substring(0,20)+'...</option>';});}
        function cargarIndicadores(){const a=alumnos[alumnoActual],pId=document.getElementById('selPrograma').value,oIdx=document.getElementById('selObjetivo').value,sel=document.getElementById('selIndicador');sel.innerHTML='<option value="">-</option>';if(!pId||oIdx==='')return;const inds=a.programas[pId].objetivos[parseInt(oIdx)].indicadores||[];inds.forEach((x,i)=>{sel.innerHTML+='<option value="'+i+'">'+x.substring(0,30)+'...</option>';});}
        
        function guardarCelda(){
            const a=alumnos[alumnoActual];const updates={};const contenidoActual=a.programacion?a.programacion[celdaEditando]:null;
            updates['gestorpe/alumnos/'+alumnoActual+'/ausencias/'+celdaEditando]=null;updates['gestorpe/alumnos/'+alumnoActual+'/sincole/'+celdaEditando]=null;updates['gestorpe/alumnos/'+alumnoActual+'/resultados/'+celdaEditando]=null;
            if(estadoCelda==='ausencia'||estadoCelda==='sincole'){
                const tipo=estadoCelda==='ausencia'?'ausencias':'sincole';updates['gestorpe/alumnos/'+alumnoActual+'/'+tipo+'/'+celdaEditando]=true;
                if(contenidoActual){const nuevaProg=reajustarDesde(a,celdaEditando);updates['gestorpe/alumnos/'+alumnoActual+'/programacion']=nuevaProg;toast('Sesi√≥n desplazada ‚úì','success');}
            }else{
                const pId=document.getElementById('selPrograma').value;const oIdx=document.getElementById('selObjetivo').value;const iIdx=document.getElementById('selIndicador').value;
                if(pId&&oIdx!==''){const nuevoContenido={pId:pId,oIdx:parseInt(oIdx),iIdx:iIdx!==''?parseInt(iIdx):0};updates['gestorpe/alumnos/'+alumnoActual+'/programacion/'+celdaEditando]=nuevoContenido;
                if(resultadoCelda==='repetir'){const nuevaProg=insertarRepeticion(a,celdaEditando,nuevoContenido);updates['gestorpe/alumnos/'+alumnoActual+'/programacion']=nuevaProg;toast('Sesi√≥n repetida la pr√≥xima semana ‚úì','success');}}
                if(resultadoCelda){updates['gestorpe/alumnos/'+alumnoActual+'/resultados/'+celdaEditando]=resultadoCelda;}
            }
            db.ref().update(updates).then(()=>{cerrarModal('modalCelda');if(!updates['gestorpe/alumnos/'+alumnoActual+'/programacion']){toast('Guardado ‚úì','success');}});
        }
        
        function borrarCelda(){const updates={};['programacion','ausencias','sincole','resultados'].forEach(t=>{updates['gestorpe/alumnos/'+alumnoActual+'/'+t+'/'+celdaEditando]=null;});db.ref().update(updates).then(()=>{cerrarModal('modalCelda');toast('Eliminado','success');});}
        
        function calcStats(a){const aus=a.ausencias||{},res=a.resultados||{};let ausencias=0,conseguidos=0,repetir=0;const dias=a.diasSesion||[1,3,4],porMes={},porTrim={1:{aus:0},2:{aus:0},3:{aus:0}};for(let mi=0;mi<MESES.length;mi++){const m=MESES[mi];porMes[mi]={aus:0};for(let s=1;s<=m.semanas;s++){for(let di=0;di<dias.length;di++){const k=mi+'_'+s+'_'+dias[di];if(aus[k]){ausencias++;porMes[mi].aus++;porTrim[m.trim].aus++;}if(res[k]==='conseguido')conseguidos++;if(res[k]==='repetir')repetir++;}}}return{ausencias:ausencias,conseguidos:conseguidos,repetir:repetir,porMes:porMes,porTrim:porTrim};}
        
        function renderEval(){const a=alumnos[alumnoActual];let h='<div class="card"><div class="card-header"><h3 class="card-title">üìä Evaluaci√≥n</h3></div><div class="btn-group no-print" style="margin-bottom:12px"><button class="btn '+(evalTrim===1?'btn-primary':'btn-secondary')+' btn-sm" onclick="setTrim(1)">T1</button><button class="btn '+(evalTrim===2?'btn-primary':'btn-secondary')+' btn-sm" onclick="setTrim(2)">T2</button><button class="btn '+(evalTrim===3?'btn-primary':'btn-secondary')+' btn-sm" onclick="setTrim(3)">T3</button><button class="btn btn-warning btn-sm" onclick="abrirModalInforme()">üìÑ Informe</button>';if(evalTrim<3){h+='<button class="btn btn-ai btn-sm" onclick="pasarNoConseguidos()">üì§ Pasar P/N a T'+(evalTrim+1)+'</button>';}h+='</div><div class="chart-container no-print"><canvas id="chartProgreso"></canvas></div><div id="evalList"></div></div>';document.getElementById('tabEvaluacion').innerHTML=h;renderEvalList();setTimeout(renderEvalCharts,100);}
        function setTrim(t){evalTrim=t;renderEval();}
        
        function renderEvalCharts(){const a=alumnos[alumnoActual];if(!a.programas)return;const ctx=document.getElementById('chartProgreso');if(!ctx)return;if(charts.progreso)charts.progreso.destroy();const labels=[],conseguidos=[],proceso=[],noIniciados=[];Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};labels.push(info.nombre.substring(0,12));let c=0,pr=0,n=0;(p.objetivos||[]).forEach((obj,oi)=>{(obj.indicadores||[]).forEach((_,ii)=>{let found=false;for(let t=1;t<=3;t++){const k=pId+'_'+oi+'_'+ii+'_T'+t,e=a.evaluaciones?a.evaluaciones[k]:null;if(e==='C'){c++;found=true;break;}else if(e==='P'){pr++;found=true;break;}else if(e==='N'){n++;found=true;break;}}if(!found)n++;});});conseguidos.push(c);proceso.push(pr);noIniciados.push(n);});charts.progreso=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Conseguido',data:conseguidos,backgroundColor:'#22c55e'},{label:'En proceso',data:proceso,backgroundColor:'#3b82f6'},{label:'No iniciado',data:noIniciados,backgroundColor:'#d1d5db'}]},options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{x:{stacked:true},y:{stacked:true}}}});}
        
        function renderEvalList(){const a=alumnos[alumnoActual],c=document.getElementById('evalList');let h='',hay=false;if(!a.programas){c.innerHTML='<p style="text-align:center;color:var(--text-light)">Sin programas</p>';return;}const pasadosAqui=getIndicadoresPasados(a,evalTrim);Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{icon:'üìÑ',nombre:p.tipo,color:'#666'};const objsT=(p.objetivos||[]).filter(o=>o.trimestre===evalTrim);const pasadosProg=pasadosAqui.filter(x=>x.pId===pId);if(!objsT.length&&!pasadosProg.length)return;hay=true;h+='<div class="programa-card" style="border-left-color:'+info.color+'"><div class="programa-titulo" style="margin-bottom:8px">'+info.icon+' '+info.nombre+'</div>';objsT.forEach(obj=>{const oi=p.objetivos.indexOf(obj);h+='<div style="margin-bottom:8px"><div style="font-weight:600;font-size:.8rem;margin-bottom:4px">O'+obj.numero+': '+obj.descripcion.substring(0,30)+'...</div>';(obj.indicadores||[]).forEach((ind,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';h+='<div class="eval-item"><span class="eval-text">'+ind+'</span><button class="eval-btn c '+(e==='C'?'active':'')+'" onclick="setEval(\''+pId+'\','+oi+','+ii+',\'C\')">‚úì</button><button class="eval-btn p '+(e==='P'?'active':'')+'" onclick="setEval(\''+pId+'\','+oi+','+ii+',\'P\')">‚óê</button><button class="eval-btn n '+(e==='N'?'active':'')+'" onclick="setEval(\''+pId+'\','+oi+','+ii+',\'N\')">‚óã</button></div>';});h+='</div>';});if(pasadosProg.length){h+='<div style="margin-top:8px;padding-top:8px;border-top:1px dashed var(--border)"><div style="font-size:.75rem;color:var(--warning);margin-bottom:6px">üì§ Pasados de trimestre anterior:</div>';pasadosProg.forEach(item=>{const obj=p.objetivos[item.oIdx];if(!obj)return;const ind=obj.indicadores?obj.indicadores[item.iIdx]:'';const k=pId+'_'+item.oIdx+'_'+item.iIdx+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';h+='<div class="eval-item"><span class="eval-text">O'+obj.numero+': '+ind+'<span class="pasado-badge">de T'+(evalTrim-1)+'</span></span><button class="eval-btn c '+(e==='C'?'active':'')+'" onclick="setEval(\''+pId+'\','+item.oIdx+','+item.iIdx+',\'C\')">‚úì</button><button class="eval-btn p '+(e==='P'?'active':'')+'" onclick="setEval(\''+pId+'\','+item.oIdx+','+item.iIdx+',\'P\')">‚óê</button><button class="eval-btn n '+(e==='N'?'active':'')+'" onclick="setEval(\''+pId+'\','+item.oIdx+','+item.iIdx+',\'N\')">‚óã</button></div>';});h+='</div>';}h+='</div>';});c.innerHTML=hay?h:'<p style="text-align:center;color:var(--text-light)">Sin indicadores en T'+evalTrim+'</p>';}
        
        function setEval(pId,oi,ii,e){const a=alumnos[alumnoActual],k=pId+'_'+oi+'_'+ii+'_T'+evalTrim;a.evaluaciones=a.evaluaciones||{};if(a.evaluaciones[k]===e){db.ref('gestorpe/alumnos/'+alumnoActual+'/evaluaciones/'+k).remove();delete a.evaluaciones[k];}else{db.ref('gestorpe/alumnos/'+alumnoActual+'/evaluaciones/'+k).set(e);a.evaluaciones[k]=e;}renderEvalList();setTimeout(renderEvalCharts,100);}
        
        function pasarNoConseguidos(){if(evalTrim>=3){toast('Ya est√°s en T3','error');return;}const a=alumnos[alumnoActual];if(!a.programas){toast('Sin programas','error');return;}const siguienteTrim=evalTrim+1,updates={};let count=0;Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId];(p.objetivos||[]).forEach((obj,oi)=>{if(obj.trimestre!==evalTrim)return;(obj.indicadores||[]).forEach((_,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';if(e!=='C'){const pasadoKey=pId+'_'+oi+'_'+ii;updates['gestorpe/alumnos/'+alumnoActual+'/pasados/'+pasadoKey]=siguienteTrim;count++;}});});});const pasadosActuales=getIndicadoresPasados(a,evalTrim);pasadosActuales.forEach(item=>{const k=item.pId+'_'+item.oIdx+'_'+item.iIdx+'_T'+evalTrim,e=a.evaluaciones?a.evaluaciones[k]:'';if(e!=='C'){updates['gestorpe/alumnos/'+alumnoActual+'/pasados/'+item.key]=siguienteTrim;count++;}});if(count===0){toast('¬°Todo conseguido en T'+evalTrim+'!','success');return;}db.ref().update(updates).then(()=>{const nueva=generarProgramacion(alumnos[alumnoActual]);return db.ref('gestorpe/alumnos/'+alumnoActual+'/programacion').set(nueva);}).then(()=>{toast(count+' indicadores P/N ‚Üí T'+siguienteTrim,'success');evalTrim=siguienteTrim;renderEval();renderProg();});}
        
        function renderAsis(){const a=alumnos[alumnoActual],st=calcStats(a);let totalC=0,totalP=0,totalN=0;if(a.evaluaciones){Object.keys(a.evaluaciones).forEach(k=>{const e=a.evaluaciones[k];if(e==='C')totalC++;else if(e==='P')totalP++;else if(e==='N')totalN++;});}document.getElementById('tabAsistencia').innerHTML='<div class="card"><div class="card-header"><h3 class="card-title">üìà Resumen General</h3></div><div class="stats-box"><div class="stat-item"><div class="stat-num" style="color:var(--danger)">'+st.ausencias+'</div><div class="stat-label">Ausencias</div></div><div class="stat-item"><div class="stat-num" style="color:var(--success)">'+st.conseguidos+'</div><div class="stat-label">Sesiones OK</div></div><div class="stat-item"><div class="stat-num" style="color:var(--warning)">'+st.repetir+'</div><div class="stat-label">Repetir</div></div></div><div class="stats-box"><div class="stat-item"><div class="stat-num" style="color:var(--success)">'+totalC+'</div><div class="stat-label">Ind. Conseguidos</div></div><div class="stat-item"><div class="stat-num" style="color:var(--proceso)">'+totalP+'</div><div class="stat-label">Ind. En proceso</div></div><div class="stat-item"><div class="stat-num" style="color:gray">'+totalN+'</div><div class="stat-label">Ind. No iniciados</div></div></div><div class="chart-container"><canvas id="chartAusTrim"></canvas></div><div class="chart-container"><canvas id="chartAusMes"></canvas></div></div>';setTimeout(renderAsisCharts,100);}
        
        function renderAsisCharts(){const a=alumnos[alumnoActual],st=calcStats(a);const ctx1=document.getElementById('chartAusTrim');if(ctx1){if(charts.ausTrim)charts.ausTrim.destroy();charts.ausTrim=new Chart(ctx1,{type:'bar',data:{labels:['T1','T2','T3'],datasets:[{label:'Ausencias',data:[st.porTrim[1].aus,st.porTrim[2].aus,st.porTrim[3].aus],backgroundColor:'#ef4444'}]},options:{responsive:true,plugins:{legend:{display:false},title:{display:true,text:'Ausencias por trimestre'}}}});}const ctx2=document.getElementById('chartAusMes');if(ctx2){if(charts.ausMes)charts.ausMes.destroy();charts.ausMes=new Chart(ctx2,{type:'line',data:{labels:MESES.map(m=>m.nombre.substring(0,3)),datasets:[{label:'Ausencias',data:MESES.map((_,i)=>st.porMes[i]?st.porMes[i].aus:0),borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.1)',fill:true,tension:.3}]},options:{responsive:true,plugins:{legend:{display:false},title:{display:true,text:'Ausencias por mes'}}}});}}
        
        function abrirModalInforme(){document.getElementById('informeTrim').value=evalTrim;document.getElementById('informePreview').style.display='none';document.getElementById('btnImprimirInforme').style.display='none';informeData=null;abrirModal('modalInforme');}
        
        function generarInforme(){const trim=parseInt(document.getElementById('informeTrim').value),a=alumnos[alumnoActual],st=calcStats(a);const conseguidos=[],proceso=[],noIniciados=[];if(a.programas){Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};(p.objetivos||[]).forEach((obj,oi)=>{(obj.indicadores||[]).forEach((ind,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+trim,e=a.evaluaciones?a.evaluaciones[k]:null,item={programa:info.nombre,objetivo:'O'+obj.numero,indicador:ind};if(e==='C')conseguidos.push(item);else if(e==='P')proceso.push(item);else noIniciados.push(item);});});});}informeData={alumno:a,trim:trim,conseguidos:conseguidos,proceso:proceso,noIniciados:noIniciados,ausencias:st.porTrim[trim]?st.porTrim[trim].aus:0};const total=conseguidos.length+proceso.length+noIniciados.length,porcC=total?Math.round(conseguidos.length/total*100):0;document.getElementById('informePreview').innerHTML='<h4>üìÑ Informe T'+trim+' - '+a.siglas+'</h4><p><strong>Alumno:</strong> '+a.siglas+' | <strong>Curso:</strong> '+a.curso+'</p><hr><p><strong>‚úÖ Conseguidos:</strong> '+conseguidos.length+' ('+porcC+'%)</p><p><strong>üîÑ En proceso:</strong> '+proceso.length+'</p><p><strong>‚≠ï No iniciados:</strong> '+noIniciados.length+'</p><p><strong>‚ùå Ausencias:</strong> '+informeData.ausencias+'</p>';document.getElementById('informePreview').style.display='block';document.getElementById('btnImprimirInforme').style.display='inline-flex';toast('Informe generado','success');}
        
        function abrirChatGPTInforme(){const trim=parseInt(document.getElementById('informeTrim').value),a=alumnos[alumnoActual],st=calcStats(a);const conseguidos=[],proceso=[],noIniciados=[];if(a.programas){Object.keys(a.programas).forEach(pId=>{const p=a.programas[pId],info=AREAS[p.tipo]||{nombre:p.tipo};(p.objetivos||[]).forEach((obj,oi)=>{(obj.indicadores||[]).forEach((ind,ii)=>{const k=pId+'_'+oi+'_'+ii+'_T'+trim,e=a.evaluaciones?a.evaluaciones[k]:null,item=info.nombre+': '+ind;if(e==='C')conseguidos.push(item);else if(e==='P')proceso.push(item);else noIniciados.push(item);});});});}const prompt='Genera una valoraci√≥n profesional para un informe de Pedagog√≠a Terap√©utica.\n\nALUMNO: '+a.siglas+' ('+a.curso+')\nTRIMESTRE: '+trim+'\n\nINDICADORES CONSEGUIDOS ('+conseguidos.length+'):\n'+(conseguidos.slice(0,15).map(x=>'- '+x).join('\n')||'Ninguno')+'\n\nINDICADORES EN PROCESO ('+proceso.length+'):\n'+(proceso.slice(0,15).map(x=>'- '+x).join('\n')||'Ninguno')+'\n\nINDICADORES NO INICIADOS ('+noIniciados.length+'):\n'+(noIniciados.slice(0,10).map(x=>'- '+x).join('\n')||'Ninguno')+'\n\nAUSENCIAS: '+(st.porTrim[trim]?st.porTrim[trim].aus:0)+'\n\nEscribe una valoraci√≥n de 2-3 p√°rrafos con tono profesional pero cercano para incluir en el informe trimestral.';navigator.clipboard.writeText(prompt).then(()=>{toast('Copiado - Pega en ChatGPT','success');window.open('https://chat.openai.com/','_blank');}).catch(()=>{const ta=document.createElement('textarea');ta.value=prompt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Copiado - Pega en ChatGPT','success');window.open('https://chat.openai.com/','_blank');});}
        
        function abrirChatGPTCuadrante(){const a=alumnos[alumnoActual],dias=a.diasSesion||[1,3,4],mes=MESES[mesActual];let tabla='ALUMNO: '+a.siglas+' ('+a.curso+')\nMES: '+mes.nombre+' - T'+mes.trim+'\n\nPROGRAMACI√ìN MENSUAL:\n\n';tabla+='| Semana | '+dias.map(d=>DIAS_C[d]).join(' | ')+' |\n';tabla+='|--------|'+dias.map(()=>'---').join('|')+'|\n';for(let si=0;si<mes.semanas;si++){const sem=si+1;let fila='| S'+sem+' |';dias.forEach(d=>{const k=mesActual+'_'+sem+'_'+d,c=a.programacion?a.programacion[k]:null;if(c&&a.programas&&a.programas[c.pId]){const p=a.programas[c.pId],obj=p.objetivos?p.objetivos[c.oIdx]:null;if(obj){const ind=obj.indicadores?(obj.indicadores[c.iIdx]||''):'';fila+=' O'+obj.numero+': '+ind.substring(0,15)+' |';}else{fila+=' - |';}}else{fila+=' - |';}});tabla+=fila+'\n';}const prompt='Crea un cuadrante/tabla bonito y profesional para imprimir con esta programaci√≥n de Pedagog√≠a Terap√©utica. Incluye espacio para notas a mano en cada celda. Formato visual atractivo.\n\n'+tabla;navigator.clipboard.writeText(prompt).then(()=>{toast('Copiado - Pega en ChatGPT','success');window.open('https://chat.openai.com/','_blank');}).catch(()=>{const ta=document.createElement('textarea');ta.value=prompt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Copiado - Pega en ChatGPT','success');window.open('https://chat.openai.com/','_blank');});}
        
        function imprimirInforme(){if(!informeData){toast('Genera el informe primero','error');return;}const a=informeData.alumno,win=window.open('','_blank');win.document.write('<!DOCTYPE html><html><head><title>Informe '+a.siglas+' T'+informeData.trim+'</title><style>body{font-family:Arial,sans-serif;padding:30px;max-width:800px;margin:0 auto}h1{color:#1a5f4a;border-bottom:2px solid #1a5f4a;padding-bottom:10px}h2{color:#333;margin-top:20px}.dato{margin:8px 0}.indicador{margin:5px 0 5px 20px}.stats{display:flex;gap:30px;margin:20px 0}.stat{text-align:center}.stat-num{font-size:2em;font-weight:bold}.stat-label{font-size:.9em;color:#666}@media print{body{padding:0}}</style></head><body><h1>INFORME DE SEGUIMIENTO - '+informeData.trim+'¬∫ TRIMESTRE</h1><p class="dato"><strong>Alumno/a:</strong> '+a.siglas+' | <strong>Curso:</strong> '+a.curso+'</p><p class="dato"><strong>Fecha:</strong> '+new Date().toLocaleDateString('es-ES')+'</p><div class="stats"><div class="stat"><div class="stat-num" style="color:#22c55e">'+informeData.conseguidos.length+'</div><div class="stat-label">Conseguidos</div></div><div class="stat"><div class="stat-num" style="color:#3b82f6">'+informeData.proceso.length+'</div><div class="stat-label">En proceso</div></div><div class="stat"><div class="stat-num" style="color:#888">'+informeData.noIniciados.length+'</div><div class="stat-label">No iniciados</div></div><div class="stat"><div class="stat-num" style="color:#ef4444">'+informeData.ausencias+'</div><div class="stat-label">Ausencias</div></div></div><h2>‚úÖ Indicadores Conseguidos</h2>'+(informeData.conseguidos.length?informeData.conseguidos.map(x=>'<p class="indicador">‚Ä¢ <strong>'+x.programa+'</strong>: '+x.indicador+'</p>').join(''):'<p><em>Ninguno</em></p>')+'<h2>üîÑ Indicadores En Proceso</h2>'+(informeData.proceso.length?informeData.proceso.map(x=>'<p class="indicador">‚Ä¢ <strong>'+x.programa+'</strong>: '+x.indicador+'</p>').join(''):'<p><em>Ninguno</em></p>')+'<h2>‚≠ï Indicadores No Iniciados</h2>'+(informeData.noIniciados.length?informeData.noIniciados.map(x=>'<p class="indicador">‚Ä¢ <strong>'+x.programa+'</strong>: '+x.indicador+'</p>').join(''):'<p><em>Ninguno</em></p>')+'<div style="margin-top:60px;text-align:right"><p>Fdo: _______________________</p><p>Maestro/a de PT/AL</p></div></body></html>');win.document.close();setTimeout(()=>{win.print();},300);}
        
        // IMPRESI√ìN MASIVA
        function abrirModalImprimir(){
            if(!Object.keys(alumnos).length){toast('No hay alumnos','error');return;}
            abrirModal('modalImprimir');
        }
        
        function imprimirTodos(){
            const mesSeleccionado=parseInt(document.getElementById('printMes').value);
            const ids=Object.keys(alumnos);
            if(!ids.length){toast('No hay alumnos','error');return;}
            
            let html='<!DOCTYPE html><html><head><title>Programaciones PE</title><style>body{font-family:Arial,sans-serif;padding:20px;font-size:11px}h1{color:#1a5f4a;font-size:16px;margin-bottom:5px}h2{color:#1a5f4a;font-size:14px;margin:15px 0 8px;border-bottom:2px solid #1a5f4a;padding-bottom:5px}h3{font-size:12px;margin:10px 0 5px;color:#333}.alumno-section{page-break-after:always;margin-bottom:30px}.alumno-section:last-child{page-break-after:avoid}table{width:100%;border-collapse:collapse;margin-bottom:15px}th,td{border:1px solid #ccc;padding:6px;text-align:left}th{background:#1a5f4a;color:#fff;text-align:center}td:first-child{background:#2d8a6e;color:#fff;text-align:center;width:50px}.celda-content{min-height:40px}.obj{font-weight:bold;color:#1a5f4a}.ind{font-size:10px;color:#333}.ausencia{background:#fee2e2!important}.sincole{background:#e0e7ff!important}.info{margin-bottom:10px;color:#666}@media print{body{padding:10px}.alumno-section{page-break-after:always}}</style></head><body>';
            
            ids.forEach(id=>{
                const a=alumnos[id];
                const dias=a.diasSesion||[1,3,4];
                const diasNombres=dias.map(d=>DIAS_C[d]);
                
                html+='<div class="alumno-section">';
                html+='<h1>üìã '+a.siglas+' - '+a.curso+'</h1>';
                html+='<p class="info">D√≠as: '+diasNombres.join(', ')+' | Generado: '+new Date().toLocaleDateString('es-ES')+'</p>';
                
                const mesesAImprimir=mesSeleccionado===-1?MESES.map((_,i)=>i):[mesSeleccionado];
                
                mesesAImprimir.forEach(mi=>{
                    const mes=MESES[mi];
                    html+='<h2>'+mes.nombre+' (T'+mes.trim+')</h2>';
                    html+='<table><thead><tr><th>Sem</th>';
                    diasNombres.forEach(d=>{html+='<th>'+d+'</th>';});
                    html+='</tr></thead><tbody>';
                    
                    for(let s=1;s<=mes.semanas;s++){
                        html+='<tr><td>S'+s+'</td>';
                        dias.forEach(d=>{
                            const k=mi+'_'+s+'_'+d;
                            const c=a.programacion?a.programacion[k]:null;
                            const aus=a.ausencias?a.ausencias[k]:false;
                            const sc=a.sincole?a.sincole[k]:false;
                            let cls='';
                            if(sc)cls='sincole';else if(aus)cls='ausencia';
                            
                            html+='<td class="'+cls+'">';
                            if(sc){
                                html+='<div class="celda-content">üè´ Sin cole</div>';
                            }else if(aus){
                                html+='<div class="celda-content">‚ùå Ausencia</div>';
                            }else if(c&&a.programas&&a.programas[c.pId]){
                                const p=a.programas[c.pId];
                                const obj=p.objetivos?p.objetivos[c.oIdx]:null;
                                if(obj){
                                    const ind=obj.indicadores?(obj.indicadores[c.iIdx]||''):'';
                                    html+='<div class="celda-content"><div class="obj">O'+obj.numero+'</div><div class="ind">'+ind+'</div></div>';
                                }else{
                                    html+='<div class="celda-content">-</div>';
                                }
                            }else{
                                html+='<div class="celda-content">-</div>';
                            }
                            html+='</td>';
                        });
                        html+='</tr>';
                    }
                    html+='</tbody></table>';
                });
                
                html+='</div>';
            });
            
            html+='</body></html>';
            
            const win=window.open('','_blank');
            win.document.write(html);
            win.document.close();
            setTimeout(()=>{win.print();},500);
            cerrarModal('modalImprimir');
            toast('Documento generado ‚úì','success');
        }
        
        function abrirModal(id){document.getElementById(id).classList.add('active');}
        function cerrarModal(id){document.getElementById(id).classList.remove('active');}
        function toast(msg,tipo){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+(tipo||'');setTimeout(()=>{t.classList.add('show');},10);setTimeout(()=>{t.classList.remove('show');},2500);}
    </script>
</body>
</html>
