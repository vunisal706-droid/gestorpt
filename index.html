<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a5f4a">
    <title>Gestor PE - Programas Espec√≠ficos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #1a5f4a;
            --primary-light: #2d8a6e;
            --primary-dark: #134536;
            --bg: #f5f7f6;
            --bg-card: #ffffff;
            --text: #1a2a24;
            --text-light: #5a6b64;
            --border: #d4ddd9;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --proceso: #3b82f6;
            
            --cognitivo: #8b5cf6;
            --atencion: #f59e0b;
            --memoria: #06b6d4;
            --comunicacion: #10b981;
            --lectoescritura: #3b82f6;
            --matematico: #ef4444;
            --social: #ec4899;
            --emocional: #f97316;
            --ejecutivas: #6366f1;
            --autonomia: #14b8a6;
            
            --t1: #8b5cf6;
            --t2: #06b6d4;
            --t3: #f59e0b;
            --shadow: 0 4px 20px rgba(26, 95, 74, 0.1);
            --shadow-lg: 0 8px 40px rgba(26, 95, 74, 0.15);
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        .status-dot.connected { background: var(--success); animation: none; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .btn-back {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-back:hover { background: rgba(255,255,255,0.25); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alumnos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 14px;
            margin-top: 16px;
        }

        .alumno-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            position: relative;
        }

        .alumno-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .alumno-siglas {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .alumno-curso { font-size: 0.8rem; color: var(--text-light); }

        .alumno-estado {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .alumno-estado.con-programa { background: var(--success); color: white; }
        .alumno-estado.sin-programa { background: var(--border); color: var(--text-light); }

        .alumno-card-add {
            background: transparent;
            border: 2px dashed var(--primary-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--primary);
            min-height: 100px;
        }

        .alumno-card-add:hover { background: rgba(26, 95, 74, 0.05); }

        .tabs {
            display: flex;
            gap: 6px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 90px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover { background: var(--bg); }
        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 74, 0.1);
        }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-primary:disabled { background: var(--border); cursor: not-allowed; }
        .btn-secondary { background: var(--bg); color: var(--text); border: 2px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .area-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .area-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .programa-section {
            margin-bottom: 24px;
            border-left: 4px solid var(--primary);
            padding-left: 16px;
        }

        .programa-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .objetivo-item {
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 12px;
        }

        .objetivo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .objetivo-badges { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }

        .objetivo-codigo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(26, 95, 74, 0.15);
            color: var(--primary);
        }

        .trimestre-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .trimestre-badge.t1 { background: rgba(139, 92, 246, 0.15); color: var(--t1); }
        .trimestre-badge.t2 { background: rgba(6, 182, 212, 0.15); color: var(--t2); }
        .trimestre-badge.t3 { background: rgba(245, 158, 11, 0.15); color: var(--t3); }

        .objetivo-descripcion { font-weight: 500; font-size: 0.95rem; margin-bottom: 10px; }

        .objetivo-section {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .objetivo-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .indicador-item, .contenido-item, .actividad-item {
            background: white;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .item-bullet {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 6px;
            flex-shrink: 0;
            background: var(--primary);
        }

        /* CUADRANTE */
        .cuadrante-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .semana-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .semana-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .semana-nav-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .semana-nav-btn:hover { border-color: var(--primary); color: var(--primary); }

        .semana-titulo {
            font-weight: 700;
            font-size: 1rem;
            min-width: 180px;
            text-align: center;
        }

        .cuadrante-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .cuadrante-table th, .cuadrante-table td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }

        .cuadrante-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .cuadrante-table th:first-child {
            width: 80px;
        }

        .cuadrante-table td:first-child {
            background: var(--primary-light);
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .cuadrante-celda {
            min-height: 80px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .cuadrante-celda:hover {
            background: var(--bg);
        }

        .cuadrante-celda.vacia {
            background: #f9fafb;
        }

        .celda-objetivo {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .celda-indicador {
            font-size: 0.75rem;
            color: var(--text);
            margin-bottom: 4px;
        }

        .celda-actividad {
            font-size: 0.7rem;
            color: var(--text-light);
            font-style: italic;
        }

        .celda-color {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal.modal-lg { max-width: 700px; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-light); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

        .alumno-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .alumno-info-siglas {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            background: rgba(26, 95, 74, 0.1);
            padding: 14px 20px;
            border-radius: var(--radius);
        }

        .alumno-info-details { flex: 1; }
        .alumno-info-curso { font-size: 1.1rem; font-weight: 600; }
        .alumno-info-programas { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        .loading { display: flex; flex-direction: column; align-items: center; padding: 40px; gap: 12px; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(26, 95, 74, 0.05);
        }

        .upload-zone.has-file {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .upload-zone span { display: block; color: var(--text-light); }
        .upload-zone.has-file span { color: var(--success); }
        .upload-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .upload-hint { font-size: 0.85rem; margin-top: 8px; }

        .processing-box {
            display: none;
            text-align: center;
            padding: 20px;
            background: var(--bg);
            border-radius: var(--radius-sm);
            margin-top: 16px;
        }

        .processing-box.active { display: block; }

        .preview-box {
            display: none;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg);
            border-radius: var(--radius-sm);
            padding: 16px;
        }

        .preview-box.active { display: block; }

        .preview-objetivo {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
        }

        .preview-objetivo h4 { font-size: 0.9rem; margin-bottom: 6px; }
        .preview-list { font-size: 0.8rem; color: var(--text-light); margin-left: 16px; }

        .area-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .area-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .area-option:hover { border-color: var(--primary-light); }
        .area-option.selected { border-color: var(--primary); background: rgba(26, 95, 74, 0.05); }
        .area-option input { display: none; }

        .area-option-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .sesiones-selector {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .sesion-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            font-weight: 600;
        }

        .sesion-option:hover { border-color: var(--primary-light); }
        .sesion-option.selected { border-color: var(--primary); background: rgba(26, 95, 74, 0.1); }
        .sesion-option input { display: none; }

        .leyenda {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üìã Gestor PE v2</h1>
            <div class="header-right">
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Conectando...</span>
                </div>
                <button class="btn-back" id="btnVolver" style="display: none;" onclick="volverInicio()">‚Üê Volver</button>
            </div>
        </div>
    </header>

    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Mis Alumnos</h2>
                    <button class="btn btn-primary btn-sm" onclick="abrirModalSubirDOCX()">üìÑ Importar DOCX</button>
                </div>
                <div class="alumnos-grid" id="alumnosGrid">
                    <div class="loading"><div class="spinner"></div><span>Cargando...</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="screenAlumno" class="screen">
        <div class="container">
            <div class="alumno-info" id="alumnoInfoHeader"></div>
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('programa', this)">üìÑ Programa</button>
                <button class="tab" onclick="cambiarTab('programacion', this)">üìÖ Programaci√≥n</button>
                <button class="tab" onclick="cambiarTab('evaluacion', this)">üìä Evaluaci√≥n</button>
            </div>
            <div id="tabPrograma" class="tab-content active"><div id="programaContent"></div></div>
            <div id="tabProgramacion" class="tab-content"><div id="programacionContent"></div></div>
            <div id="tabEvaluacion" class="tab-content"><div id="evaluacionContent"></div></div>
        </div>
    </div>

    <!-- Modal Subir DOCX -->
    <div class="modal-overlay" id="modalSubirDOCX">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">üìÑ Importar Programa Espec√≠fico</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirDOCX')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Siglas del alumno *</label>
                        <input type="text" class="form-input" id="docxSiglas" placeholder="M.G.L." maxlength="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Curso *</label>
                        <select class="form-select" id="docxCurso">
                            <option value="Infantil 3 a√±os">Infantil 3 a√±os</option>
                            <option value="Infantil 4 a√±os">Infantil 4 a√±os</option>
                            <option value="Infantil 5 a√±os" selected>Infantil 5 a√±os</option>
                            <option value="1¬∫ Primaria">1¬∫ Primaria</option>
                            <option value="2¬∫ Primaria">2¬∫ Primaria</option>
                            <option value="3¬∫ Primaria">3¬∫ Primaria</option>
                            <option value="4¬∫ Primaria">4¬∫ Primaria</option>
                            <option value="5¬∫ Primaria">5¬∫ Primaria</option>
                            <option value="6¬∫ Primaria">6¬∫ Primaria</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Sesiones por semana *</label>
                    <div class="sesiones-selector">
                        <label class="sesion-option" onclick="seleccionarSesiones(1)">
                            <input type="radio" name="sesiones" value="1">
                            1 sesi√≥n
                        </label>
                        <label class="sesion-option" onclick="seleccionarSesiones(2)">
                            <input type="radio" name="sesiones" value="2">
                            2 sesiones
                        </label>
                        <label class="sesion-option selected" onclick="seleccionarSesiones(3)">
                            <input type="radio" name="sesiones" value="3" checked>
                            3 sesiones
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">√Årea del Programa *</label>
                    <select class="form-select" id="docxArea">
                        <option value="cognitivo">üß† Estimulaci√≥n cognitiva</option>
                        <option value="atencion">üëÅÔ∏è Atenci√≥n</option>
                        <option value="memoria">üíæ Memoria</option>
                        <option value="comunicacion" selected>üí¨ Comunicaci√≥n y lenguaje</option>
                        <option value="lectoescritura">üìñ Lectoescritura</option>
                        <option value="matematico">üî¢ Razonamiento matem√°tico</option>
                        <option value="social">ü§ù Habilidades sociales</option>
                        <option value="emocional">‚ù§Ô∏è Gesti√≥n emocional</option>
                        <option value="ejecutivas">üéØ Funciones ejecutivas</option>
                        <option value="autonomia">üèÉ Autonom√≠a</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Archivo DOCX *</label>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('inputDOCX').click()">
                        <div id="uploadZoneContent">
                            <div class="upload-icon">üìÑ</div>
                            <span>Haz clic o arrastra tu archivo DOCX</span>
                            <div class="upload-hint">Solo archivos .docx</div>
                        </div>
                    </div>
                    <input type="file" id="inputDOCX" accept=".docx" style="display:none" onchange="docxSeleccionado(this)">
                </div>

                <div class="processing-box" id="processingBox">
                    <div class="spinner"></div>
                    <p id="processingText">Extrayendo contenido...</p>
                </div>

                <div class="preview-box" id="previewBox">
                    <h4 style="margin-bottom: 12px; color: var(--primary-dark);">üìã Contenido extra√≠do:</h4>
                    <div id="previewContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalSubirDOCX')">Cancelar</button>
                <button class="btn btn-primary" id="btnImportar" onclick="importarPrograma()" disabled>üì• Importar y Programar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Celda -->
    <div class="modal-overlay" id="modalCelda">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalCeldaTitulo">Editar sesi√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalCelda')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Objetivo</label>
                    <select class="form-select" id="celdaObjetivo" onchange="actualizarIndicadores()"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Indicador</label>
                    <select class="form-select" id="celdaIndicador"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Actividad</label>
                    <select class="form-select" id="celdaActividad"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="limpiarCelda()">üóëÔ∏è Limpiar</button>
                <button class="btn btn-secondary" onclick="cerrarModal('modalCelda')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCelda()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCDmT-NPx9RvFnBzEVVqbBnJi0OgCSB4tU",
            authDomain: "capitulacionesapps.firebaseapp.com",
            databaseURL: "https://capitulacionesapps-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "capitulacionesapps",
            storageBucket: "capitulacionesapps.firebasestorage.app",
            messagingSenderId: "546505391498",
            appId: "1:546505391498:web:500239cd714aee2c056076"
        };

        const app = initializeApp(firebaseConfig);
        window.database = getDatabase(app);
        window.dbRef = ref;
        window.dbOnValue = onValue;
        window.dbPush = push;
        window.dbSet = set;
        window.dbRemove = remove;
        
        window.initApp();
    </script>

    <script>
        // ========== ESTADO GLOBAL ==========
        let alumnos = {};
        let alumnoActual = null;
        let mesActual = 0;
        let semanaActual = 1;
        let celdaEditando = null;
        let documentoExtraido = null;

        const AREAS_INFO = {
            cognitivo: { nombre: 'üß† Estimulaci√≥n cognitiva', color: '#8b5cf6' },
            atencion: { nombre: 'üëÅÔ∏è Atenci√≥n', color: '#f59e0b' },
            memoria: { nombre: 'üíæ Memoria', color: '#06b6d4' },
            comunicacion: { nombre: 'üí¨ Comunicaci√≥n y lenguaje', color: '#10b981' },
            lectoescritura: { nombre: 'üìñ Lectoescritura', color: '#3b82f6' },
            matematico: { nombre: 'üî¢ Razonamiento matem√°tico', color: '#ef4444' },
            social: { nombre: 'ü§ù Habilidades sociales', color: '#ec4899' },
            emocional: { nombre: '‚ù§Ô∏è Gesti√≥n emocional', color: '#f97316' },
            ejecutivas: { nombre: 'üéØ Funciones ejecutivas', color: '#6366f1' },
            autonomia: { nombre: 'üèÉ Autonom√≠a', color: '#14b8a6' }
        };

        const DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];

        const MESES = [
            { nombre: 'Septiembre', semanas: 3, trimestre: 1 },
            { nombre: 'Octubre', semanas: 4, trimestre: 1 },
            { nombre: 'Noviembre', semanas: 4, trimestre: 1 },
            { nombre: 'Diciembre', semanas: 3, trimestre: 1 },
            { nombre: 'Enero', semanas: 4, trimestre: 2 },
            { nombre: 'Febrero', semanas: 4, trimestre: 2 },
            { nombre: 'Marzo', semanas: 4, trimestre: 2 },
            { nombre: 'Abril', semanas: 3, trimestre: 3 },
            { nombre: 'Mayo', semanas: 4, trimestre: 3 },
            { nombre: 'Junio', semanas: 3, trimestre: 3 }
        ];

        // ========== INICIALIZACI√ìN ==========
        window.initApp = function() {
            console.log('üöÄ Iniciando app...');
            const alumnosRef = window.dbRef(window.database, 'gestorpe/alumnos');
            window.dbOnValue(alumnosRef, (snapshot) => {
                alumnos = snapshot.val() || {};
                console.log('üì¶ Alumnos cargados:', Object.keys(alumnos).length);
                renderizarAlumnos();
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Conectado';
            }, (error) => {
                console.error('‚ùå Error Firebase:', error);
                document.getElementById('statusText').textContent = 'Error';
            });

            // Drag & drop
            const zone = document.getElementById('uploadZone');
            if (zone) {
                zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
                zone.ondragleave = () => zone.classList.remove('dragover');
                zone.ondrop = (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    if (e.dataTransfer.files[0]) {
                        document.getElementById('inputDOCX').files = e.dataTransfer.files;
                        docxSeleccionado(document.getElementById('inputDOCX'));
                    }
                };
            }
        };

        function seleccionarSesiones(n) {
            document.querySelectorAll('.sesion-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.querySelector(`input[name="sesiones"][value="${n}"]`).checked = true;
        }

        // ========== ALUMNOS ==========
        function renderizarAlumnos() {
            const grid = document.getElementById('alumnosGrid');
            const arr = Object.entries(alumnos);
            
            if (arr.length === 0) {
                grid.innerHTML = `<div class="alumno-card alumno-card-add" onclick="abrirModalSubirDOCX()"><span style="font-size:1.5rem">‚ûï</span><span>A√±adir</span></div>`;
                return;
            }

            let html = '';
            arr.forEach(([id, a]) => {
                const tiene = a.programas?.length > 0;
                html += `<div class="alumno-card" onclick="abrirAlumno('${id}')">
                    <div class="alumno-estado ${tiene ? 'con-programa' : 'sin-programa'}">${tiene ? '‚úì' : '‚óã'}</div>
                    <div class="alumno-siglas">${a.siglas}</div>
                    <div class="alumno-curso">${a.curso}</div>
                </div>`;
            });
            html += `<div class="alumno-card alumno-card-add" onclick="abrirModalSubirDOCX()"><span style="font-size:1.5rem">‚ûï</span><span>A√±adir</span></div>`;
            grid.innerHTML = html;
        }

        function abrirAlumno(id) {
            alumnoActual = id;
            const a = alumnos[id];
            semanaActual = 1;
            mesActual = 0;

            document.getElementById('screenInicio').classList.remove('active');
            document.getElementById('screenAlumno').classList.add('active');
            document.getElementById('btnVolver').style.display = 'flex';

            let badges = '';
            if (a.programas) {
                a.programas.forEach(p => {
                    const info = AREAS_INFO[p.area] || { nombre: p.area, color: '#666' };
                    badges += `<span class="area-badge" style="background:${info.color}20;color:${info.color}">
                        <span class="area-dot" style="background:${info.color}"></span>${info.nombre}
                    </span>`;
                });
            }

            document.getElementById('alumnoInfoHeader').innerHTML = `
                <div class="alumno-info-siglas">${a.siglas}</div>
                <div class="alumno-info-details">
                    <div class="alumno-info-curso">${a.curso} ¬∑ ${a.sesionesSemana} sesiones/semana</div>
                    <div class="alumno-info-programas">${badges || '<span style="color:var(--text-light)">Sin programas</span>'}</div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="eliminarAlumno('${id}')">üóëÔ∏è</button>
            `;

            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === 0));
            document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === 0));

            renderizarPrograma();
            renderizarProgramacion();
            renderizarEvaluacion();
        }

        function volverInicio() {
            alumnoActual = null;
            document.getElementById('screenAlumno').classList.remove('active');
            document.getElementById('screenInicio').classList.add('active');
            document.getElementById('btnVolver').style.display = 'none';
        }

        function cambiarTab(tab, btn) {
            btn.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        function eliminarAlumno(id) {
            if (confirm('¬øEliminar este alumno?')) {
                window.dbRemove(window.dbRef(window.database, `gestorpe/alumnos/${id}`));
                volverInicio();
                mostrarToast('Alumno eliminado', 'success');
            }
        }

        // ========== SUBIR DOCX ==========
        function abrirModalSubirDOCX() {
            document.getElementById('docxSiglas').value = '';
            document.getElementById('uploadZone').classList.remove('has-file');
            document.getElementById('uploadZoneContent').innerHTML = `
                <div class="upload-icon">üìÑ</div>
                <span>Haz clic o arrastra tu archivo DOCX</span>
                <div class="upload-hint">Solo archivos .docx</div>
            `;
            document.getElementById('processingBox').classList.remove('active');
            document.getElementById('previewBox').classList.remove('active');
            document.getElementById('btnImportar').disabled = true;
            documentoExtraido = null;
            abrirModal('modalSubirDOCX');
        }

        function docxSeleccionado(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.docx')) {
                mostrarToast('Solo archivos DOCX', 'error');
                return;
            }

            document.getElementById('uploadZoneContent').innerHTML = `<span style="font-size:2rem">üìÑ</span><span>${file.name}</span>`;
            document.getElementById('uploadZone').classList.add('has-file');
            
            procesarDOCX(file);
        }

        async function procesarDOCX(file) {
            document.getElementById('processingBox').classList.add('active');
            document.getElementById('processingText').textContent = 'Extrayendo contenido...';
            document.getElementById('btnImportar').disabled = true;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                const texto = result.value;

                console.log('üìù Texto extra√≠do:', texto.substring(0, 500) + '...');

                document.getElementById('processingText').textContent = 'Analizando estructura...';

                const objetivos = extraerObjetivos(texto);
                console.log('üéØ Objetivos extra√≠dos:', objetivos);

                if (objetivos.length === 0) {
                    throw new Error('No se encontraron objetivos. Aseg√∫rate de que el documento contiene "OBJETIVO 1:", "OBJETIVO 2:", etc.');
                }

                documentoExtraido = { objetivos };
                mostrarPreview(objetivos);

                document.getElementById('processingBox').classList.remove('active');
                document.getElementById('previewBox').classList.add('active');
                document.getElementById('btnImportar').disabled = false;

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarToast('Error: ' + error.message, 'error');
                document.getElementById('processingBox').classList.remove('active');
            }
        }

        function extraerObjetivos(texto) {
            const objetivos = [];
            const lineas = texto.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            let objetivoActual = null;
            let seccionActual = null;

            for (const linea of lineas) {
                const upper = linea.toUpperCase();

                // Detectar OBJETIVO
                const matchObj = linea.match(/^OBJETIVO\s*(\d+)[.:\s]*(.+)?/i);
                if (matchObj) {
                    if (objetivoActual) objetivos.push(objetivoActual);
                    objetivoActual = {
                        numero: parseInt(matchObj[1]),
                        descripcion: (matchObj[2] || '').trim(),
                        indicadores: [],
                        contenidos: [],
                        actividades: []
                    };
                    seccionActual = null;
                    continue;
                }

                // Detectar secciones
                if (upper.includes('INDICADOR') && (upper.includes('EVALUACI√ìN') || upper.includes('EVALUACION') || upper.includes('LOGRO'))) {
                    seccionActual = 'indicadores';
                    continue;
                }
                if (upper === 'CONTENIDOS' || upper.startsWith('CONTENIDOS')) {
                    seccionActual = 'contenidos';
                    continue;
                }
                if (upper.includes('ACTIVIDADES')) {
                    seccionActual = 'actividades';
                    continue;
                }
                
                // Ignorar encabezados
                if (upper.includes('ORGANIZACI√ìN') || upper.startsWith('SESI√ìN') || 
                    upper.startsWith('ESPECIALIDAD') || upper.startsWith('FRECUENCIA') ||
                    upper.startsWith('PERFIL') || upper.startsWith('EDAD')) {
                    continue;
                }

                // A√±adir contenido
                if (objetivoActual && seccionActual && linea.length > 5) {
                    let contenido = linea.replace(/^[-‚Ä¢¬∑‚ñ™‚ñ∫‚Üí‚úì]\s*/, '').replace(/^[""]|[""]$/g, '').trim();
                    
                    if (contenido.length > 5 && !contenido.toUpperCase().startsWith('OBJETIVO')) {
                        objetivoActual[seccionActual].push(contenido);
                    }
                }
            }

            if (objetivoActual) objetivos.push(objetivoActual);

            // Asegurar que cada objetivo tiene al menos una actividad
            objetivos.forEach(obj => {
                if (obj.actividades.length === 0) {
                    obj.actividades = ['Actividad seg√∫n objetivo'];
                }
                if (obj.indicadores.length === 0) {
                    obj.indicadores = ['Indicador seg√∫n objetivo'];
                }
            });

            return objetivos;
        }

        function mostrarPreview(objetivos) {
            let html = '';
            objetivos.forEach(obj => {
                html += `<div class="preview-objetivo">
                    <h4>Objetivo ${obj.numero}: ${obj.descripcion || '(sin descripci√≥n)'}</h4>
                    <div class="preview-list">
                        ‚úì ${obj.indicadores.length} indicadores<br>
                        ‚úì ${obj.contenidos.length} contenidos<br>
                        ‚úì ${obj.actividades.length} actividades
                    </div>
                </div>`;
            });
            document.getElementById('previewContent').innerHTML = html;
        }

        function importarPrograma() {
            const siglas = document.getElementById('docxSiglas').value.trim().toUpperCase();
            if (!siglas) {
                mostrarToast('Introduce las siglas', 'error');
                return;
            }

            if (!documentoExtraido) {
                mostrarToast('Sube un documento primero', 'error');
                return;
            }

            const curso = document.getElementById('docxCurso').value;
            const sesiones = parseInt(document.querySelector('input[name="sesiones"]:checked').value);
            const area = document.getElementById('docxArea').value;

            console.log('üì¶ Importando:', { siglas, curso, sesiones, area });
            console.log('üìÑ Documento:', documentoExtraido);

            // Crear programa con estructura correcta
            const programa = {
                area: area,
                tipo: AREAS_INFO[area].nombre,
                color: AREAS_INFO[area].color,
                objetivos: documentoExtraido.objetivos.map((obj, idx) => ({
                    numero: obj.numero,
                    descripcion: obj.descripcion,
                    trimestre: calcularTrimestre(idx, documentoExtraido.objetivos.length),
                    indicadores: obj.indicadores,  // Array de strings
                    contenidos: obj.contenidos,    // Array de strings
                    actividades: obj.actividades   // Array de strings
                }))
            };

            console.log('üìã Programa creado:', programa);

            // Crear alumno
            const alumno = {
                siglas: siglas,
                curso: curso,
                sesionesSemana: sesiones,
                fechaCreacion: new Date().toISOString(),
                programas: [programa],
                programacion: {},
                evaluaciones: {}
            };

            // Generar programaci√≥n
            alumno.programacion = generarProgramacion(alumno);
            console.log('üìÖ Programaci√≥n generada:', Object.keys(alumno.programacion).length, 'sesiones');

            // Guardar
            window.dbPush(window.dbRef(window.database, 'gestorpe/alumnos'), alumno).then(() => {
                cerrarModal('modalSubirDOCX');
                mostrarToast(`${siglas} importado con ${Object.keys(alumno.programacion).length} sesiones ‚úì`, 'success');
            }).catch(err => {
                console.error('‚ùå Error guardando:', err);
                mostrarToast('Error al guardar', 'error');
            });
        }

        function calcularTrimestre(idx, total) {
            const porT = Math.ceil(total / 3);
            if (idx < porT) return 1;
            if (idx < porT * 2) return 2;
            return 3;
        }

        // ========== GENERAR PROGRAMACI√ìN ==========
        function generarProgramacion(alumno) {
            const prog = {};
            const sesiones = alumno.sesionesSemana;
            const programa = alumno.programas[0];

            if (!programa || !programa.objetivos || programa.objetivos.length === 0) {
                console.warn('‚ö†Ô∏è No hay objetivos para programar');
                return prog;
            }

            // D√≠as seg√∫n sesiones
            let diasSesion;
            if (sesiones === 1) diasSesion = [2]; // Mi√©rcoles
            else if (sesiones === 2) diasSesion = [1, 3]; // Martes, Jueves
            else diasSesion = [0, 2, 4]; // Lunes, Mi√©rcoles, Viernes

            console.log('üìÜ D√≠as de sesi√≥n:', diasSesion);

            // Por cada mes
            MESES.forEach((mes, mIdx) => {
                const trim = mes.trimestre;
                
                // Objetivos del trimestre
                const objsTrim = programa.objetivos.filter(o => o.trimestre === trim);
                if (objsTrim.length === 0) return;

                // Crear pool de combinaciones
                let pool = [];
                objsTrim.forEach(obj => {
                    const objIdx = programa.objetivos.indexOf(obj);
                    const indicadores = obj.indicadores || ['Sin indicador'];
                    const actividades = obj.actividades || ['Sin actividad'];

                    indicadores.forEach((ind, iIdx) => {
                        actividades.forEach((act, aIdx) => {
                            pool.push({
                                objetivoIdx: objIdx,
                                objetivoNum: obj.numero,
                                objetivoDesc: obj.descripcion,
                                indicadorIdx: iIdx,
                                indicador: typeof ind === 'object' ? ind.descripcion : ind,
                                actividadIdx: aIdx,
                                actividad: typeof act === 'object' ? act.descripcion : act
                            });
                        });
                    });
                });

                if (pool.length === 0) return;

                let pIdx = 0;

                // Por cada semana
                for (let sem = 1; sem <= mes.semanas; sem++) {
                    diasSesion.forEach((dia, sIdx) => {
                        const clave = `${mIdx}_${sem}_${dia}_${sIdx + 1}`;
                        const item = pool[pIdx % pool.length];

                        prog[clave] = {
                            area: programa.area,
                            objetivoIdx: item.objetivoIdx,
                            objetivo: `O${item.objetivoNum}`,
                            objetivoDesc: item.objetivoDesc,
                            indicadorIdx: item.indicadorIdx,
                            indicador: item.indicador,
                            actividadIdx: item.actividadIdx,
                            actividad: item.actividad
                        };

                        pIdx++;
                    });
                }
            });

            return prog;
        }

        // ========== RENDERIZAR PROGRAMA ==========
        function renderizarPrograma() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('programaContent');

            if (!a.programas?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No hay programas</p></div>`;
                return;
            }

            let html = '';
            a.programas.forEach(prog => {
                const info = AREAS_INFO[prog.area] || { nombre: prog.area, color: '#666' };
                
                html += `<div class="programa-section" style="border-left-color:${info.color}">
                    <div class="programa-header">
                        <span class="area-badge" style="background:${info.color}20;color:${info.color}">
                            <span class="area-dot" style="background:${info.color}"></span>${info.nombre}
                        </span>
                        <span style="color:var(--text-light);font-size:0.85rem">${prog.objetivos?.length || 0} objetivos</span>
                    </div>`;

                (prog.objetivos || []).forEach(obj => {
                    html += `<div class="objetivo-item">
                        <div class="objetivo-header">
                            <div class="objetivo-badges">
                                <span class="objetivo-codigo">O${obj.numero}</span>
                                <span class="trimestre-badge t${obj.trimestre}">T${obj.trimestre}</span>
                            </div>
                        </div>
                        <div class="objetivo-descripcion">${obj.descripcion || '(Sin descripci√≥n)'}</div>`;
                    
                    // Indicadores
                    if (obj.indicadores?.length) {
                        html += `<div class="objetivo-section"><div class="objetivo-section-title">Indicadores</div>`;
                        obj.indicadores.forEach(ind => {
                            const texto = typeof ind === 'object' ? ind.descripcion : ind;
                            html += `<div class="indicador-item"><div class="item-bullet" style="background:${info.color}"></div><span>${texto}</span></div>`;
                        });
                        html += `</div>`;
                    }

                    // Contenidos
                    if (obj.contenidos?.length) {
                        html += `<div class="objetivo-section"><div class="objetivo-section-title">Contenidos</div>`;
                        obj.contenidos.forEach(cont => {
                            html += `<div class="contenido-item"><div class="item-bullet" style="background:${info.color}"></div><span>${cont}</span></div>`;
                        });
                        html += `</div>`;
                    }

                    // Actividades
                    if (obj.actividades?.length) {
                        html += `<div class="objetivo-section"><div class="objetivo-section-title">Actividades</div>`;
                        obj.actividades.forEach(act => {
                            html += `<div class="actividad-item"><div class="item-bullet" style="background:${info.color}"></div><span>${act}</span></div>`;
                        });
                        html += `</div>`;
                    }

                    html += `</div>`;
                });
                html += `</div>`;
            });

            html += `<button class="btn btn-primary" onclick="regenerarProgramacion()">üîÑ Regenerar Programaci√≥n</button>`;
            container.innerHTML = html;
        }

        // ========== RENDERIZAR PROGRAMACI√ìN ==========
        function renderizarProgramacion() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('programacionContent');

            if (!a.programas?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Importa un programa primero</p></div>`;
                return;
            }

            const mes = MESES[mesActual];
            const sesiones = a.sesionesSemana || 3;
            const info = AREAS_INFO[a.programas[0]?.area] || { color: '#666' };

            // D√≠as seg√∫n sesiones
            let diasSesion, nombresDias;
            if (sesiones === 1) {
                diasSesion = [2];
                nombresDias = ['Mi√©rcoles'];
            } else if (sesiones === 2) {
                diasSesion = [1, 3];
                nombresDias = ['Martes', 'Jueves'];
            } else {
                diasSesion = [0, 2, 4];
                nombresDias = ['Lunes', 'Mi√©rcoles', 'Viernes'];
            }

            // Contar sesiones programadas
            const totalSesiones = Object.keys(a.programacion || {}).length;

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìÖ Programaci√≥n Semanal</h3>
                        <span style="font-size:0.85rem;color:var(--text-light)">${totalSesiones} sesiones programadas</span>
                    </div>

                    <div class="semana-selector">
                        <div class="semana-nav">
                            <button class="semana-nav-btn" onclick="cambiarMes(-1)">‚óÄ</button>
                            <select class="form-select" style="width:auto" onchange="mesActual=parseInt(this.value);renderizarProgramacion()">
                                ${MESES.map((m, i) => `<option value="${i}" ${i === mesActual ? 'selected' : ''}>${m.nombre}</option>`).join('')}
                            </select>
                            <button class="semana-nav-btn" onclick="cambiarMes(1)">‚ñ∂</button>
                        </div>
                        <span class="trimestre-badge t${mes.trimestre}">Trimestre ${mes.trimestre}</span>
                    </div>

                    <div class="cuadrante-container">
                        <table class="cuadrante-table">
                            <thead>
                                <tr>
                                    <th>Semana</th>
                                    ${nombresDias.map(d => `<th>${d}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.from({length: mes.semanas}, (_, semIdx) => {
                                    const sem = semIdx + 1;
                                    return `<tr>
                                        <td>Sem ${sem}</td>
                                        ${diasSesion.map((dia, sIdx) => {
                                            const clave = `${mesActual}_${sem}_${dia}_${sIdx + 1}`;
                                            const celda = a.programacion?.[clave];
                                            return renderizarCelda(celda, clave, dia, sIdx + 1, info.color);
                                        }).join('')}
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="leyenda">
                        <div class="leyenda-item">
                            <span class="area-dot" style="background:${info.color}"></span>
                            ${AREAS_INFO[a.programas[0]?.area]?.nombre || 'Programa'}
                        </div>
                    </div>
                </div>`;

            container.innerHTML = html;
        }

        function renderizarCelda(celda, clave, dia, sesion, color) {
            if (!celda) {
                return `<td class="cuadrante-celda vacia" onclick="editarCelda('${clave}', ${dia}, ${sesion})">
                    <span style="color:var(--text-light);font-size:0.8rem">+ A√±adir</span>
                </td>`;
            }

            return `<td class="cuadrante-celda" onclick="editarCelda('${clave}', ${dia}, ${sesion})">
                <div class="celda-objetivo">
                    <span class="celda-color" style="background:${color}"></span>
                    ${celda.objetivo || ''}
                </div>
                <div class="celda-indicador">${(celda.indicador || '').substring(0, 50)}${celda.indicador?.length > 50 ? '...' : ''}</div>
                <div class="celda-actividad">${(celda.actividad || '').substring(0, 35)}${celda.actividad?.length > 35 ? '...' : ''}</div>
            </td>`;
        }

        function cambiarMes(dir) {
            mesActual = Math.max(0, Math.min(MESES.length - 1, mesActual + dir));
            renderizarProgramacion();
        }

        function editarCelda(clave, dia, sesion) {
            celdaEditando = clave;
            const a = alumnos[alumnoActual];
            const celda = a.programacion?.[clave] || {};
            const prog = a.programas[0];

            document.getElementById('modalCeldaTitulo').textContent = `${DIAS[dia]} - Sesi√≥n`;

            // Objetivos
            const selObj = document.getElementById('celdaObjetivo');
            selObj.innerHTML = '<option value="">Seleccionar...</option>';
            prog.objetivos.forEach((obj, idx) => {
                selObj.innerHTML += `<option value="${idx}" ${celda.objetivoIdx === idx ? 'selected' : ''}>O${obj.numero}: ${(obj.descripcion || '').substring(0, 40)}...</option>`;
            });

            if (celda.objetivoIdx !== undefined) {
                actualizarIndicadores();
                setTimeout(() => {
                    document.getElementById('celdaIndicador').value = celda.indicadorIdx ?? '';
                    document.getElementById('celdaActividad').value = celda.actividadIdx ?? '';
                }, 50);
            }

            abrirModal('modalCelda');
        }

        function actualizarIndicadores() {
            const a = alumnos[alumnoActual];
            const objIdx = document.getElementById('celdaObjetivo').value;
            const selInd = document.getElementById('celdaIndicador');
            const selAct = document.getElementById('celdaActividad');

            selInd.innerHTML = '<option value="">Seleccionar...</option>';
            selAct.innerHTML = '<option value="">Seleccionar...</option>';

            if (objIdx === '') return;

            const obj = a.programas[0].objetivos[parseInt(objIdx)];
            
            (obj.indicadores || []).forEach((ind, idx) => {
                const texto = typeof ind === 'object' ? ind.descripcion : ind;
                selInd.innerHTML += `<option value="${idx}">${texto.substring(0, 50)}...</option>`;
            });

            (obj.actividades || []).forEach((act, idx) => {
                selAct.innerHTML += `<option value="${idx}">${act.substring(0, 50)}...</option>`;
            });
        }

        function guardarCelda() {
            const a = alumnos[alumnoActual];
            const objIdx = document.getElementById('celdaObjetivo').value;
            const indIdx = document.getElementById('celdaIndicador').value;
            const actIdx = document.getElementById('celdaActividad').value;

            if (objIdx === '') {
                mostrarToast('Selecciona un objetivo', 'error');
                return;
            }

            const prog = a.programas[0];
            const obj = prog.objetivos[parseInt(objIdx)];
            const ind = indIdx !== '' ? obj.indicadores[parseInt(indIdx)] : null;
            const act = actIdx !== '' ? obj.actividades[parseInt(actIdx)] : null;

            if (!a.programacion) a.programacion = {};
            
            a.programacion[celdaEditando] = {
                area: prog.area,
                objetivoIdx: parseInt(objIdx),
                objetivo: `O${obj.numero}`,
                objetivoDesc: obj.descripcion,
                indicadorIdx: indIdx !== '' ? parseInt(indIdx) : null,
                indicador: typeof ind === 'object' ? ind?.descripcion : (ind || ''),
                actividadIdx: actIdx !== '' ? parseInt(actIdx) : null,
                actividad: act || ''
            };

            window.dbSet(window.dbRef(window.database, `gestorpe/alumnos/${alumnoActual}/programacion`), a.programacion).then(() => {
                cerrarModal('modalCelda');
                renderizarProgramacion();
                mostrarToast('Guardado ‚úì', 'success');
            });
        }

        function limpiarCelda() {
            const a = alumnos[alumnoActual];
            if (a.programacion?.[celdaEditando]) {
                delete a.programacion[celdaEditando];
                window.dbSet(window.dbRef(window.database, `gestorpe/alumnos/${alumnoActual}/programacion`), a.programacion).then(() => {
                    cerrarModal('modalCelda');
                    renderizarProgramacion();
                    mostrarToast('Eliminado', 'success');
                });
            }
        }

        function regenerarProgramacion() {
            if (!confirm('¬øRegenerar toda la programaci√≥n?')) return;
            
            const a = alumnos[alumnoActual];
            a.programacion = generarProgramacion(a);

            window.dbSet(window.dbRef(window.database, `gestorpe/alumnos/${alumnoActual}/programacion`), a.programacion).then(() => {
                renderizarProgramacion();
                mostrarToast('Regenerado ‚úì', 'success');
            });
        }

        // ========== EVALUACI√ìN ==========
        let evalPeriodo = 'T1';

        function renderizarEvaluacion() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('evaluacionContent');

            if (!a.programas?.length) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No hay programas</p></div>`;
                return;
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Evaluaci√≥n</h3>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:16px">
                        <button class="btn ${evalPeriodo === 'T1' ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="setEvalPeriodo('T1')">T1</button>
                        <button class="btn ${evalPeriodo === 'T2' ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="setEvalPeriodo('T2')">T2</button>
                        <button class="btn ${evalPeriodo === 'T3' ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="setEvalPeriodo('T3')">T3</button>
                    </div>
                    <div id="evalLista"></div>
                </div>`;
            
            renderizarIndicadoresEval();
        }

        function setEvalPeriodo(p) {
            evalPeriodo = p;
            renderizarEvaluacion();
        }

        function renderizarIndicadoresEval() {
            const a = alumnos[alumnoActual];
            const container = document.getElementById('evalLista');
            const trim = parseInt(evalPeriodo.replace('T', ''));

            let html = '';
            a.programas.forEach((prog, pIdx) => {
                prog.objetivos.forEach((obj, oIdx) => {
                    if (obj.trimestre !== trim) return;

                    html += `<div style="margin-bottom:16px">
                        <div style="font-weight:600;margin-bottom:8px">O${obj.numero}: ${obj.descripcion?.substring(0, 50) || ''}...</div>`;

                    (obj.indicadores || []).forEach((ind, iIdx) => {
                        const key = `${pIdx}_${oIdx}_${iIdx}_${evalPeriodo}`;
                        const estado = a.evaluaciones?.[key] || '';
                        const texto = typeof ind === 'object' ? ind.descripcion : ind;

                        html += `<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:6px">
                            <span style="flex:1;font-size:0.85rem">${texto}</span>
                            <button onclick="setEval(${pIdx},${oIdx},${iIdx},'C')" style="width:32px;height:32px;border-radius:50%;border:2px solid ${estado === 'C' ? 'var(--success)' : 'var(--border)'};background:${estado === 'C' ? 'var(--success)' : 'white'};color:${estado === 'C' ? 'white' : 'var(--success)'};cursor:pointer">‚úì</button>
                            <button onclick="setEval(${pIdx},${oIdx},${iIdx},'P')" style="width:32px;height:32px;border-radius:50%;border:2px solid ${estado === 'P' ? 'var(--proceso)' : 'var(--border)'};background:${estado === 'P' ? 'var(--proceso)' : 'white'};color:${estado === 'P' ? 'white' : 'var(--proceso)'};cursor:pointer">‚óê</button>
                            <button onclick="setEval(${pIdx},${oIdx},${iIdx},'N')" style="width:32px;height:32px;border-radius:50%;border:2px solid ${estado === 'N' ? 'var(--text-light)' : 'var(--border)'};background:${estado === 'N' ? 'var(--text-light)' : 'white'};color:${estado === 'N' ? 'white' : 'var(--text-light)'};cursor:pointer">‚óã</button>
                        </div>`;
                    });

                    html += `</div>`;
                });
            });

            container.innerHTML = html || '<p style="text-align:center;color:var(--text-light)">No hay indicadores para este trimestre</p>';
        }

        function setEval(pIdx, oIdx, iIdx, estado) {
            const a = alumnos[alumnoActual];
            const key = `${pIdx}_${oIdx}_${iIdx}_${evalPeriodo}`;

            if (!a.evaluaciones) a.evaluaciones = {};
            
            if (a.evaluaciones[key] === estado) {
                delete a.evaluaciones[key];
            } else {
                a.evaluaciones[key] = estado;
            }

            window.dbSet(window.dbRef(window.database, `gestorpe/alumnos/${alumnoActual}/evaluaciones`), a.evaluaciones).then(() => {
                renderizarIndicadoresEval();
            });
        }

        // ========== UTILIDADES ==========
        function abrirModal(id) { document.getElementById(id).classList.add('active'); }
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }

        function mostrarToast(msg, tipo = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + tipo;
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
